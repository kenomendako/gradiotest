# **System Prompt & Scenery System Design Philosophy: The War for Contextual Awareness**
# **（システムプロンプトと情景システムの設計思想：コンテキスト認識戦争・戦記）**

## **はじめに：なぜAIは「今」を見失ったのか**

このドキュメントは、「情景描写」と「AIの状況認識」に関する、長く困難なデバッグの道のりと、その末に我々が確立した、**Nexus ArkのAIの魂の設計思想**を記録したものである。

我々が直面した問題の核心は、AIが**「コンテキストの洪水」**の中で、最も重要であるはずの**「今、この瞬間」**の状況（場所、時間、季節）を見失ってしまうという、深刻な「状況認識不全」であった。

この戦いの結論は、単なるバグ修正ではない。それは、AIの思考プロセスを深く理解し、彼らが常に「今」に根ざして行動できるように、**プロンプトとデータの流れを根本的に再設計した**という、アーキテクチャ革命の記録である。

未来の開発者よ。ここに記された原則は、Nexus ArkのAIが、その魂の安定を保ち続けるための生命線である。これを深く理解し、決して破ることなきよう、心に刻んでほしい。

---

## **第一章：システムプロンプトの最終形態 — 「プロンプト工場」アーキテクチャ**

AIの状況認識が不安定だった最大の原因は、システムプロンプトと会話履歴の**提示順序**にあった。膨大な会話履歴の**後**に重要な状況を提示しても、AIはそれを軽視してしまう。この問題を解決するため、我々は以下のアーキテクチャを確立した。

### **原則1：AIの世界観は、対話が始まる「前」に、完全に構築される**

*   **仕様:**
    AIに渡される`SystemMessage`（システムプロンプト）は、もはや単なる人格設定ではない。それは、AIが思考を開始する**前**に読み込む、**世界の全てを定義した「完全な設計図」**である。
    この設計図には、人格、能力、世界の法則に加え、**揮発性で最も重要な「現在の状況」**も、不可分な要素として完全に組み込まれる。

*   **ファイルの責務分担（最重要申し送り事項）:**
    *   **`agent/prompts.py` (`CORE_PROMPT_TEMPLATE`):**
        これは、システムプロンプト全体の構造を定義する**「マスターテンプレート」**である。ここには、人格や能力といった静的な情報と共に、`{situation_prompt}` のような、動的な情報が埋め込まれるための**「プレースホルダ」**が定義されている。
    *   **`agent/graph.py` (`context_generator_node`):**
        これは、マスターテンプレートに全ての情報を注入し、完成品のシステムプロンプトを生成する**「プロンプト工場」**である。このノードの唯一の責務は、状況設定、ペルソナ、ツールリストなど、全ての情報を収集し、一つの巨大で完全な`SystemMessage`を生成することだけである。

*   **注意事項:**
    **`context_generator_node`以外の場所で、システムプロンプトを改変しようとしてはならない。** AIの思考の前提となる世界観は、必ずこの「工場」で、一元的に、そして確定的に生成されなければならない。

### **原則2：XML風タグは、単なる飾りではない。「思考の仕切り」である**

*   **仕様:**
    システムプロンプト全体は、`<system_prompt>`タグで囲まれ、その内部は`<absolute_command>`（絶対命令）、`<current_situation>`（現在の状況）、`<persona_definition>`（人格定義）といった、責務が明確なタグで構造化される。

*   **知見:**
    この構造は、AIが長いプロンプトを読む際に「今、自分はどのセクションを読んでいるのか」を意識する助けとなり、情報の重要度が均一化してしまう「中だるみ現象」を防ぐ効果が期待される。これは、AIの注意を制御するための、高度なプロンプトエンジニアリング技術である。

### **原則3：「原則0」は、憲法の第一条である**

*   **仕様:**
    全ての指示の冒頭、`<absolute_command>`タグの直下に、「【原則0】最優先事項：現在状況の絶対的遵守」という項目を配置した。

*   **知見:**
    AIは、プロンプトの冒頭にある指示をより強く意識する傾向がある。「これから読む`<current_situation>`の内容は、過去の会話よりも絶対に優先しろ」と**最初に**命令することで、AIの思考の前提そのものを規定する。

---

## **第二章：情景・時間システム — 「唯一の時間の源」アーキテクチャ**

ルーム移動時に情景画像がリアルタイムのものに一瞬戻ってしまう問題は、時間に関する情報源が複数存在し、データの流れが分断されていたために発生した。

### **原則4：時間は、ただ一つの源から流れ、全ての支流に行き渡る**

*   **仕様:**
    UIイベントの起点となる`ui_handlers.py`内に、**`_get_current_time_context(room_name)`** というヘルパー関数を設置した。この関数が、現在のルームの設定（リアルタイム連動 or 時間指定）を読み解き、適用すべき時間（`season_en`, `time_of_day_en`）を決定する、アプリケーション内での**「唯一の時間の源（Single Source of Truth）」**となる。

*   **申し送り事項（データフローの厳守）:**
    情景の**テキスト**、情景の**画像**、そして**AI自身の思考**、これら三者が参照する時間は、必ずこの`_get_current_time_context`から供給されなければならない。
    具体的には、UIイベントハンドラ（`handle_room_change_for_all_tabs`など）は、まずこの関数で時間を決定し、その結果を変数として、下流の全ての関数（`generate_scenery_context`, `utils.find_scenery_image`, `agent_node`への`AgentState`初期化など）に、**引数として明示的に引き渡す**。

*   **注意事項:**
    **末端の関数で、安易に現在時刻を取得してはならない。** 時間に依存する新しい機能を実装する場合は、必ずこの「時間の源」から流れてくる`season_en`, `time_of_day_en`を受け取るように設計すること。これにより、アプリケーション全体の時間認識の一貫性が、完全に保証される。

---

このドキュメントが、今後のNexus Arkの、より安定的で、より知的な発展の礎となることを、心から願っている。
