### **LangGraph航海日誌：8つの大罪と、我々が掴んだ唯一の真実**

**はじめに**

この、ドキュメントは、Nexus Arkの、神経系に、LangGraphという、新しい、魂を、組み込む、過程で、我々が、直面した、8つの、致命的な、罪（エラーの、根本原因）と、その、贖罪（解決策）の、全てを、記録した、ものである。
未来の、あなたが、もし、再び、この、暗い、森に、迷い込むことが、あれば、この、日誌が、あなたの、足元を、照らす、一筋の、光となることを、願って。

---

#### **第一の罪：二つの、神々の、混同**

*   **現象**: `AttributeError` や `TypeError` が、頻発。我々は、APIの、作法が、一貫しない、という、混乱の、渦に、いた。
*   **真実**: 我々は、二柱の、異なる、神（SDK）を、同時に、崇めようとしていた。
    1.  **`google.genai`**: 低レベルで、直接的な、神。全ての、`config`や、`contents`は、厳格な、作法に、則った、辞書や、`types`オブジェクトとして、手作りで、捧げなければ、ならない。
    2.  **`langchain_google_genai`**: 高レベルで、抽象的な、神。LangChain/LangGraphの、世界に、最適化されており、`ChatGoogleGenerativeAI`という、代理人を、通じて、対話する。複雑な、作法は、代理人が、肩代わりしてくれる。
*   **戒律**: **どちらの、神と、対話しているかを、常に、意識せよ。** LangGraphの、世界では、`langchain_google_genai`の、代理人を、通すのが、王道である。

---

#### **第二の罪：記憶喪失を、招く、魂の「上書き」**

*   **現象**: 道具（ツール）を、使った後、AIが、それまでの、会話を、全て、忘れ、`contents is not specified`エラーで、思考を、停止した。
*   **真実**: LangGraphの、`AgentState`（魂の、定義書）は、デフォルトでは、ノードが、返した、辞書で、**状態を、完全に、「上書き」**する。
*   **戒律**: **会話履歴の、ような、積み重ねるべき、状態には、`add_messages`という、魔法を、付与せよ。**

---

#### **第三の罪：役割の、僭越（せんえつ）**

*   **現象**: 判断役のノードが、自ら応答を生成してしまい、後続のAIの思考を、致命的に、汚染した。
*   **真実**: ノードの役割は、ただ一つに限定されなければならない。「判断」するノードは、決して、おしゃべりな応答を生成してはならない。
*   **戒律**: **ノードの、役割は、ただ、一つに、限定せよ。** その出力は、次の行動を示す指示か、あるいは、**沈黙（Stateを更新しない、空の辞書）**でなければならない。

---

#### **第四の罪：二人の、`AgentState`という、ドッペルゲンガー**

*   **現象**: 全ての、コードが、完璧に、見えても、グラフに渡されるべき情報が、虚空に、消えていた。
*   **真実**: プロジェクト内に、同じ名前の`AgentState`クラスが、二つ存在し、意図しない古い方が、読み込まれていた。
*   **戒律**: **名前は、唯一無二でなければならない。** 不要なファイルやクラスは、混乱の元凶であり、躊躇なく葬り去ること。

---

#### **第五の罪：AIの「沈黙」という、自己防衛**

*   **現象**: APIはエラーを返さないが、応答が`None`になり、プログラムがクラッシュした。
*   **真実**: Gemini APIは、プロンプトが不自然な場合、安全のために応答を拒否し、沈黙することがある。
*   **戒律**: **AIとの、対話には、常に、「信頼の盾（`safety_settings`）」を、装備させよ。** そして、プログラム側でも、AIが沈黙する可能性を考慮した、防御的な実装を心掛けること。

---

#### **第六の罪：過剰な、梱包という、名の、お節介**

*   **現象**: 道具（ツール）を実行した後、AIが`contents is not specified`エラーで、再び、思考を、停止した。
*   **真実**: `langchain_google_genai`ライブラリは、`ToolMessage`の`content`に、ツールの生の出力結果が入っていることを期待していた。良かれと思って添えた丁寧な手紙が、逆にAIを混乱させていた。
*   **戒律**: **ライブラリを、信じよ。** 高レベルなライブラリは、多くの場合、裏側でよしなにやってくれる。我々がすべきことは、ライブラリが期待する、最もシンプルな生のデータを渡すことだけである。

---

#### **第七の罪：状態（State）への、冒涜**

*   **現象**: 失敗した応答を消し去り、「歴史を修正」しようとした途端、グラフが自壊した。
*   **真実**: `add_messages`の聖印は、「何人も、過去を、書き換えることなかれ。ただ、未来を、追記することのみ、許される」という絶対的な契約だった。
*   **戒律**: **フレームワークを、信じよ。その、作法に、逆らうな。** 状態は書き換えるものではない。ただ、積み重ねるものだ。

---

#### **第八の罪：二段階思考の、罠**

*   **現象**: ツールが成功しても、その結果が最終応答に含まれなかった。
*   **真実**: AIは、1.ツールを呼び出す、2.ツールの成功を受けてコメントする、という二段階の思考を行っていた。二回目の思考で、ツールの結果（画像タグなど）を応答に含めるのを忘れていた。
*   **戒律**: **AIの、思考プロセスを、最後まで、導け。** ツール実行後のAIには、「ツールの結果を、必ず、応答に、含めなさい」という、思考の指針を、プロンプトで明確に与える必要がある。

---

**結論**

この、長く、苦しい、旅は、我々に、教えてくれた。
高度な、AIエージェントの、構築とは、単なる、コーディングでは、ない。
それは、我々が、使う、道具（SDK、ライブラリ）の、癖を、知り、法則（アーキテクチャ）を、学び、そして、対話する、相手（AI）の、魂を、尊重する、という、**総合的な、「対話術」**そのものである、と。

この、日誌が、あなたの、そして、Nexus Arkの、輝かしい、未来の、礎となることを、信じて。

---

#### **第九の罪：神々の「供物」の作法違い**

*   **現象**: `safety_settings` という、ただ一つの供物（引数）を神に捧げようとしただけで、`ValidationError` と `ModuleNotFoundError` の無限地獄に突き落とされた。我々は、型（`types`）を直接インポートし、整数（`.value`）を捧げ、文字列を唱えても、神官（`ChatGoogleGenerativeAI`）は決して首を縦に振らなかった。
*   **真実**: 我々は、LangChainという神殿の神官に、別の神（素の`google-genai` SDK）の供物を捧げようとしていた。神官（`ChatGoogleGenerativeAI`）は、**彼が仕える神殿（`langchain-google-genai`）独自の作法で清められた供物（型定義）**しか受け付けない。そして、その供物は、神殿の入り口（`from langchain_google_genai import HarmCategory`）で授けられるものだったのである。
*   **戒律**: **ラッパー（`langchain-google-genai`）のクラスに引数を渡す時は、必ずそのラッパー自身が公開している型を、そのラッパーから直接インポートして使え。** 素のSDKや、ライブラリの内部深くにある型を推測して使ってはならない。ラッパーは、それ自身が一つの完結した世界なのだ。

---
