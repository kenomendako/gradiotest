# THE THOUGHT SIGNATURE WAR: Integrating Gemini's Thinking Process with Stateless Architecture
# （思考の署名との戦い：ステートレス・アーキテクチャとGeminiの思考プロセスの統合）

## プロローグ：見えざる「思考の証」

2025年11月、我々は最新鋭の「Gemini 3 (Thinking Model)」をNexus Arkに迎え入れようとした。
しかし、そこで待ち受けていたのは、`400 InvalidArgument: Function call is missing a thought_signature` という、無慈悲な拒絶であった。

Thinkingモデルは、ツールを使用する前段階として「思考（Thinking）」を出力する。そして、続くツール実行のリクエストには、その思考が正当なものであることを証明する暗号化されたデータ、**「思考の署名（Thought Signature）」**を添付することを厳格に要求した。

これは、Nexus Arkの根幹を成す「ログベース・アーキテクチャ」にとって、致命的な課題であった。
我々は、堅牢性を担保するために、ターンごとに**テキストファイル（`log.txt`）から会話履歴を完全に再構築**している。しかし、テキストファイルには、バイナリに近い「署名データ」は保存されない。
つまり、履歴を復元した瞬間、**AIの「思考の証」は消滅し、APIはそれを「記憶喪失による不正なリクエスト」とみなしていた**のである。

## 第一章：ライブラリの壁と、タプルの罠

我々はまず、ライブラリ（`langchain-google-genai`）を最新版（v3.1.0以上）に更新した。しかし、それだけでは動かなかった。
LangGraphのストリーミング仕様において、`stream_mode=["messages", "values"]` を指定した際の戻り値が、辞書ではなく **`(mode, payload)` のタプル** に変化していたのだ。
これに気づかず、辞書としてアクセスしようとして `TypeError` の沼に足を取られた。

*   **教訓:** ライブラリのメジャーアップデート時は、戻り値の型が根本的に変わる可能性がある。思い込みを捨て、生データを確認せよ。

## 第二章：ハイブリッド・インジェクション（解決策）

「署名は揮発するが、ログは不変である」。この矛盾を解決するために、我々は**「メモリ」と「ログ」を融合させるハイブリッド・アーキテクチャ**を考案した。

1.  **捕獲（Capture）:**
    AIが思考し、応答を生成している最中（ストリーミング中）、`gemini_api.py` はその応答に含まれる `thought_signature` を密かに抜き出し、メモリ上のグローバルキャッシュ（`_thought_signature_cache`）に保存する。これは揮発性であるが、アプリケーションが起動している間は維持される。

2.  **注入（Injection）:**
    次の瞬間、ツール実行のために `log.txt` から履歴が再構築される。この時、テキストだけの履歴は「署名を持たない」状態にある。
    ここでシステムはキャッシュを確認する。「もし、これが最新のAI発言であり、かつキャッシュに署名が残っているなら、それを**こっそり履歴オブジェクトに注入（Inject）せよ**」。

この「後付けの手術」により、ログベースの堅牢性を維持したまま、APIに対しては「一貫した思考の流れ」を提示することに成功した。

## 結論：Thinkingモデル対応の3つの鉄則

今後、思考するAIモデル（Gemini 2.0 Flash Thinking, Gemini 3など）を扱う際は、以下の鉄則を厳守せよ。

1.  **ライブラリ鮮度の維持:**
    Thinkingモデルの仕様は頻繁に変更される。`langchain-google-genai` と `google-genai` は常に最新版を維持しなければならない。

2.  **署名のライフサイクル管理:**
    思考の署名は「現在のターン」においてのみ有効であり、必須である。ログファイルには保存できないため、**メモリ上での一時キャッシュと、再構築時の動的な注入機構**が不可欠である。これを削除してはならない。

3.  **モデル名の呪い:**
    ライブラリによっては、モデル名に "thinking" が含まれていないと、署名処理をスキップする場合がある。もし新しいThinkingモデルでエラーが出た場合は、強制的に署名を処理させるパッチが必要になるかもしれない。

この記録が、さらに深遠なる思考を手に入れたAIと共に歩む、未来の我々の道標となることを願って。