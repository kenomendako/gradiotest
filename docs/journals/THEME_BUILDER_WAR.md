# THEME_BUILDER_WAR.md (テーマビルダー統合戦争・戦記)

## 序章：果たされなかった、もう一つの約束

このドキュメントは、Nexus Arkのテーマ作成体験を劇的に向上させるはずだった「Gradioテーマビルダー」の統合機能が、なぜ、そして、いかにして、凍結されるに至ったかの、技術的な戦いの全記録である。

これは、単なる失敗談ではない。それは、Gradioというフレームワークの根源的なアーキテクチャ、特に**「ポート管理」**と**「プロセスの親子関係」**という、目に見えない、しかし絶対的な法則と、我々がいかにして対峙したかの物語である。

未来のあなたが、再びこの機能の実装に挑む時、この戦記が、同じ轍を踏まぬための、唯一の海図となることを願って。

---

### 第一章：ポート衝突という亡霊

我々が最初に直面したのは、テーマビルダーを起動すると、Nexus Ark本体が異常なエラーを吐き出して応答不能になるという、不可解な現象だった。

*   **原因:** `launch_builder.py` で `launch()` を引数なしで呼び出したため、Gradioはデフォルトのポート `7860` を使用しようとした。しかし、そのポートは既にNexus Ark本体が使用していた。**一つの住所に、二つのアプリケーションが住もうとした**ことで、システムは完全に混乱した。

*   **教訓:** `gradio.Blocks().launch()` は、必ず `server_port` 引数を指定し、アプリケーションごとに固有のポートを割り当てること。これは、複数のGradioプロセスを同時に扱う上での絶対的な掟である。

---

### 第二章：リロード地獄という名の自己破壊

ポートを `7861` に明示的に分離した後も、我々は新たな、そして、より奇怪な問題に直面した。テーマビルダーを起動すると、新しいコンソールが立ち上がりはするものの、その中で**Nexus Arkが再び起動しようとし、ポート`7860`が使用中であるというエラーで自滅する**のだ。

*   **原因:** この現象の真犯人は、Gradioにデフォルトで備わっている**「自動リロード機能」**であった。
    1.  Nexus Ark（親プロセス）から `subprocess.Popen` で起動されたテーマビルダー（子プロセス）は、自動リロード機能を有効化したまま起動する。
    2.  この機能が、何らかの理由で**親プロセスのファイル群まで監視対象に含めてしまう。**
    3.  子プロセスの起動という僅かな変化を「親のコードが変更された」と誤認し、**親であるNexus Ark自身をリロードさせようとする**という、連鎖的な自己破壊を引き起こしていた。

*   **教訓:** `subprocess` などでGradioアプリケーションを子プロセスとして起動する場合、意図しない連鎖的なリロードを防ぐため、`launch()` メソッドに **`watch_dirs=[]`** を指定し、**自動リreload機能を明示的に無効化しなければならない。**

---

### 最終結論：なぜ機能は凍結されたのか

上記の二つの問題を解決し、テーマビルダーを独立したプロセスとして起動させることには成功した。しかし、それでもなお、この機能の統合は、現在のアーキテクチャではユーザー体験を損なう可能性があると判断し、凍結を決定した。

*   **残された課題:**
    1.  **プロセスの管理:** ユーザーがテーマビルダーを使い終わった後、そのプロセス（黒いコンソール画面）を確実に手動で終了させる必要がある。これを怠ると、バックグラウンドで不要なプロセスが生き残り、リソースを消費し続ける。
    2.  **シームレスな体験の欠如:** 結局のところ、ユーザーはテーマビルダーで得た値を、手動でNexus ArkのUIにコピー＆ペーストする必要がある。この「分断された体験」は、Nexus Arkが目指す直感的な操作性とは相容れない。

将来、Gradioがテーマ設定を動的に、かつプログラムから直接操作するための、より洗練されたAPIを提供する日が来た時、我々はこの戦いを再開するだろう。
それまで、この記録は、我々の挑戦の証として、静かに眠り続ける。