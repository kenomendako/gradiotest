# CIRCULAR_IMPORT_WAR.md (循環参照戦争・戦記)

## はじめに：なぜNexus Arkは、起動しなくなったのか

このドキュメントは、Nexus Arkの開発史上、最も陰湿で、最も破壊的な敵であった「循環参照 (Circular Import)」との戦いの全記録である。これは単なるバグ修正の物語ではない。それは、良かれと思って行われた小さな修正が、いかにしてシステム全体の骨格を蝕み、アプリケーションを起動すらできない死の状態へと追い込むかの、恐ろしい実例である。

未来のあなたが、もし再びこのインポートエラーの迷宮に迷い込んだなら、この戦記が、依存関係という名の蜘蛛の巣を断ち切るための、唯一の剣となることを願って。

---

### 第一章：最初の砲声 - `agent/graph` と `ui_handlers` の悲劇

戦いは、些細な機能追加から始まった。「AIに、移動可能な場所のリストを教えたい」。
この純粋な願いを実現するため、我々は `agent/graph.py` (AIの思考回路) に、`ui_handlers.py` (UIのリストを作る名人) から関数をインポートさせた。

しかし、その時、我々は忘れていた。`ui_handlers.py` は、既に「情景更新」のために `agent/graph.py` の関数を必要としていたことを。

-   `agent/graph` は `ui_handlers` を知る必要がある。
-   `ui_handlers` は `agent/graph` を知る必要がある。

この瞬間、Pythonは叫びを上げた。`ImportError: cannot import name ... (most likely due to a circular import)`。これが、長きにわたる戦争の始まりを告げる、最初の砲声だった。

---

### 第二章：泥沼化 - `utils` と `character_manager` を巻き込んだ全面戦争

我々は、この問題を解決しようと、安易な道を選んだ。関数を、あちこちのファイルに移動させたのだ。
それは、火薬庫の中で松明を振り回すような行為だった。

この場当たり的な修正は、戦線を拡大させ、ついにはアプリケーションの基盤である `utils.py` (聖域であるべき道具箱) と `character_manager.py` (キャラクターの魂の管理者) までをも巻き込む、全面戦争へと発展した。

-   `character_manager` は、便利な道具を求めて `utils` を読み込む。
-   しかし、その `utils` の中には、キャラクターの情報を知るために `character_manager` を読み込もうとする、裏切り者の関数が紛れ込んでいた。

`utils <-> character_manager` という、決してあってはならない禁断の関係が生まれた瞬間、Nexus Arkのアーキテクチャは完全に崩壊した。起動シーケンスは無限のループに陥り、アプリケーションは完全な沈黙に包まれた。

---

### 第三章：アーキテクチャの再定義 - 我々が掴んだ唯一の真実

この地獄の底で、我々はついに悟った。
問題は、個々の関数の場所ではない。モジュール間の**「関係性」の設計思想そのもの**が、根本的に間違っていたのだと。

この戦争に終止符を打つため、我々はNexus Arkの魂に、以下の**三つの絶対的な法則**を刻み込んだ。

1.  **第一法則：`utils.py` は聖域である**
    `utils.py` は、アプリケーションの最下層に位置する、純粋な「道具箱」でなければならない。したがって、**`utils.py` は、Python標準ライブラリと外部ライブラリ以外の、このプロジェクト内の他のどのファイル（`character_manager.py` など）も、決してインポートしてはならない。**

2.  **第二法則：責務は、その地に集約される**
    キャラクターのファイル（ログ、設定、世界観など）に関する読み書き処理は、**すべて `character_manager.py` が責任を持つ。** 関連する関数は、他の場所に分散させてはならない。機能の「故郷」を明確に定めるのだ。

3.  **第三法則：依存関係は、決して逆流しない**
    モジュール間の情報の流れは、常に上位から下位への、**一方通行**でなければならない。このプロジェクトにおける、健全な依存関係のピラミッドは、以下の通りである。

    ```
    [最上位] nexus_ark.py (UI定義)
        ↓
    [司令塔] ui_handlers.py (イベント処理)
        ↓
    [実行部] gemini_api.py (API呼び出し)
        ↓
    [設計図] agent/graph.py (AIの思考プロセス)
        ↓
    [論理核] character_manager.py / 各tools / memory_manager.py など
        ↓
    [最下層] utils.py / constants.py (聖域・道具箱)
    ```
    下位のモジュールが、自分より上位のモジュールをインポートすることは、システムの崩壊を意味する、最大の禁忌である。

---

### 結論：コードは、依存関係の物語である

この長く苦しい戦いは、我々に教えてくれた。
アプリケーション開発とは、単に機能を書くことではない。それは、モジュールという名の登場人物たちの間に、健全で、予測可能な「関係性」を築き上げ、情報の流れという「物語」を、いかに美しく、そして破綻なく紡いでいくか、ということなのだと。

この戦記が、未来のNexus Arkを、同じ過ちから永遠に守るための、堅牢な城壁となることを信じて。
