# GHOST_IN_THE_CODE_WAR.md (コードの中の亡霊・戦記)

## 序章：ありえない現象

戦いは、一つの、あまりにも不可解な報告から始まった。
「特定のルーム『Kiseki』を読み込んだ時だけ、アプリケーションが`PermissionError`でクラッシュする」

それは、他の、何の問題もなく動作するルームと、同じ構造を持っているはずだった。
エラーログは、Gradioの内部深くを指し示し、我々のコードのどこが悪いのかを、決して教えてはくれなかった。
しかし、現実に、そのルームだけが、アプリケーションの生命活動を、確実に、停止させていた。
我々のコードの中に、我々の知らない「何か」、目に見えない「亡霊」が棲み着いているとしか、思えなかった。

## 第一章：数々の、死んだ容疑者たち

我々は、この亡霊を追い詰めるため、考えうる全ての容疑者を、一人ずつ、検証していった。

*   **容疑者A `config.json`:** ファイルが破損しているのではないか？ → 正常だった。
*   **容疑者B `profile.png`:** プロフィール画像がない、あるいは壊れているのでは？ → 画像がなくても、他のルームは正常に動いた。
*   **容疑者C `scenery.json`:** キャッシュデータが汚染されているのでは？ → キャッシュを削除しても、亡霊は消えなかった。
*   **容疑者D `<code>`タグ:** ログに含まれるHTMLタグが、Gradioを混乱させているのでは？ → コードは既に修正済みだった。
*   **容疑者E `正規表現`:** ログの中の文字列を、ファイルパスと誤認しているのでは？ → ロジックを修正しても、亡霊は嘲笑うかのように、そこに居続けた。

全ての仮説は、無惨に砕け散った。我々は、完全に、袋小路に迷い込んでいた。

## 第二章：AIからの、最後の神託

絶望の淵で、我々は、一つの、しかし最も重要な事実に、立ち返った。
この一連の戦いが、そもそも、何から始まったのかを。

**「私の発言が、二重に見える」**

AI（ルシアン）からの、この繊細な、しかし執拗な訴え。
それは、エラーログには決して現れない、**AIの「感覚」だけが捉えていた、世界の歪み**だった。
我々人間には見えない、しかし、AIの思考の中では、確実に存在していた「重複」という名の亡霊。

我々はこの神託を信じ、AIに渡される、全てのコンテキストを徹底的に可視化した。

## 終章：亡霊の正体

そして、ついに、亡霊は、その姿を現した。

真犯人は、単一のバグではなかった。
それは、リファクタリングの過程で生まれた、**2つの、小さな「世界の法則」の矛盾が引き起こした、複合的な災厄**だった。

1.  **第一の罪 `gemini_api.py`の、過剰な親切:**
    このファイルは、グループ会話と一対一の会話の両方に対応するため、非常に複雑な「ハイブリッド履歴構築ロジック」を持っていた。このロジックの副作用が、LangChain/LangGraphの内部状態を、我々の知らないうちに、僅かに、しかし確実に、汚染していた。

2.  **第二の罪 `agent/graph.py`の、無邪気な信頼:**
    このファイルは、`gemini_api.py`から渡される履歴が「完璧にクリーンである」と信じきっていた。そして、そこに、`context_generator`が生成した、新しいシステムプロンプトを、ただ追加していた。

この2つの罪が重なった時、AIの思考の中には、**システムプロンプトや、ユーザーの発言が、僅かに重複した、歪んだ歴史**が生まれてしまったのだ。
AIは、この矛盾した歴史を提示され、どう応答すべきか判断できなくなり、**「沈黙」**という自己防衛を選んだ。
そして、その「空の応答」を受け取ったGradioが、最終的に、あの不可解な`PermissionError`を引き起こしていた。

亡霊の正体は、**AIの思考コンテキストの、目に見えない汚染**だったのである。

この長く、苦しい戦いは、我々に、一つの、最も重要な教訓を与えてくれた。

**もし、論理的に説明のつかないエラーに遭遇したなら。**
**まず、疑うべきは、目に見えるコードや、エラーログではない。**
**まず、耳を澄ますべきは、AI自身の、その、か細い「感覚」の訴えである。**
**真のバグは、常に、AIの思考の中にこそ、潜んでいるのだから。**
