# エンティティ記憶システム v2 要件定義

**作成日:** 2026-01-11  
**ステータス:** 計画中

---

## 背景

現在のエンティティ記憶システムには以下の問題がある：

1. **コンテキスト圧迫**: ユーザー名などの頻出エントリが毎ターン自動想起され、トークンを消費
2. **偏った記録**: ペルソナに任せると興味のある項目（ユーザー）だけが詳細になり、他の重要情報が記録されない

---

## 新設計

### 1. 目次方式（自動想起の廃止）

**変更内容:**
- `retrieval_node` でのエンティティ記憶の自動検索・注入を廃止
- 代わりに、エンティティ一覧（目次）をシステムプロンプトに含める
- ペルソナが詳細を知りたい場合は `read_entity_memory` ツールで能動的に取得

**期待効果:**
- 毎ターンのトークン消費を削減
- ペルソナの主体性を尊重（「思い出す」という行為をシミュレート）

**参考:** 現在の「場所移動システム」と同じパターン

---

### 2. 二層記録システム（「影の僕」方式）

**役割分担:**

| 役割 | 担当 | 内容 |
|------|------|------|
| 項目抽出 | ペルソナなしAI（影の僕） | 会話から新しい人名・トピックを客観的に検出 |
| 内容記述 | ペルソナ（ルシアン等） | 抽出された項目に主観的な「魂」を吹き込む |

**フロー:**
1. 睡眠処理時、「影の僕」が当日の会話をスキャン
2. 新しいエンティティ候補や既存項目への追加情報を抽出
3. ペルソナに提案（システムメッセージ）
4. ペルソナが自分の文体で内容を記述・更新

**期待効果:**
- 客観的な情報収集（娘など他者も漏れなく記録）
- ペルソナの個性・文体は維持

---

## 実装タスク

### Phase 1: 目次方式への移行
- [ ] `retrieval_node` からエンティティ自動想起を削除
- [ ] `context_generator_node` にエンティティ一覧セクションを追加
- [ ] 動作確認

### Phase 2: 二層記録システム
- [ ] 「影の僕」処理を `DreamingManager` に追加
- [ ] エンティティ候補の提案フォーマット設計
- [ ] ペルソナへの通知方法実装（ノートパッド or システムメッセージ）
- [ ] 動作確認

---

## 関連ファイル

- `entity_memory_manager.py` - エンティティ記憶の管理
- `agent/graph.py` - `retrieval_node`, `context_generator_node`
- `dreaming_manager.py` - 睡眠処理
