# Nexus Ark 情景システム仕様書 (Scenery System Specification)

本ドキュメントは、Nexus Arkにおける情景画像システム（Scenery System）の仕様、特に画像検索フォールバックロジックと自動生成ポリシーについて定義します。
意図しない仕様変更（リグレッション）を防ぐための正本となります。

---

## 概要

情景システムは、AIペルソナがいる「場所」「季節」「時間帯」に基づいて、適切な背景画像をUIに表示する機能です。
ユーザー体験を損なわず、かつAPIコストを最小限に抑えるため、**「ある画像は必ず出す（フォールバック）」** と **「勝手に生成しない（コスト抑制）」** の2点を基本方針とします。

---

## 1. 自動生成ポリシー

### 🔴 自動生成の禁止 (No Auto-Generation)
- **原則**: システムがユーザーの許可なく、APIを使用して画像を自動生成してはいけません。
- **挙動**:
    - 適切な画像が見つからない場合、UI上の情景テキストのみ更新し、画像は `None`（または前回値/プレースホルダー）とします。
    - 画像生成は、ユーザーがUI上の **「情景画像を生成 / 更新」ボタンを押した場合のみ** 実行されます。
- **理由**: 画像生成APIは有料であり、意図しない課金やトークン消費を防ぐため。

---

## 2. 画像検索ロジック (Image Retrieval Logic)

画像検索関数 `utils.find_scenery_image` は、以下の優先順位で画像を探索します。

### 定義: ファイル命名規則
`{場所ID}_{季節}_{時間帯}.png`
- 例: `study_winter_night.png` （書斎・冬・夜）
- 例: `wine_cellar_daytime.png` （ワイン貯蔵庫・昼間＝季節不問）

### 優先順位 (Priority Order)

1. **場所 + 季節 + 時間帯 (完全一致)**
   - 例: `study_winter_night.png`

2. **場所 + 別の季節 + 同じ時間帯 (Season Fallback)**
   - 現在の季節から遡って検索（冬 → 秋 → 夏 → 春）
   - 例: `study_autumn_night.png`

3. **場所 + 時間帯フォールバック (Time Fallback)**
   - 明るさベースで代替時間帯を検索（後述のマッピング表参照）
   - 例: `study_daytime.png` (昼下がりに `daytime` 画像をヒットさせる)

4. **場所 + 時間帯のみ (Season Ignored)**
   - 季節指定のない画像
   - 例: `study_night.png`

5. **場所 + 季節のみ (Time Ignored)**
   - 時間指定のない画像（※現在ロジックでは除外されている可能性あり、要確認）

6. **場所のみ (Location Default)**
   - 例: `study.png`

7. **【最終手段】場所IDを含む任意の画像 (Desperation Fallback)**
   - 上記すべてで見つからない場合、その場所IDで始まるPNG画像があれば、無条件で1つ返します。
   - **目的**: 「画像があるのに何も表示されない」状態を回避するため。

---

## 3. 時間帯定義とフォールバックマップ

### 時間帯定義 (Time Definitions)
現在時刻から以下の時間帯名（英語）に変換されます。

| 時間帯 (Time of Day) | 時刻範囲 | 説明 |
|-------------------|---------|------|
| `early_morning` | 04:00 - 06:00 | 早朝 |
| `morning` | 06:00 - 10:00 | 朝 |
| `late_morning` | 10:00 - 12:00 | 昼前 |
| `afternoon` | 12:00 - 16:00 | 昼下がり |
| `evening` | 16:00 - 19:00 | 夕方 |
| `night` | 19:00 - 23:00 | 夜 |
| `midnight` | 23:00 - 04:00 | 深夜 |

### フォールバックマップ (`TIME_FALLBACK_MAP`)
特定の時間帯画像がない場合、以下の順序で代替画像を検索します。

| 元の時間帯 | フォールバック順序 | 解説 |
|-----------|------------------|------|
| **early_morning** | `morning` → `daytime` | 早朝がなければ朝、それもなければ昼間汎用 |
| **late_morning** | `morning` → `daytime` | 昼前がなければ朝、それもなければ昼間汎用 |
| **afternoon** | `noon`(*1) → `late_morning` → `morning` → `daytime` | 昼下がりは明るい画像を優先的に探す |
| **noon**(*2) | `late_morning` → `morning` → `daytime` | |
| **evening** | `night` | 夕方がなければ夜（暗い画像）へ |
| **midnight** | `night` | 深夜がなければ夜（暗い画像）へ |
| **morning** | `daytime` | 朝がなければ昼間汎用へ |
| **night** | - | 夜は夜のみ |

(*1) `noon` は生成プロンプトで使用されることがありますが、時刻判定ロジックでは `afternoon` に含まれます。
(*2) `daytime` は「昼間」を表す汎用的な名称として、すべての明るい時間帯の最後の砦として機能します。

---

## 関連ファイル
- `utils.py`: `find_scenery_image`, `TIME_FALLBACK_MAP`
- `ui_handlers.py`: `_get_updated_scenery_and_image` (自動生成呼び出しの有無)

## 更新履歴
- **2026-01-10**: 初版作成。自動生成廃止とフォールバック強化（`daytime`追加、最終手段追加）を反映。
