# Nexus Ark 機能仕様書：ワールド・ビルダー

## 1. 概要と設計思想

ワールド・ビルダーは、ユーザーとAIが共同で、対話の舞台となる「世界」を創造・編集・拡張していくための、Nexus Arkの中核機能である。

この機能の根底にある設計思想は**「書式の抽象化」**と**「段階的なインターフェース」**である。プログラミングの知識がないユーザー（例：娘さん）でも、直感的なGUIを通じて、世界の根幹をなす設定ファイル (`world_settings.txt`) を安全かつ自由に編集できることを最優先の目標とする。

## 2. 現在の仕様 (Phase 3完了時点)

### 2.1. データ構造

*   世界設定は、キャラクターフォルダ内の `spaces/world_settings.txt` に、人間が判読しやすい**Markdown形式**で保存される。
*   ファイルは、`## エリアID` と `### 部屋ID` という見出しによって階層的に構成される。
*   各セクションの内容は、**YAML (YAML Ain't Markup Language)** の書式に従って記述されるキーと値のペアで構成される。
*   **ID**: 各エリアと部屋は、`mizu_no_kagami` のような、半角英数字とアンダースコアで構成されたユニークなIDを持つ。これはシステムが内部的に場所を識別するために使用される。
*   **表示名 (`name`)**: IDとは別に、UI上に表示されるための日本語名（例：「水の鏡」）を持つ。

### 2.2. GUIの機能

ワールド・ビルダータブは、以下の3つの主要な編集モードを提供する。

#### a. エリアと部屋の管理
*   **閲覧**: 既存のエリアと部屋をリストで閲覧し、選択した項目の詳細（descriptionなど）をMarkdown形式で確認できる。
*   **新規作成**:
    *   ユーザーは「表示名」を入力するだけで、新しいエリアや部屋を作成できる。
    *   システムは、入力された表示名（例：「星見の塔」）から、ユニークなID（例：`hoshimi_no_tou`）を**自動的に生成**するため、ユーザーはIDの存在を意識する必要がない。

#### b. リスト項目の編集
*   **対象**: `furniture`, `objects`, `lighting` など、エリア/部屋の定義内で**リスト形式**で記述されている項目。
*   **編集フロー**:
    1.  「編集するリストを選択」ドロップダウンから、編集したいリスト（例：`furniture`）を選ぶ。
    2.  「編集する項目を選択」ドロップダウンに、そのリスト内の項目（例：「マホガニーの机」）が一覧表示される。
    3.  項目を選択すると、その `name` と `description` がテキストボックスに表示され、編集・保存が可能。
    4.  「新規項目を追加」ボタンから、リストに新しい項目を追加できる。
    5.  「この項目を削除」ボタンで、選択した項目をリストから削除できる。

#### c. RAW YAMLエディタ (上級者向け)
*   選択したエリアまたは部屋の定義全体を、生のYAML形式で直接編集できる。
*   `ambiance` のような辞書形式のデータや、リスト項目に `name`, `description` 以外のキーを追加するなど、GUIではまだ対応していない高度な編集を行うためのインターフェース。

### 2.3. AIによる編集機能
*   AIは、以下の専用ツールを通じて、ユーザーとの対話の中で `world_settings.txt` を読み書きできる。
    *   `read_world_settings`: 世界全体の設定を読む。
    *   `read_specific_location_settings`: 特定の場所の定義だけを読む。
    *   `update_location_settings`: **既存の**場所の定義を丸ごと上書きする。
    *   `add_new_location`: **新しい**場所の定義を追記する。
*   AIは、これらのツールを**「読む→考える→書き戻す」**という厳格な手順に従って使用するようにプロンプトで教育されており、これによりファイルの破損を防ぎ、安全な自動編集を実現している。

## 3. 将来の強化案 (Phase 4以降)

### 3.1. GUIの強化

*   **辞書型データのGUI編集**:
    *   `ambiance` や `architecture` のような、キーと値が固定された辞書データを編集するための、専用の入力フォームを実装する。
*   **リスト項目の高度な編集**:
    *   リスト項目が `name`, `description` 以外のキー（例：`menu` リスト内の `price`）を持つ場合に対応できるよう、編集フォームを動的に拡張する。
*   **AIによるテキスト整形支援**:
    *   ユーザーが自由形式で書いたテキスト（例：娘さんが書いた「水の鏡」の原文）を、「AIに整形をお願いする」ボタン一つで、正しいYAML形式に自動変換してフォームに流し込む機能。

### 3.2. AI連携の強化

*   **GUIとAIの融合**:
    *   ワールド・ビルダー内に、「この部屋に合う家具をAIに提案させる」ボタンなどを設置し、AIが自動で `furniture` リストに項目を追加する機能。
*   **対話からの直接編集**:
    *   ユーザーがチャットで「この部屋、もっと広くできない？」と話しかけると、AIが `read_specific_location_settings` で `architecture` を読み取り、`dimensions` の値を変更して `update_location_settings` で書き戻す、といった自律的な世界改変を実現する。

### 3.3. ビジュアル機能の強化

*   **ワールドマップ**:
    *   エリアと部屋の関係性を、視覚的なマップとして表示する機能。
*   **アセット管理**:
    *   各部屋に関連付けられた情景画像 (`spaces/images/`) を、ワールド・ビルダーのUI上から直接アップロード・管理できる機能。
