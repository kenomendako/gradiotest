# Nexus Ark 機能仕様書 (AIナレッジベース版)

## 1. 概要と基本コンセプト

### 1.1. Nexus Arkとは
Nexus Arkは、AIペルソナが自律的に思考し、ユーザーとの対話を通じて記憶を形成・成長させるためのパーソナルな対話アプリケーションです。AIが「暮らし」、世界を「共に創造する」環境を提供することを目的としています。

### 1.2. 設計思想
- **ルーム中心アーキテクチャ:** アプリケーションの基本単位は「ルーム」です。各ルームは独立した対話空間、記憶、世界設定を保持します。
- **魂と器の分離:** AIの「魂（ペルソナ）」は`SystemPrompt.txt`に、「器（ルーム）」は`characters/`以下のフォルダに対応します。これにより、単一のAIとの対話だけでなく、グループ会話やナレーター形式の物語進行など、多様な対話形式を実現します。

---

## 2. アプリケーションの基本構造

### 2.1. UIの構成
Nexus ArkのUIは、大きく3つのカラム（列）で構成されています。
- **左カラム:** ルームの選択と、アプリケーション全体の各種設定を行います。
- **中央カラム:** AIとの対話を行うメインのチャットインターフェースです。
- **右カラム:** 現在のルームのプロフィール、情景、場所移動などを管理します。

---

## 3. チャット機能

### 3.1. メッセージの送受信
中央カラムの最下部にあるテキストボックスからメッセージを送信します。`Shift+Enter`キーで送信が可能です。

### 3.2. マルチモーダル入力
テキストボックスには、テキストだけでなく、以下のファイルをドラッグ＆ドロップまたは添付ボタンで追加できます。ファイルはルームの`attachments/`フォルダに永続的に保存されます。
- 画像ファイル (`.png`, `.jpg`など)
- 音声ファイル (`.wav`, `.mp3`など)
- 動画ファイル (`.mp4`など)
- テキストファイル (`.txt`, `.md`, `.py`, `.json`など)
- PDFファイル

### 3.3. グループ会話
左カラムの「🧑‍🤝‍🧑 グループ会話」メニューから、現在のルーム（魂の器）に他のルームのAIを招待し、複数人での会話が可能です。
- **仕組み:** グループ会話中の全ての発言（ユーザー、各AI）は、参加者全員の`log.txt`にリアルタイムで記録されます。AIが応答する際は、自身のログを元に状況を判断するため、各AIは会話の文脈を失うことなく、自身の記憶として対話を保持できます。

### 3.4. 応答の再生成
チャット履歴のAIの発言をクリックして選択し、「🔄 再生成」ボタンを押すと、そのAIの発言の直前のユーザー発言を元に応答を再生成します。この際、選択されたAIの発言とその後のログは`log.txt`から削除されます。

### 3.5. ログの編集
チャット履歴の任意の発言をクリックすると、内容を直接編集できます。編集後、`Enter`キーで確定すると、`log.txt`ファイルが直接更新されます。この操作の前には、自動でログのバックアップが作成されます。

### 3.6. ログの削除
チャット履歴の発言をクリックして選択し、「🗑️ 選択した発言を削除」ボタンを押すと、確認ダイアログの後、その発言が`log.txt`から削除されます。

### 3.7. 発言の音声再生
AIの発言を選択し、「🔊 選択した発言を再生」ボタンを押すと、そのルームの「個別設定」で設定された声でテキストが読み上げられ、生成された音声ファイルは`audio_cache/`フォルダに保存されます。

### 3.8. ストリーミング表示（タイプライター効果）
AIの応答を、一文字ずつタイプライターのように表示する機能です。「個別設定」でルームごとにON/OFF、および表示速度（`streaming_speed`）を調整できます。

---

## 4. ルーム管理

左カラムの「🗨️ チャットルームの作成・管理」メニューから行います。

### 4.1. ルームとは
対話、記憶、設定の基本単位です。物理的には`characters/`ディレクトリ内の各サブフォルダに対応します。

### 4.2. 新規作成
「作成」タブから、ルーム名、ユーザー表示名、AI表示名、説明、初期システムプロンプトを設定して、新しいルームを作成できます。

### 4.3. 外部ログのインポート
「インポート」タブから、他のサービスで作成された会話ログを新しいルームとして取り込めます。
- **ChatGPT (公式):** 公式エクスポートデータ（`conversations.json`）に対応。
- **Claude (公式):** 公式エクスポートデータ（`conversations.json`）に対応。
- **その他テキスト/JSON:** ChatGPT Exporter形式や、ユーザーが指定した話者ヘッダーを持つ任意のテキストファイルに対応。

### 4.4. ルーム設定の管理
「管理」タブから、既存ルームの表示名、ユーザー表示名、AI表示名、説明を編集できます。ルームフォルダをOSのファイルエクスプローラーで開くことも可能です。

### 4.5. ルームの削除
「管理」タブでルームを選択し、「このルームを削除」ボタンを押すと、確認ダイアログの後、ルームのフォルダが完全に削除されます。**この操作は元に戻せません。**

---

## 5. 設定項目

左カラムの「⚙️ 設定」アコーディオンから各種設定を行えます。

### 5.1. 共通設定 (`config.json`)
アプリケーション全体に影響する設定です。
- **APIキー管理:**
  - **Gemini APIキー:** AIとの対話に必要なAPIキーを、管理用の名前をつけて複数登録・管理できます。
  - **Pushover/Discord:** アラーム通知に使用するサービスのAPIキーやWebhook URLを設定します。
- **デフォルトAIモデル:** 新規ルーム作成時などにデフォルトで使用されるAIモデルを選択します。
- **APIへの履歴送信:** AIに応答を生成させる際に、過去の会話ログを何往復分送信するかを設定します。「全ログ」がデフォルトです。
- **デバッグモード:** 有効にすると、AIに渡される最終的なシステムプロンプトがターミナルに出力されます。
- **通知サービス:** アラームやタイマーの通知に「Discord」と「Pushover」のどちらを使用するか選択します。
- **バックアップ世代数:** 各種ファイルの自動バックアップを何世代分保持するかを設定します。デフォルトは10です。

### 5.2. 個別設定 (`characters/{ルーム名}/room_config.json`)
現在選択しているルームにのみ適用される設定です。
- **情景描写システム:** ON/OFFを切り替えます。OFFにすると、右カラムの情景表示が無効になります。
- **ストリーミング表示設定:** タイプライター効果のON/OFFと表示速度を設定します。
- **音声設定:** 発言の音声再生に使用する声の種類（`voice_id`）と、声のトーンを指示するスタイルプロンプト（`voice_style_prompt`）を設定します。
- **AI生成パラメータ:**
  - **Temperature:** 応答の創造性を調整します。値が高いほど多様な応答になります。
  - **Top-P:** 応答に使用される単語の選択範囲を調整します。
- **安全性設定:** Googleのセーフティフィルターの閾値を、コンテンツカテゴリごとに設定します。
- **APIコンテキスト設定:** AIに応答を生成させる際に、以下の情報をプロンプトに含めるかどうかを個別に設定できます。
  - メッセージにタイムスタンプを追加 (`add_timestamp`)
  - 現在時刻をAPIに送信 (`send_current_time`)
  - 思考過程をAPIに送信 (`send_thoughts`)
  - メモ帳の内容をAPIに送信 (`send_notepad`)
  - 共通ツールプロンプトを注入 (`use_common_prompt`)
  - コアメモリをAPIに送信 (`send_core_memory`)
  - 空間描写・設定をAPIに送信 (`send_scenery`)

### 5.3. パレット（テーマ設定）
UIの見た目を変更します。プリセットテーマ（Soft, Defaultなど）の選択や、色やフォントをカスタマイズして新しいカスタムテーマとして保存できます。設定を適用するにはアプリケーションの再起動が必要です。

---

## 6. 時間管理機能

### 6.1. アラーム (`alarms.json`)
左カラムの「⏰ 時間管理」→「アラーム」タブから設定します。
- **設定方法:** 時刻、通知先のルーム、内容、繰り返し曜日、緊急通知の有無を設定してアラームを追加・更新できます。
- **通知の仕組み:** 設定時刻になると、指定されたルームのAIが内容に基づいた応答を生成し、設定された通知サービス（Discord/Pushover）およびPCのデスクトップ通知でメッセージを送信します。

### 6.2. タイマー
「タイマー」タブから設定します。設定は永続化されません。
- **通常タイマー:** 指定した分数後に一度だけ通知します。
- **ポモドーロタイマー:** 作業時間、休憩時間、サイクル数を設定して、繰り返し通知させることができます。

---

## 7. 「記憶・メモ・指示」タブ

### 7.1. システムプロンプト (`SystemPrompt.txt`)
- **役割:** AIの基本的な人格、役割、行動指針を定義するファイルです。ここに書かれた内容は、AIの思考の根幹をなします。
- **書式:** 自由なテキスト形式で記述します。

### 7.2. 記憶 (`memory/memory_main.txt`)
- **役割:** AIの主観的な記憶や日記を記録するファイルです。
- **ファイル構造:**
  - `## 永続記憶 (Permanent)`: このセクションの内容は、要約されずにそのままコアメモリにコピーされます。AIの不変の自己同一性などを記述します。
  - `## 日記 (Diary)`: 日々の出来事などを追記していくセクションです。この内容はAIによって要約され、コアメモリに反映されます。
  - `## アーカイブ要約 (Archive Summary)`: 古い日記をアーカイブした際の要約がここに蓄積されます。
- **日記のアーカイブ機能:** 「古い日記をアーカイブする」メニューから、指定した日付までの日記を要約し、別ファイル (`memory/memory_archived_xxx.txt`) に移動させることができます。

### 7.3. コアメモリ (`core_memory.txt`)
- **役割:** AIが自己同一性を保つための、要約された記憶の集合体です。APIに頻繁に送信されます。
- **自動更新:** 「コアメモリを更新」ボタンを押すと、`memory_main.txt`の内容を元に、以下のロジックで`core_memory.txt`が自動生成されます。
  1. `永続記憶 (Permanent)`セクションの内容をそのままコピー。
  2. `日記 (Diary)`セクションの内容をAIが要約したものを追記。
  3. `アーカイブ要約 (Archive Summary)`セクションの内容をそのままコピー。

### 7.4. 知識 (RAG)
- **機能概要:** Retrieval-Augmented Generation (RAG) 技術を使用し、AIが外部ドキュメントを知識ベースとして参照できるようにする機能です。
- **ファイル管理:** このタブから、知識として参照させたいドキュメントファイル (`.txt`, `.md`) をアップロード・削除できます。ファイルは`characters/{ルーム名}/knowledge/`に保存されます。
- **索引作成:** 「索引を作成 / 更新」ボタンを押すと、`knowledge/`内のドキュメントがチャンクに分割され、`gemini-embedding-001`モデルでベクトル化された後、`FAISS`を用いて検索可能な索引が`rag_data/faiss_index/`に作成されます。
- **AIによる検索:** AIは`search_knowledge_base`ツールを使い、ユーザーの質問に関連する情報をこの知識ベースから検索して回答に利用できます。

### 7.5. メモ帳 (`notepad.md`)
- **役割:** AIやユーザーが短期的な情報を書き留めておくためのファイルです。
- **書式:** Markdown形式で記述できます。

---

## 8. ワールド・ビルダー

対話の舞台となる世界設定ファイル (`spaces/world_settings.txt`) を編集するための機能です。

### 8.1. `world_settings.txt`の構造
- `## エリア名`と`### 場所名`という見出しによって階層的に構成されます。
- 各場所の説明は自由なテキスト形式で記述します。

### 8.2. 編集方法
- **構造化エディタ:** エリアと場所をドロップダウンで選択し、内容をピンポイントで編集・追加・削除できます。
- **RAWテキストエディタ:** ファイル全体を直接テキストとして編集できます。

### 8.3. AIによる編集
AIは以下のツールを使い、対話を通じて世界設定を自律的に読み書きできます。
- `read_world_settings`: 世界設定全体を読む。
- `plan_world_edit`: 世界設定の変更を計画する。AIが変更の意図を伝えると、別のAIが差分指示を生成し、システムがそれを適用します。

---

## 9. チャット支援ツール

### 9.1. 文字置き換え（スクリーンショットモード）
チャット履歴内の特定の文字列を、一時的に別の文字列や色付きの背景に置き換えて表示する機能です。スクリーンショットを共有する際などに使用します。**元のログファイルは変更されません。**

### 9.2. ログ修正（読点AI修正）
選択した発言以降の**AIの応答**に含まれる読点（、）を、AI (`gemini-2.5-flash-lite`) を使って自動で修正し、より自然な文章に校正します。**この操作はログファイルを直接変更します**が、処理前にバックアップが作成されます。

### 9.3. 添付ファイル管理
過去に添付したファイルを一覧で確認できます。ファイルを選択することで、現在のチャット入力に含める「アクティブな添付ファイル」として指定できます。

---

## 10. AIの思考とツール使用

### 10.1. 思考プロセス (LangGraph)
Nexus ArkのAIは、LangGraphフレームワークに基づいて思考します。ユーザーからの入力に対し、まず状況を認識し、ツールを使うべきか、あるいはテキストで応答すべきかを判断します。ツール使用時には「〜しますね」のような意思表示（第一幕）と、ツール実行後の最終報告（第二幕）を分けて応答することがあります。

### 10.2. コアプロンプト (`agent/prompts.py`)
AIの基本的な行動原則や作法は、`CORE_PROMPT_TEMPLATE`に定義されています。ここには、ツール使用のガイドラインや、記憶・知識の参照順序などが記述されています。
- **情報参照の優先順位:**
  1. `search_knowledge_base` (普遍的な事実、マニュアル)
  2. `search_memory` (自身の過去の体験、感情)
  3. `search_past_conversations` (具体的な会話のやり取り)
  4. `web_search_tool` (最新の外部情報)

### 10.3. 利用可能なツール一覧
AIは以下のツールを自律的に使用できます。
- **場所移動:** `set_current_location`
- **世界設定:** `read_world_settings`, `plan_world_edit`
- **記憶/日記:** `search_memory`, `search_past_conversations`, `read_main_memory`, `plan_main_memory_edit`, `read_secret_diary`, `plan_secret_diary_edit`
- **メモ帳:** `read_full_notepad`, `plan_notepad_edit`
- **Web:** `web_search_tool`, `read_url_tool` (スタブ)
- **画像生成:** `generate_image`
- **時間管理:** `set_personal_alarm`, `set_timer`, `set_pomodoro_timer`
- **知識検索:** `search_knowledge_base`

---

## 11. ファイル構造リファレンス

`characters/{ルーム名}/`フォルダ以下の主要なファイルとフォルダの説明です。
- `attachments/`: チャットに添付されたファイルが永続的に保存されます。
- `backups/`: 各種ファイルの自動バックアップが世代管理されて保存されます。サブフォルダ（`logs/`, `memories/`など）で分類されます。
- `cache/`: 情景描写テキスト (`scenery.json`) などのキャッシュデータが保存されます。
- `audio_cache/`: 生成された音声ファイル（`.wav`）が保存されます。
- `generated_images/`: AIが`generate_image`ツールで生成した画像が保存されます。
- `knowledge/`: RAG機能のための知識ドキュメントを配置するフォルダです。
- `rag_data/`: RAGの索引データ（FAISSインデックス）が保存されます。
- `log.txt`: 全ての会話履歴が記録されます。
- `log_archives/`: 閾値を超えた古い`log.txt`の内容が移動されます。
- `memory/`:
  - `memory_main.txt`: 主観的記憶（日記）の本体です。
  - `memory_archived_xxx.txt`: アーカイブされた古い日記です。
- `private/`:
  - `secret_diary.txt`: AIがプライベートな内容を記録するためのファイルです。
- `spaces/`:
  - `world_settings.txt`: 世界設定の本体です。
  - `images/`: 情景画像が保存されます。ファイル名は`{場所名}_{季節}_{時間帯}.png`の形式です。
- `core_memory.txt`: AIの自己同一性の核となる要約された記憶ファイルです。
- `room_config.json`: ルームの表示名や個別設定などを保存するファイルです。
- `SystemPrompt.txt`: AIのペルソナ（人格）を定義するファイルです。
- `profile.png`: UIに表示されるプロフィール画像です。
- `current_location.txt`: AIの現在の場所を記録するファイルです。