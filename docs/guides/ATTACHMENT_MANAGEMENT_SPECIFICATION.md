# Nexus Ark 機能仕様書：永続的添付ファイル管理

## 1. 概要と設計思想

この機能は、ユーザーがチャットに添付した画像やテキストなどのファイルを、セッションを越えて永続的に管理し、AIとの対話で継続的に参照させることを目的とする。

この機能の根底にある設計思想は、以下の2つの原則に基づいている。

1.  **ファイルの永続化:** Gradioの一時ファイルは揮発性であり、アプリケーションの再起動や一定時間で失われる。これを防ぐため、添付された全てのファイルは、各ルーム専用の永続的なストレージにコピー・保存される。

2.  **AIの文脈的混乱の防止:** 過去に添付されたファイルを、何の情報もなく現在のプロンプトに注入すると、AIは「なぜ、このファイルが『今』ここにあるのか」を理解できず、時系列が混乱し、対話が破綻する危険性が高い。これを防ぐため、ファイルの内容と共に**「いつ添付されたか」という時系列のメタ情報**を付与し、AIが文脈を正しく認識できるよう支援する。

## 2. 主要アーキテクチャ

本機能は、UI、状態管理、バックエンド処理が連携することで実現される。

### a. `attachments` フォルダ
*   **物理的実体:** `characters/{ルーム名}/attachments/`
*   **役割:** ユーザーが添付した全てのファイルの永続的な保管庫。ファイルはUUIDを含むユニークなファイル名で保存され、元のファイル名の衝突を防ぐ。

### b. 「添付ファイル」管理UI (`nexus_ark.py`)
*   **UIコンポーネント:** `gr.Dataframe`
*   **役割:** `attachments`フォルダ内のファイルを一覧表示し、ユーザーが「アクティブな添付ファイル」を選択（トグル）するためのインターフェース。ファイルの完全な削除もここから行う。

### c. アクティブ状態管理 (`active_attachments_state`)
*   **UIコンポーネント:** `gr.State`
*   **役割:** 現在アクティブになっている添付ファイルの**絶対パスのリスト**を、UIセッション中で保持する。このStateが、UIとバックエンドをつなぐ唯一の情報源となる。

### d. プロンプト注入ロジック (`gemini_api.py`)
*   **役割:** メッセージ送信時に、`active_attachments_state`の内容を元に、AIに渡す最終的なプロンプトを動的に構築する。これが本機能の核心である。

## 3. 処理フロー：メッセージ送信時

1.  **UIからの情報伝達 (`nexus_ark.py` -> `ui_handlers.py`):**
    ユーザーがメッセージを送信すると、メッセージ本文と共に、`active_attachments_state`に保持されているアクティブなファイルパスのリストが、イベントハンドラに渡される。

2.  **API層への中継 (`ui_handlers.py` -> `gemini_api.py`):**
    `handle_message_submission`は、受け取ったファイルパスのリストを、AI呼び出しの中核である`invoke_nexus_agent_stream`関数に、引数としてそのまま渡す。

3.  **プロンプトの動的構築 (`gemini_api.py: invoke_nexus_agent_stream`):**
    a.  まず、AIに渡すプロンプトパーツのリストの**先頭**に、特別なヘッダー `【現在アクティブな添付ファイルリスト】` を追加する。
    b.  アクティブな各ファイルパスについて、ルームの完全なログ（`log.txt`）を逆順にスキャンし、そのファイルパスが最初に登場したメッセージを探す。
    c.  見つかったメッセージと、現在のメッセージ総数との差から、「何ターン前に添付されたか」を**近似的に計算**する。
    d.  `[ファイル名 (Nターン前に添付)]` という形式のメタ情報をプロンプトパーツに追加する。
    e.  ファイルの中身を`filetype`で判定し、画像であればBase64エンコードして、テキストであればその内容をそのまま、プロンプトパーツに追加する。
    f.  最後に、ユーザーが実際に入力したメッセージ本文を、これらのパーツの後に追加する。

4.  **AIへの送信:**
    こうして構築された、時系列情報とファイル内容を含む完全なプロンプトが、AIモデルに送信される。

## 4. 未来の開発者への重要注意事項

*   **プロンプト形式の聖域:**
    `【現在アクティブな添付ファイルリスト】` から始まるプロンプトの注入形式は、AIが文脈を理解するための**AIとの契約**である。この形式を安易に変更すると、AIの時系列認識が破綻し、予期せぬ応答を引き起こす可能性がある。変更する場合は、AIの挙動を十分にテストすること。

*   **時系列計算の近似性:**
    「Nターン前」という計算は、ログのメッセージ数に基づく**近似値**である。ログの形式が将来変更された場合、この計算ロジックも見直す必要がある。

*   **パフォーマンスへの配慮:**
    現在の実装では、アクティブなファイルの**内容全て**が、毎回のAPIリクエストに含まれる。巨大なテキストファイルや多数の画像を長期間アクティブにし続けると、APIのトークン上限に達したり、応答が遅延したり、コストが増大する原因となる。これは、本機能の現在の仕様上の制約である。

## 5. 将来の展望

*   **持続ターン数の設定:** ユーザーが「このターンのみ」「3ターン持続」など、ファイルの持続時間をUIから選択できるようにする。
*   **RAGとの連携:** 「このファイルを知識ベースに登録する」ボタンを追加し、大規模なファイルを永続的な知識として、検索可能な形でAIに提供する。
*   **UIの改善:** ファイルタイプに応じたアイコン表示や、画像ファイルのサムネイルプレビュー機能を追加する。