# Nexus Ark 機能仕様書：エピソード記憶（中期記憶）システム

## 1. 概要と目的

本システムは、AIの記憶構造における「短期記憶（生のログ）」と「長期記憶（RAG）」の間を埋める**「中期記憶」**を提供するものである。
直近数週間〜数ヶ月の会話ログを「日ごとの要約（エピソード）」として圧縮・保持することで、トークン消費を抑えつつ、継続的な文脈（コンテキスト）をAIに維持させることを目的とする。

## 2. コアアーキテクチャ：弾力的注入 (Elastic Injection)

本機能の最大の特徴は、ユーザーが設定する「ログ送信量（短期記憶の長さ）」に応じて、**注入する要約の範囲を動的に調整する**点にある。

### 概念図
```text
[ 現在 (Today) ]
      ↑
      |  (A) 短期記憶 (Raw Log)
      |  ユーザー設定（例: 20往復 or 90往復）によって長さが伸縮する
      |
[ 境界線 (Dynamic Boundary) ] ← システムが自動計算
      |
      |  (B) 中期記憶 (Episodic Summary)
      |  「境界線」より古い日付の要約だけを自動的に選んで結合する
      |
[ 設定された参照期間 (Lookback Limit) ]
```

### 挙動のルール
1.  **重複の防止:** APIに送信される「生のログ」に含まれる**最も古い日付**を特定し、それより新しい日付の要約はプロンプトに含めない。
2.  **空白の防止:** 生のログが短くなれば、その分だけ新しい日付の要約まで含めるように範囲を自動拡張する。

## 3. データ構造

*   **保存場所:** `characters/{ルーム名}/memory/episodic_memory.json`
*   **形式:** 日付をキーとしたJSONリスト。
    ```json
    [
      {
        "date": "2025-10-20",
        "summary": "ユーザーと〇〇について議論した。...",
        "created_at": "2025-12-03T12:00:00"
      },
      ...
    ]
    ```
*   **ライフサイクル:**
    *   一度作成された要約は**削除されない**。
    *   直近（設定期間内）のものはプロンプトへの直接注入（中期記憶）として利用される。
    *   それより古いものは、将来的にRAG（長期記憶）の検索対象として利用される資産となる。

## 4. 処理フロー

### A. 作成・更新 (Update Process)
ユーザーが「エピソード記憶を作成 / 更新」ボタンを押した時に実行される。

1.  **ログ収集:** `log.txt`（現行）および `log_archives/`（過去ログ）を全て読み込む。
2.  **対象特定:** 「今日」を含まない、過去の完了した日付のうち、まだJSONに存在しない日付を特定する。
3.  **要約生成:** `gemini-2.5-flash` (`SUMMARIZATION_MODEL`) を使用し、日ごとに要約を生成する。
    *   **レート制限対策:** API制限（429エラー）を検知した場合、自動的に待機（Sleep）してリトライする機能を備える。
4.  **保存:** 生成された要約をJSONに追記保存する。
    *   **エラー発生時のスマート・ハンドリング (Phase 10):**
        *   **一時的エラー (500, 503, 429等):** 最大3回まで自動リトライを行う。リトライしきれない場合は「保存せずにスキップ」する。これにより、次回以降に自動的に再試行される体制を維持する。
        *   **恒久的なエラー (ポリシー違反等):** 「（エラーにより要約できませんでした）」という記録を保存し、無限ループを防止する。
    *   **過去のエラー記録の自動修復 (Phase 10):**
        *   ファイル内に「（エラーにより要約できませんでした）」という記録がある場合、それを未処理とみなして再処理対象に含める。
        *   正常な要約が生成された時点で、古いエラー記録を新しい要約で自動的に上書き・修復する。
    
### B. 注入 (Injection Process)
AIが応答を生成する直前（およびトークン計算時）に実行される。

1.  **境界特定:** 送信予定のメッセージリストをスキャンし、最古のタイムスタンプ（YYYY-MM-DD）を取得する。
2.  **フィルタリング:** `episodic_memory.json` から、`[設定された参照期間] <= 日付 < [最古のタイムスタンプ]` の範囲にある要約を抽出する。
3.  **プロンプト構築:** 抽出した要約をテキスト化し、システムプロンプトの `{episodic_memory}` セクションに挿入する。

## 5. UI仕様

### 個別設定
*   **「エピソード記憶の参照期間」:** 過去1週間、2週間、1ヶ月、3ヶ月から選択可能。これにより「どこまで遡って思い出すか」を制御する。

### 記憶タブ
*   **更新ボタン:** 手動で要約処理を実行する。
*   **情報表示:** 最後に処理された（最新の）エピソード記憶の日付を表示する。
*   **安全装置:** 更新処理中はボタンとチャット入力欄を無効化（ロック）し、データの競合とAPI制限の衝突を防ぐ。

## 6. 高度な機能：話題クラスタリングとデータ圧縮

エピソード記憶システムは、以下の高度な拡張機能を備えている。詳細は [話題クラスタリング記憶システム仕様書](TOPIC_CLUSTERING_MEMORY_SPECIFICATION.md) を参照。

- **話題ベースの検索**: 記憶を話題ごとにクラスタリングし、文脈に応じた想起を可能にする。
- **データ圧縮 (Phase 4)**: 作成から180日が経過したエピソードを週単位の要約に統合し、データの肥大化を防ぐ。元の生データは `memory/archives/` に隔離保存される。
- **堅牢な日付判定 (Phase 10)**:
    - 範囲指定（`YYYY-MM-DD~YYYY-MM-DD`）において、半角 `~` と全角 `～` の両方を区切り文字として認識。
    - 全ての日付比較において、前後から空白を除去（`.strip()`）してマッチングを行うことで、微細な書式のズレによる重複要約やデータ消失を防止。

## 7. 関連ファイル
*   `episodic_memory_manager.py`: 要約生成、JSON読み書き、フィルタリング、**データ圧縮**。
*   `topic_cluster_manager.py`: **話題クラスタリング、検索ロジックの中核**。
*   `ui_handlers.py`: ボタンイベントの制御、UIロック機構。
*   `agent/graph.py`: プロンプトへの注入ロジック（通常の想起および**話題想起**）。
*   `gemini_api.py`: プロンプトへの注入ロジック（トークン計算時）。