# Nexus Ark 機能仕様書：季節・時間指定機能

## 1. 概要と設計思想

この機能は、ユーザーが各ルームの「世界時間」を自由にコントロールする能力を提供し、Nexus Arkの没入感と用途の多様性を飛躍的に向上させることを目的とする。

設計思想の核は**「設定の局所化」**と**「UIの直感性」**である。時間設定は、TRPGのセッション、物語創作、あるいは単に特定の雰囲気を楽しみたいといった、ルームごとの異なるコンテキストに完全に紐付けられるべきである。UIは、この強力な機能を、専門知識なしで、誰もが簡単に操作できるものでなければならない。

## 2. UI仕様

-   **配置場所:**
    「チャット」タブの右カラムにある「プロフィール・情景」アコーディオンの**最上部**。
-   **コンテナ:**
    -   `gr.Accordion("🕰️ 季節・時間を指定", open=False)`
-   **内部コンポーネント:**
    1.  `gr.Markdown("（この設定はルームごとに保存されます）")`
    2.  `gr.Radio(choices=["リアル連動", "選択する"], label="モード選択")`
    3.  `gr.Dropdown(label="季節を選択", choices=["春", "夏", "秋", "冬"])`
        -   「選択する」モードの時のみ表示。
    4.  `gr.Dropdown(label="時間帯を選択", choices=["朝", "昼", "夕方", "夜"])`
        -   「選択する」モードの時のみ表示。
    5.  `gr.Button("このルームの時間設定を保存")`
        -   「選択する」モードの時のみ表示。

## 3. 機能仕様

-   **設定の永続化:**
    -   時間設定（モード、季節、時間帯）は、各ルームの `room_config.json` ファイル内に `"time_settings"` という新しいキーで保存される。
    -   `"mode"` キーには `"realtime"` または `"fixed"` が保存される。
    -   `"fixed_season"` と `"fixed_time_of_day"` キーには、選択された値の英語名（例: `"autumn"`, `"night"`）が保存される。
-   **デフォルト動作:**
    -   `room_config.json` に設定が存在しないルームは、すべて「リアル連動」モードとして動作する。
-   **情景生成への全体的な影響:**
    -   **「選択する」モードの場合:** 保存された季節と時間帯が、以下の全ての情景生成ロジックで**最優先**される。
        1.  情景テキストの生成 (`agent/graph.py: generate_scenery_context`)
        2.  情景画像の生成 (`ui_handlers.py: handle_generate_or_regenerate_scenery_image`)
        3.  場所移動時の情景自動更新
        4.  チャット送信時のAIの状況認識（システムプロンプト）
    -   **「リアル連動」モードの場合:** 従来通り、PCの現在時刻と日付が使用される。

## 4. 関連ファイルと責務

-   **`nexus_ark.py`:** 上記UI仕様に基づき、新しいUIコンポーネントをレイアウトに追加する。
-   **`ui_handlers.py`:**
    -   新UIの表示/非表示を切り替えるイベントハンドラを実装する。
    -   「保存」ボタンが押された際に `room_config.json` に設定を書き込む処理を実装する。
    -   ルームが切り替わった際に `room_config.json` から設定を読み込み、UIに反映させる処理を実装する。
    -   あらゆる情景生成のトリガーとなるイベント（チャット送信、場所移動など）で、現在の時間設定を判断し、適切な季節と時間帯の情報を他の関数に引き渡す。
-   **`agent/graph.py`:** `generate_scenery_context` 関数を、`ui_handlers.py` から渡される季節と時間帯の情報（オプショナルな引数）を受け取れるように修正する。
-   **`utils.py`:** `get_season` と `get_time_of_day` 関数を、引数がない場合は現在時刻から、引数がある場合はその引数を元に結果を返すように修正する。日本語名を内部用の英語名に変換するヘルパー関数も追加する。
-   **`room_manager.py`:** `get_room_config` を利用して `room_config.json` を読み込む。