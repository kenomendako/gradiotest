# 話題クラスタリング記憶システム仕様書 (Topic Clustering Memory System Specification)

## 1. 概要
話題クラスタリング記憶システムは、エピソード記憶（中期記憶）を話題（トピック）ごとに自動分類し、AIが過去の関連する出来事を効率的に想起できるようにする高度な記憶管理システムである。

従来の期間ベース（直近N日間）の想起に加え、話題ベースの想起を組み合わせることで、数ヶ月前の出来事であっても現在の文脈に関連すれば即座に呼び出すことが可能になる。

## 2. 主要コンポーネント

### 2.1 TopicClusterManager (`topic_cluster_manager.py`)
システムの核となるモジュール。以下の役割を担う：
- エピソード記憶のベクトル化とクラスタリング
- 各クラスタに対するAIによるラベル（愛称）と要約の生成
- ユーザーのクエリに基づいた関連クラスタのセマンティック検索

### 2.2 EmbeddingProvider
ベクトル化を行うための抽象化レイヤー。
- **Gemini API**: 高精度なオンラインエンベディング。
- **Local (sentence-transformers)**: `paraphrase-multilingual-MiniLM-L12-v2` モデルを使用したオフラインエンベディング。APIコストがかからず、機密性が高い。

### 2.3 EpisodicMemoryManager (`episodic_memory_manager.py`)
エピソード記憶のライフサイクルを管理。Phase 4で「データ圧縮」機能が統合された。

## 3. 動作メカニズム

### 3.1 クラスタリングプロセス
1. **ベクトル化**: 全てのエピソード記憶を `EmbeddingProvider` で多次元ベクトルに変換。
2. **HDBSCAN**: 密度ベースのクラスタリングアルゴリズムを使用して、関連性の高いエピソードをグループ化。
3. **重心計算**: 各クラスタの代表ベクトル（重心）を算出。
4. **AIラベリング**: クラスタ内のテキスト（最大5件）をLLM（内部処理用Gemini-2.5-flashなど）に送り、話題のタイトルと概要を生成。

### 3.2 検索と想起 (Phase 3)
1. **クエリ変換**: ユーザーの入力をベクトル化。
2. **コサイン類似度**: 全クラスタの重心とクエリの類似度を計算。
3. **プロンプト注入**: 類似度が高い上位2件（閾値0.3以上）のクラスタ要約を、システムプロンプトの「関連する話題の記憶」セクションに注入。

### 3.3 データ圧縮とアーカイブ (Phase 4)
- **対象**: 作成から180日（約半年）が経過した日単位のエピソード。
- **週単位統合**: 古いエピソードを月曜日開始の「週」ごとにグループ化。
- **週間要約**: AIがその週の全エピソードを読み込み、1つの自然な文章（週間要約）に書き換える。
- **アーカイブ**: 圧縮前の詳細なデータは `memory/archives/` に `episodic_archive_YYYYMMDD_HHMMSS.json` として隔離保存される。

## 4. データ構造

### topic_clusters.json
```json
{
  "version": "1.0",
  "clusters": [
    {
      "cluster_id": "cluster_001",
      "auto_label": "週末のキャンプ機材の準備",
      "persona_label": null,
      "centroid_embedding": [...],
      "episode_dates": ["2025-05-01", "2025-05-02"],
      "episode_count": 2,
      "summary": "週末のキャンプに向けてシュラフやランタンの確認をした話。",
      "created_at": "2025-12-19T12:00:00"
    }
  ],
  "last_updated": "2025-12-19T12:00:00"
}
```

## 5. UI設定と制御

### 5.1 エンベディング設定
- **APIモード**: 高精度な検索が必要な場合に推奨。
- **ローカルモード**: コスト削減やオフラインでの安定性を重視する場合に推奨。

### 5.2 睡眠時記憶整理
夢日記生成時に自動実行されるタスクを個別にオン/オフ可能：
- **話題クラスタを更新**: 新しいエピソードを含めて再クラスタリングを行う。
- **古い記憶を圧縮する**: 半年以上前の記憶を週単位にまとめる。

---
**初版作成日**: 2025-12-19
**対応フェーズ**: Phase 1 〜 Phase 4 完了時点
