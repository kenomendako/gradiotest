# Nexus Ark RAGシステム仕様書 (Log Integration Ver.)

## 1. 概要
本システムは、ユーザーがアップロードした知識ドキュメント（Knowledge）だけでなく、**過去の膨大な会話ログ（Archives）**も統合的に検索可能にするためのRAG（Retrieval-Augmented Generation）基盤である。

## 2. エンベディング・エンジン

本システムは、テキストをベクトル化するエンベディング・エンジンとして、以下の2つのモードを選択できる。

- **Gemini API (Online)**: GoogleのAPIを使用。高精度で高性能だが、APIコストとネットワーク環境が必要。
- **Local (Offline)**: `sentence-transformers` モデルを使用してローカルでベクトル化。無料かつプライバシーが守られ、ネットワークなしでも動作する。

設定はルームごとの「記憶」タブにある「エンベディング設定」から切り替えることができる。

## 3. アーキテクチャ：ハイブリッド・インデックス

膨大な過去ログの再処理コストを回避しつつ、最新の変更を即座に反映するため、**「静的」と「動的」の2つのインデックスを併用するアーキテクチャ**を採用している。

### A. 静的インデックス (`rag_data/faiss_index_static`)
*   **対象:** `log_archives/` フォルダ内の全ての `.txt` ファイル。
*   **特性:** **追記型 (Append Only)**。
*   **更新ロジック:**
    *   `processed_static_files.json` に処理済みのファイル名を記録。
    *   更新ボタン押下時、**未記録の新規ファイルのみ**をベクトル化してインデックスに追加する。
    *   既存のファイルが変更されても検知しない（アーカイブは不変であるという前提）。
*   **メリット:** ログが数GBに肥大化しても、日々の更新処理は一瞬で完了する。

### B. 動的インデックス (`rag_data/faiss_index_dynamic`)
*   **対象:**
    1.  `knowledge/` フォルダ内のドキュメント（マニュアル等）。
    2.  `log.txt` （現在進行中の会話ログ）。
*   **特性:** **完全再構築型 (Rebuild Every Time)**。
*   **更新ロジック:**
    *   更新ボタン押下時、毎回ゼロからインデックスを作り直す。
*   **メリット:** マニュアルの修正や削除、直近の会話内容の変化が、即座かつ確実に検索結果に反映される。

## 3. ファイル構成と責務

### `rag_manager.py`
RAG機能の全権を担う司令塔クラス。
*   **`create_or_update_index()`:** 上記のハイブリッドロジックに基づき、インデックスを構築・更新する。
*   **`search(query)`:** 静的・動的の両方のインデックスを検索し、結果を統合して返す。

### フォルダ構造 (`characters/{room_name}/`)
```text
rag_data/
├── faiss_index_static/       # 過去ログ用の巨大なインデックス
├── faiss_index_dynamic/      # 知識・現行ログ用の軽量インデックス
└── processed_static_files.json # 静的インデックスに取り込み済みのファイルリスト
```

## 4. 検索ツールの挙動

### `search_knowledge_base`
*   ユーザーの質問に対して、知識ベース（マニュアル）と過去ログの両方から回答を探す。
*   RAG Manager経由でベクトル検索を行う。

### `search_past_conversations`
*   **キーワード検索 (Grep)**: `tools/memory_tools.py` による従来の実装。
*   **役割:** 「日付」や「固有名詞」など、明確なキーワードがある場合の検索に特化。
*   **出力:** AIによる要約を行わず、**生のログテキスト**をそのまま提示することで、ペルソナの口調や文脈の再現性を最大化している。

## 5. 運用ルール
*   **過去ログの追加:** ファイル名に規則性は不要。`log_archives/` に `.txt` を置くだけでよい。
*   **インデックス更新:** 任意のタイミングでUIの「索引を作成 / 更新」ボタンを押すことで、最新の状態が反映される。