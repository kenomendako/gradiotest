# Nexus Ark 設計ガイド：ルーム中心アーキテクチャ

## 1. 設計思想

Nexus Arkの核心的なアーキテクチャは、「キャラクター（ペルソナ）」という概念から、より柔軟で拡張性の高い**「ルーム（対話の場）」**という概念へと移行した。

この設計の根底にある思想は、**「魂（ペルソナ）」と「器（ルーム）」の完全な分離**である。これにより、ユーザーは特定のAIペルソナという枠組みに縛られることなく、複数人での対話、ナレーターによる物語進行、あるいは単なる思考の壁打ちなど、多様な目的の対話空間を、自由に、そして直感的に創造し、管理することが可能となる。

## 2. 主要な概念

### a. ルーム (Room)
*   **定義:** アプリケーションにおける、全ての対話、記憶、設定の基本単位。
*   **物理的実体:** `characters/`ディレクトリ内の、各サブフォルダ。
*   **役割:** UI上の全ての選択（メインドロップダウン、グループ会話の招待、アラームの通知先など）は、この「ルーム」を単位として行われる。ユーザーが直接的に操作し、認識する対象である。

### b. ペルソナ (Persona)
*   **定義:** AIが応答する際の「役割」「人格」「口調」。
*   **物理的実体:** 各ルームの`SystemPrompt.txt`ファイル。
*   **役割:** ペルソナの定義と管理は、**完全に`SystemPrompt.txt`の内容に委ねられる。** システムは「メインペルソナ」という概念を強制しない。これにより、ユーザーはプロンプトを工夫することで、単一ペルソナ、複数ペルソナの掛け合い、あるいはペルソナを持たないナレーターなど、無限の対話形式を自由に設計できる。

### c. ルーム設定ファイル (`room_config.json`)
*   **定義:** 各ルームの「メタ情報」を管理するための、構造化された設定ファイル。
*   **パス:** `characters/{ルームフォルダ名}/room_config.json`
*   **役割:** いわば、各ルームの「登記簿」。AIの思考には直接影響を与えず、主にNexus ArkのシステムがUI表示や機能のために参照する。
*   **基本構造:**
    ```json
    {
      "version": 1,
      "room_name": "（UIに表示される、自由なルーム名）",
      "user_display_name": "（ユーザーの表示名, デフォルト: 'ユーザー'）",
      "created_at": "（ルーム作成日時のISO 8601形式タイムスタンプ）",
      "description": "（このルームの短い説明）"
    }
    ```

### d. ログ形式 (`log.txt`)
*   **定義:** 全ての対話履歴は、**役割(Role)**と**表示名(Name)**を分離した、新しい形式で記録される。
*   **書式:** `## ROLE:NAME`
*   **役割:**
    *   **ROLE (`AGENT`, `USER`, `SYSTEM`):** システムが内部的にメッセージの種類を確実に判断するための、機械可読な識別子。
    *   **NAME (自由文字列):** UIに実際に表示される、人間可読な話者名。
*   **効果:** この分離により、UI上の没入感を高める自由な名前表示（例：「キャラクターA」「キャラクターB」）と、システムの安定的な動作を、完全に両立させる。

## 3. 後方互換性

既存のルーム（「キャラクター」として作成された古いフォルダ）は、新システムへのシームレスな移行が保証される。
アプリケーションの初回起動時に、`room_config.json`が存在しないルームを検出し、以下のルールで**自動的にファイルを生成**する。

*   `room_name`: **フォルダ名**をそのまま使用する。
*   `user_display_name`: デフォルト値である「ユーザー」を設定する。

これにより、既存ユーザーは、何も意識することなく、これまで通りのルーム名でアプリケーションを使い続けることができる。

## 4. UI/UXの主要な変更点

*   アプリケーション全体の「キャラクター」という表記は、「ルーム」に統一される。
*   左サイドバーに**「🗨️ チャットルームの作成・管理」**メニューが新設され、以下のタブを提供する。
    *   **新規作成:** ルーム名、ユーザー表示名、初期システムプロンプトを入力して、新しい対話空間をゼロから作成する。
    *   **ChatGPTからインポート:** ChatGPTの公式エクスポートデータや、拡張機能で保存したファイルから、過去の対話を新しいルームとして取り込む。
    *   **管理:** 既存ルームの名称や説明の編集、そしてルームそのものの完全な削除を行う。
