# Nexus Ark 機能仕様書：情景生成システム

## 1. 概要と設計思想

情景生成システムは、Nexus Arkの没入感を支える中核機能であり、以下の2つの異なる目的を両立させるために設計されている。

1.  **UIとAIへの状況提示:** ユーザーとAIに、現在の場所の「空気感」や「雰囲気」を伝える、詩的で簡潔な日本語の情景描写を提供する。
2.  **高品質な画像生成:** ユーザーの意図（画風など）を反映し、かつ世界の構造を正確に描写した、高品質な情景画像を生成する。

この2つの目的は、必要とするテキストの性質（物語性 vs 物理的正確性）が根本的に異なる。そのため、本システムは**「UI/AI用の情景描写テキスト」**と**「画像生成AI用のプロンプト」**の生成プロセスを**完全に分離する**という設計思想に基づいている。

この分離を実現しつつ、パフォーマンスを維持するために、目的別に最適化された2種類の高度なキャッシュシステムが導入されている。

## 2. 2つのキャッシュシステム

全てのキャッシュファイルは、キャラクターフォルダ内の`cache/`ディレクトリに集約され、キャラクターごとに管理される。

### a. `cache/scenery.json` （情景描写キャッシュ）

*   **目的:** UIの「現在の情景」欄に表示し、AIが状況を把握するためにシステムプロンプトに含める、**雰囲気重視の日本語テキスト**を保存する。
*   **ファイルパス:** `characters/[キャラクター名]/cache/scenery.json`
*   **データ構造:**
    *   キー: `[場所ID]_[季節]_[時間帯]` （例: `ruined_church_summer_night`）
    *   値: タイムスタンプ、場所の表示名、生成された情景描写テキストを含む辞書。
*   **更新トリガー（キャッシュが無効になる条件）:**
    1.  `world_settings.txt`ファイルが更新された場合。
    2.  最後にキャッシュを生成した時から、**時間帯**（朝・昼・夕・夜）または**季節**が変化した場合。
*   **特性:** 1日の中でも複数回更新される可能性がある、**動的なキャッシュ**。

### b. `cache/image_prompts.json` （画像プロンプトキャッシュ）

*   **目的:** 画像生成AIに渡すための、**構造物や物体の物理的特徴に特化した、翻訳・要約済の英語の指示書テキスト**を保存する。
*   **ファイルパス:** `characters/[キャラクター名]/cache/image_prompts.json`
*   **データ構造:**
    *   場所IDをキーとし、その値として以下の2つを持つ辞書。
        1.  `source_hash`: プロンプトの元となった空間定義データのハッシュ値（MD5）。
        2.  `prompt_text`: 生成された英語のプロンプト。
*   **更新トリガー（キャッシュが無効になる条件）:**
    1.  `world_settings.txt`内の、**その場所に対応するセクションの定義が変更された**場合のみ。これは、空間定義データから計算したハッシュ値と、キャッシュに保存されている`source_hash`の不一致によって検知される。
*   **特性:** `world_settings.txt`が変更されない限り、時間や季節が経過しても内容は変わらない、**静的なキャッシュ**。

## 3. 処理フロー

### a. 情景描写の表示（移動、更新、チャット送信時）

1.  `agent/graph.py`内の`generate_scenery_context`関数が呼び出される。
2.  現在の場所ID、季節、時間帯からキャッシュキーを生成する。
3.  `cache/scenery.json`を読み込み、キーが存在し、かつ`world_settings.txt`が更新されていないかチェックする。
4.  **キャッシュが有効な場合:** キャッシュされたテキストを即座に返す。
5.  **キャッシュが無効な場合:** `gemini-2.5-flash`を呼び出し、新しい情景描写を生成。その結果を`cache/scenery.json`に保存してから返す。

### b. 情景画像の生成

1.  UIの「情景画像を生成 / 更新」ボタンが押され、`ui_handlers.py`内の`handle_generate_or_regenerate_scenery_image`関数が呼び出される。
2.  現在の場所IDに対応する空間定義（`space_data`）を`world_settings.txt`から読み込む。
3.  `space_data`からハッシュ値を計算する。
4.  `cache/image_prompts.json`を読み込み、保存されているハッシュ値と比較する。
5.  **キャッシュが有効な場合:** キャッシュされた英語のプロンプトテキストを直接利用する。
6.  **キャッシュが無効な場合:**
    a. `description`キーを除いた`space_data`をJSON文字列に変換する。
    b. **翻訳・要約AI（`gemini-2.5-flash`）**を呼び出し、JSONデータを画像生成に最適な英語の視覚的指示書に変換させる。
    c. 生成された英語プロンプトと新しいハッシュ値を`cache/image_prompts.json`に保存する。
7.  取得（または生成）した英語の構造プロンプトに、現在の季節、時間帯、UIで選択された画風を動的に結合し、最終的なプロンプトを完成させる。
8.  **画像生成AI（`gemini-2.0-flash-preview-image-generation`）**に最終プロンプトを渡し、画像を生成・保存する。

## 4. 関連ファイル

このシステムの挙動は、主に以下のファイルによって制御されている。

*   **`ui_handlers.py`:** UIからの画像生成リクエストを受け付け、キャッシュ管理とプロンプト生成の全体の流れを制御する。
*   **`agent/graph.py`:** UI/AI向けの情景描写テキストを生成し、キャッシュを管理する。
*   **`utils.py`:** キャッシュファイルの読み書き、季節・時間帯の判定、画像ファイルの検索など、共通の補助機能を提供する。
*   **`character_manager.py`:** 新しいキャラクターが作成された際に、空のキャッシュファイルを初期生成する。
