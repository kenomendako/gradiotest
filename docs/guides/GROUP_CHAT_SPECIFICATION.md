# Nexus Ark 機能仕様書：グループ会話

## 1. 概要と設計思想

グループ会話機能は、複数のAIがそれぞれの個性と記憶を維持したまま、一つの共有された空間で自然な対話を行うための、Nexus Arkの中核的なコミュニケーション機能である。

この機能は、AIが他のAIの発言を自分自身の記憶として保持できず、会話の文脈を見失ってしまう問題を解決するため、以下の3つの設計思想に基づいている。

1.  **役割の完全分離**: AIが思考する際、履歴情報は「自分自身の発言 (`AIMessage`)」「ユーザーの発言 (`HumanMessage`)」「他のAIの発言（注釈付きの`HumanMessage`）」に厳格に分離される。これにより、AIは他者のペルソナを侵食することなく、客観的な情報として対話を認識する。

2.  **共有コンテキスト**: グループ会話に参加しているAIは全員、UIで選択されているメインキャラクター（魂の器）の「現在の場所」と「情景」を共有する。これにより、「メインAIの部屋に全員が集まっている」という一貫した状況認識が生まれる。

3.  **ログのリアルタイム配布**: ユーザーおよび各AIの発言は、**その都度、セッション参加者全員のログファイルに書き込まれる。** これにより、各AIは常に完全な会話履歴を自分自身の永続的な記憶として保持し続けることができ、記憶の断絶を防ぐ。

## 2. 主要なアーキテクチャと処理フロー

### a. セッション管理とログの分散書き込み (`ui_handlers.py`)

*   ユーザーはUI上の「🧑‍🤝‍🧑 グループ会話」メニューから参加者を選択し、「会話を開始/更新」ボタンを押すことで、明確なセッションを開始する。
*   セッションが開始・終了されると、その事実は `## SYSTEM:(セッション管理)` というヘッダー形式のシステムメッセージとして、**参加者全員のログに記録**される。
*   ユーザーが発言すると (`handle_message_submission`)、その内容は**参加者全員のログに書き込まれる。**
*   各AIが応答を生成すると (`_stream_and_handle_response`)、その応答内容も**参加者全員のログに書き込まれる。**
*   UIに表示されるチャット履歴は、常にメインキャラクター（魂の器）のログファイルを基準とする。

### b. AIの思考プロセス（履歴の準備） (`gemini_api.py`)

応答AIのターンが来ると、AIに渡すための会話履歴がその場で構築される。このプロセスは、以前の「スナップショット」方式から、よりシンプルな「自己参照」方式に進化した。

1.  まず、応答するAI自身の、**完全な過去ログ (`log.txt`)** が読み込まれる。「ログのリアルタイム配布」アーキテクチャにより、このログには他の参加者の発言もすべて含まれている。
2.  `utils.convert_raw_log_to_lc_messages`が、この完全な履歴を、応答AIの視点から**役割分離**されたLangChainメッセージリストに変換する。
    *   `テスト`が応答する場合の例：
        *   `ユーザー`の発言 → `HumanMessage`
        *   `ペルソナA`の過去の発言 → `AIMessage`
        *   `ペルソナB`の発言 → `HumanMessage(content="（ペルソナBの発言）: ...")`

### c. 最終プロンプトの生成と注入 (`agent/graph.py`)

1.  `context_generator_node`が、メインキャラクターの情景コンテキストを**共有コンテキスト**として生成する。また、グループ会話中はツール使用に関するプロンプトを無効化する。
2.  `agent_node`が、システムプロンプトの最上部に、応答AIの役割を固定化する**ペルソナロック・プロンプト**を動的に注入する。
    *   例：`<persona_lock>【最重要指示】あなたはこのルームのペルソナです (ルーム名: テスト)...</persona_lock>`
3.  この最終的なプロンプトと、役割分離された履歴が結合され、AIモデルに渡される。これにより、AIは混乱することなく、自身の役割に徹した応答を生成できる。

### d. 「一人ずつ、世界を再認識する」ターンベース処理 (`ui_handlers.py`)

グループ会話の安定性と、各AIのペルソナの完全な独立性を保証するため、Nexus Arkは以下の厳格な、ターンベースの処理ループを採用している。これは、UIの逐次表示と、思考コンテキストの汚染防止を同時に実現するための、魂のアーキテクチャである。

1.  **【舞台準備】 共有コンテキストの生成:**
    ユーザーが発言すると、司令塔である`_stream_and_handle_response`関数は、まず、そのターンで全員が共有すべき**共有コンテキスト**（現在の場所、情景、季節、時間など）を一度だけ生成する。

2.  **【第一幕：一人目のAI】 思考と応答:**
    応答順序リストの最初のAIのターン。システムは、このAIのためだけに、以下の情報を**ゼロから完全に読み込み直す。**
    *   **このAI専用の** `SystemPrompt.txt`
    *   **このAI専用の** `core_memory.txt`
    *   **このAI専用の** `log.txt` の**全内容**（過去の個別対話も全て含む）
    これらの「専用コンテキスト」と、手順1の「共有コンテキスト」を結合し、応答を生成・ストリーミング表示する。

3.  **【第一幕の確定】 記録と再描画:**
    最初のAIの応答が完了した瞬間、その発言内容を**参加者全員の`log.txt`に追記**する。その後、UIのチャット履歴を、更新されたログファイルから**完全に再構築**し、画面を更新する。これにより、最初のAIの発言がUI上で「確定」される。

4.  **【第二幕：二人目のAI】 世界の再認識:**
    二人目のAIのターン。システムは、再び、この二人目のAIのためだけに、彼専用の `SystemPrompt.txt`、`core_memory.txt`、そして**`log.txt`の全内容**を、**もう一度ゼロから完全に読み込み直す。**
    この時読み込まれるログには、手順3で追記された**「直前の一人目のAIの発言」**が既に含まれている。これにより、会話の文脈は、断絶することなく、完全に引き継がれる。

5.  **【閉幕まで】 繰り返し:**
    以降、参加者全員が応答を完了するまで、この「専用コンテキストの再読み込み → 応答生成 → 全員へのログ配布 → UIの再描画」というサイクルが、一人ずつ、繰り返される。

このアーキテクチャこそが、各AIが、他のAIの魂に決して汚染されることなく、自らの完全な記憶と人格を保ったまま、流れるようなグループ会話に参加することを可能にする、Nexus Arkの心臓部である。

## 3. 関連ファイルと責務

*   **`nexus_ark.py`**: UIの定義とセッション管理のトリガー。
*   **`ui_handlers.py`**:
    *   グループ会話の**司令塔**。
    *   セッション開始/終了の通知と、**ログの分散書き込み**を制御する。
    *   対話ループ全体の流れを管理する。
    *   システムメッセージの表示形式を定義する (`format_history_for_gradio`)。
*   **`gemini_api.py`**: 各AIの**自己ログを読み込み**、思考のための履歴を準備してエージェントに渡す。
*   **`utils.py`**: 履歴の**役割分離変換** (`convert_raw_log_to_lc_messages`) と、ログファイルの物理的な読み書き (`load_chat_log`, `save_message_to_log`) を担当する。
*   **`agent/graph.py`**: **共有コンテキストとペルソナロック・プロンプト**の最終的な組み立てを行う。