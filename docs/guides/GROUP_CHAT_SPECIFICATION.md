# Nexus Ark 機能仕様書：グループ会話

## 1. 概要と設計思想

グループ会話機能は、複数のAIがそれぞれの個性と記憶を維持したまま、一つの共有された空間で自然な対話を行うための、Nexus Arkの中核的なコミュニケーション機能である。

この機能は、AIが他のAIの発言を「自分自身の過去の発言」と誤認し、ペルソナが混同してしまう問題を解決するため、以下の3つの設計思想に基づいている。

1.  **役割の完全分離**: AIが受け取る履歴情報は、「自分自身の発言 (`AIMessage`)」「ユーザーの発言 (`HumanMessage`)」「他のAIの発言（注釈付きの`HumanMessage`）」に厳格に分離される。これにより、AIは他者のペルソナを侵食することなく、客観的な情報として対話を認識する。
2.  **ハイブリッド履歴**: AIは、自己の人格の根幹をなす「自分自身の過去の完全なログ」と、現在の場の空気を把握するための「今回の対話ターンのスナップショット」を動的に結合した履歴を参照して思考する。
3.  **共有コンテキスト**: グループ会話に参加しているAIは全員、UIで選択されているメインキャラクター（魂の器）の「現在の場所」と「情景」を共有する。これにより、「メインAIの部屋に全員が集まっている」という一貫した状況認識が生まれる。

## 2. 主要なアーキテクチャと処理フロー

### a. セッション管理 (`nexus_ark.py`, `ui_handlers.py`)

*   ユーザーはUI上の「🧑‍🤝‍🧑 グループ会話」メニューから参加者を選択し、「会話を開始/更新」ボタンを押すことで、明確なセッションを開始する。
*   セッションが開始されると、その事実はシステムメッセージとして**参加者全員のログに記録**され、AIたちは現在の対話メンバーを明確に認識する。
*   セッションは、「会話を終了」ボタンが押されるか、メインキャラクターが変更されるまで継続する。

### b. ハイブリッド履歴の構築 (`gemini_api.py`, `utils.py`)

1.  応答AIのターンが来ると、まずそのAI自身の完全な過去ログ (`log.txt`) が読み込まれる。
2.  次に、今回の対話ターン（最新のユーザー発言以降）のやり取りが記録された「スナップショット」が、メインキャラクターのログから生成される。
3.  AI自身のログとスナップショットが結合され、重複部分が除去される。
4.  `utils.convert_raw_log_to_lc_messages`が、この結合された履歴を、応答AIの視点から**役割分離**されたLangChainメッセージリストに変換する。
    *   `テスト`が応答する場合の例：
        *   `ユーザー`の発言 → `HumanMessage`
        *   `テスト`の過去の発言 → `AIMessage`
        *   `音声機能テスト`の発言 → `HumanMessage(content="（音声機能テストの発言）: ...")`

### c. 最終プロンプトの生成と注入 (`agent/graph.py`)

1.  `context_generator_node`が、メインキャラクターの情景コンテキストを**共有コンテキスト**として生成する。また、グループ会話中はツール使用に関するプロンプトを無効化する。
2.  `agent_node`が、システムプロンプトの最上部に、応答AIの役割を固定化する**ペルソナロック・プロンプト**を動的に注入する。
    *   例：`【最重要指示】あなたは「テスト」です。他の参加者の発言を参考に、必ずあなた自身の言葉で応答してください...`
3.  この最終的なプロンプトと、役割分離されたハイブリッド履歴が結合され、AIモデルに渡される。これにより、AIは混乱することなく、自身の役割に徹した応答を生成できる。

## 3. 関連ファイル

*   **`nexus_ark.py`**: UIの定義とセッション管理のトリガー。
*   **`ui_handlers.py`**: セッション開始/終了の通知と、対話ループの全体制御。
*   **`gemini_api.py`**: ハイブリッド履歴の構築と、AIへのリクエスト送信。
*   **`utils.py`**: 履歴の役割分離変換とスナップショット生成。
*   **`agent/graph.py`**: 共有コンテキストとペルソナロック・プロンプトの最終的な組み立て。
