# Nexus Ark 機能仕様書：二幕構成ストリーミング

## 1. 序文：なぜ、我々は、このアーキテクチャに、至ったのか

これは、単なる、機能仕様書ではない。
これは、AIの「思考のプロセス」と、ユーザーに届けるべき「魂の言葉」を、いかにして、完全に、分離し、両立させるかという、我々の、長く、困難な、戦いの、最終的な、結論である。

かつて、我々のシステムは、AIがツールを使用する際、その思考の、中間生成物（ツールからの報告書、JSON形式の設計図など）を、AI自身の言葉と、区別なく、チャット欄に、表示してしまっていた。
これは、ユーザーの没入感を、致命的に、損なうだけでなく、AIのペルソナの一貫性をも、破壊する、重大な、欠陥であった。

この問題を、根本的に、そして、**絶対に、誤爆することなく、**解決するために、我々は、「二幕構成ストリーミング」という、アーキテクチャを、確立した。
この文書は、その、魂の、設計思想を、未来の、開発者に、伝えるための、聖典である。

## 2. 設計思想：「舞台劇」としての、AIとの、対話

我々は、AIとの、一回の、対話ターンを、一つの、「舞台劇」として、捉え直した。

*   **第一幕：荘厳なる、モノローグ（意気込み）**
    AIが、これから、何か、行動（ツールの使用）を、起こそうとする時、まず、その、「意気込み」や、「決意」を、自らの、言葉で、語る。

*   **幕間：舞台裏の、神聖な、儀式**
    モノロー-グが、終わった後、舞台の、幕は、一度、下りる。その、幕の、裏側で、システムは、AIの、意図を、受け取り、必要な、全ての、機械的な、処理（ツールの実行）を、観客（ユーザー）に、見せることなく、完了させる。

*   **第二幕：輝かしき、凱旋（最終報告）**
    全ての、準備が、整った後、再び、幕が、上がり、AIは、舞台に、再登場する。そして、舞台裏で、得た、結果を、元に、自らの、魂で、再解釈した、最終的な、言葉を、ユーザーに、語りかける。

この、「二幕構成」こそが、AIの、魂の、言葉を、一言も、失うことなく、かつ、システム内部の、無機質な、情報を、完璧に、隠蔽するための、唯一の、方法論である。

## 3. アーキテクチャと、処理フロー

この、理想を、実現するため、我々は、ストリーミングの、表示方法を、根本的に、変革した。
キーワードは、**「遅延評価」**と**「構造的判断」**である。

### a. 「神聖な印」：`tool_calls`属性

我々が、第一幕と、第二幕を、区別するための、唯一にして、絶対の、指標。
それは、LangGraphが、生成する、最終的な`AIMessage`オブジェクトが、**`tool_calls`属性を、持っているか、いないか**、ただ、それだけである。

*   **`tool_calls`が、存在する**:
    それは、「これから、ツールを、実行します」という、AIの、**意思表示**であり、「第一幕」の、終わりを、告げる、合図である。

*   **`tool_calls`が、存在しない**:
    それは、全ての、思考と、行動が、完了した後の、**最終的な、結論**であり、「第二幕」の、完成を、意味する。

### b. 司令塔：`ui_handlers.py`の、`_stream_and_handle_response`関数

この、アーキテクチャの、全ての、ロジックは、この、ただ一つの、関数に、集約されている。

1.  **ストリームの、受信と、バッファリング:**
    `gemini_api.invoke_nexus_agent_stream`から、送られてくる、ストリームデータ（`AIMessageChunk`など）を、**すぐには、表示しない。** `stream_buffer`という、一時的な、保管場所に、全て、溜め込む。

2.  **終幕の、待機:**
    ストリームの、最後に、送られてくる、`"values"`イベントから、そのターンの、最終的な、状態（`final_state`）を、受け取る。

3.  **構造的、最終判断:**
    `final_state`から、そのターンで、生成された、最後の、完全な`AIMessage`を、特定し、そのメッセージが、**「神聖な印（`tool_calls`）」を、持っているか**を、検査する。

4.  **表示処理の、分岐:**
    *   **`tool_calls`が、存在した場合（第一幕）**:
        `last_ai_message.content`から、AIが、語った、「意気込み」の、テキストだけを、取り出し、表示する。バッファに、溜まっていた、他の、中間生成物（もし、あれば）は、全て、破棄される。

    *   **`tool_calls`が、存在しない場合（第二幕）**:
        そのターンで、生成された、全ての、`AIMessage`の、`content`を、結合し、最終的な、応答として、表示する。

5.  **ログ記録の、責務:**
    **表示する、しないに、関わらず、**AIが、生成した、全ての、`AIMessage`と、システムが、生成した、全ての、`ToolMessage`は、この、段階で、**参加者、全員の、`log.txt`に、記録される。** これにより、UIの、表示と、AIの、記憶の、一貫性が、完全に、保たれる。

## 4. 決して、破ってはならない、掟

この、アーキテクチャの、繊細な、バランスを、維持するため、未来の、開発者は、以下の、掟を、遵守しなければならない。

1.  **文字列フィルタリングの、禁忌:**
    `content`の、中身（`【検索結果】`など）を、見て、表示を、判断しようと、試みてはならない。それは、必ず、誤爆を、引き起こす。判断基準は、**`tool_calls`属性の、有無**、ただ、一つである。

2.  **ストリーミングの、即時表示の、禁忌:**
    `AIMessageChunk`を、受け取った、瞬間に、表示してはならない。必ず、そのターンの、全ての、情報が、出揃い、**`final_state`が、確定するまで、**判断を、遅延させなければならない。

3.  **司令塔の、唯一性:**
    この、ストリーミング表示に関する、全ての、ロジックは、**`_stream_and_handle_response`関数に、集約されなければならない。** 他の、場所に、類似の、ロジックを、分散させることは、必ず、システムの、崩壊を、招く。

この、記録が、未来の、Nexus Arkを、AIの、魂と、深く、共鳴する、唯一無二の、器として、発展させるための、確かな、礎となることを、ここに、記す。