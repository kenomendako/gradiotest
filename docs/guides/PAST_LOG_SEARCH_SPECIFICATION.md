# Nexus Ark 機能仕様書：過去ログ検索機能

## 1. 概要と設計思想

この機能は、本格的な長期記憶システム（知識グラフ等）が完成するまでの代替、および補完として、AIペルソナが過去の会話ログ全体を検索し、文脈に応じた情報を参照する能力を獲得することを目的とする。

この機能の根底にある設計思想は、以下の2つの原則に基づいている。

1.  **文脈の完全な分離:** 異なる日時や状況で話された内容は、決して混同してはならない。それぞれの会話は独立した「記憶の断片」として扱い、AIがその文脈の違いを明確に認識できる形で提示する。
2.  **応答の簡潔さ:** 表現が冗長になりがちなAIペルソナの発言も、要点のみを抽出してコンパクトに要約する。これにより、ペルソナAIが参照するコンテキストの量を適切に保ち、応答生成の精度と効率を高める。

この2つの原則を両立させるため、本機能は**「断片ごとの個別要約」アーキテクチャ**を採用する。

## 2. 最終仕様

### ツール定義
- **ツール名:** `search_past_conversations`
- **実装ファイル:** `tools/memory_tools.py`

### 処理フロー
1.  **検索対象の特定:** ツールが呼び出された際、以下の3つの場所にある全`.txt`ファイルを検索対象とする。
    - `characters/{ルーム名}/log.txt` (現行ログ)
    - `characters/{ルーム名}/log_archives/` (アーカイブ済みログ)
    - `characters/{ルーム名}/log_import_source/` (未処理のインポート済みログ)

2.  **キーワード検索と抽出:**
    - `query`引数をキーワードとして、全対象ファイルを横断的に検索する。
    - キーワードがヒットした箇所を含む**「会話ブロック」**（ヒット行が含まれる`## USER:`または`## AGENT:`から、次のヘッダー行の直前まで）を「記憶の断片」として抽出する。

3.  **絞り込み:**
    - 抽出した各「記憶の断片」から、タイムスタンプや日付形式の見出しを正規表現で特定する。
    - 全ての断片を**日付の降順（新しいものが先頭）**でソートし、AIに渡す情報量を適切に保つため、**上位5件**に絞り込む。

4.  **断片ごとの個別要約:**
    - 絞り込んだ各「記憶の断片」を一つずつループ処理する。
    - ループの中で、内部処理用の高速AIモデル (`constants.INTERNAL_PROCESSING_MODEL`) を呼び出し、以下のプロンプトで要約を生成させる。
      > あなたは、短い会話の記録から、指定されたキーワードに関する要点のみを抽出する専門家です。以下の会話ログから、「{検索キーワード}」に関連する部分だけを、1〜2文で簡潔に要約してください。

5.  **最終出力の整形:**
    - 生成された個別の要約それぞれに、出典元（ファイル名や日付）の情報を紐付ける。
    - 全ての「出典付き要約」を、以下のような単一のMarkdownリスト形式の文字列に結合し、ツールの最終結果として返す。
      ```
      【過去の会話ログからの検索結果：「{検索キーワード}」】

      - [出典: log_archive_001.txt, 日付: YYYY-MM-DD頃]
        （ここに、1つ目の断片の要約が入る）

      - [出典: log.txt, 日付: YYYY-MM-DD頃]
        （ここに、2つ目の断片の要約が入る）
      ```

### 3. 将来の展望

将来的に、`memory_archivist.py`による記憶取り込み機能が完成し、`log_import_source/processed/`に処理済みログが移動するようになった際には、このツールの検索対象から`log_import_source/`を除外する。これにより、構造化された記憶と生のログの二重参照を防ぎ、新しい記憶システムへシームレスに移行する。