# Nexus Ark 機能仕様書：インポートシステム

## 1. 概要と設計思想

インポートシステムは、ChatGPTやClaudeなど、外部のプラットフォームで生まれた対話の記憶を、Nexus Arkのルームとして取り込むための中核機能である。

このシステムの設計思想は、**「専門化」**と**「汎用性」**の両立にある。

1.  **専門化:** 公式が提供するエクスポートデータ（ChatGPT, Claude）のように、構造が明確で信頼性の高い形式については、それぞれに最適化された**専用のパーサー**を用意する。これにより、メタデータ（タイトル、ユーザー名など）の自動抽出や、複雑なデータ構造への確実な対応を保証する。

2.  **汎用性:** ChatGPT Exporterのような非公式ツールや、ユーザーが手動で保存したテキストファイルなど、形式が不定なデータについては、**ユーザーが「話者ヘッダー」を指定**することで、柔軟にインポートできる**汎用のパーサー**を提供する。

## 2. アーキテクチャ

本機能は、UI、UIハンドラ、そして複数のインポーターモジュールが連携することで実現される。

### a. UIレイアウト (`nexus_ark.py`)
-   「チャットルームの作成・管理」→「インポート」タブ内に、インポート元に応じたアコーディオン(`gr.Accordion`)として各機能が配置される。
-   これにより、将来的に対応形式が増えても、UIが煩雑になることなく拡張できる。

### b. UIハンドラ (`ui_handlers.py`)
-   **司令塔**としての役割を担う。
-   ファイルのアップロードを検知し、適切なメタデータパーサーを呼び出してUIフォームを事前入力する。
-   「インポート実行」ボタンが押された際に、UIから受け取った情報（ファイルパス、ルーム名、話者ヘッダー等）を、対応するバックエンドのインポーターモジュールに引き渡す。
-   インポーターからの処理結果（成功 or エラーコード）を受け取り、ユーザーに`gr.Info`や`gr.Warning`でフィードバックを返す。

### c. バックエンド・インポーター
-   **`chatgpt_importer.py`:** ChatGPT公式の`conversations.json`形式の解析を専門に担当する。`ijson`ライブラリを使用し、巨大なファイルでもメモリを圧迫することなくストリーミング処理を行う。
-   **`claude_importer.py`:** Claude公式の`conversations.json`形式の解析を専門に担当する。`ijson`を使用。
-   **`generic_importer.py`:**
    -   ChatGPT Exporterが出力するJSON/MD/TXT形式のメタデータ（タイトル等）とヘッダーの自動検出を行う。
    -   上記以外のファイルについては、ユーザーが指定した話者ヘッダーに基づき、正規表現を用いてテキストを機械的に分割し、ログ形式に変換する。
    -   特定のフッター文字列（`Powered by ...`など）を除去する機能も持つ。

## 3. 将来の開発者へのガイド

新しいインポート形式（例: `SomeApp`）に対応する場合、以下の手順で行う。

1.  `someapp_importer.py`を新設し、データ変換ロジックを実装する。
2.  `nexus_ark.py`の「インポート」タブ内に、`gr.Accordion("🟩 SomeApp (公式)")`を追加し、専用のUIコンポーネントを配置する。
3.  `ui_handlers.py`に`handle_someapp_...`のようなイベントハンドラ関数群を追加し、UIと`someapp_importer.py`を連携させる。
4.  `nexus_ark.py`で、新しいUIコンポーネントとハンドラを接続する。