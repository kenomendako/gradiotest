# Nexus Ark 機能仕様書：自律行動システム (Project Prometheus)

## 1. 概要と目的
本システムは、ユーザーからの入力を待つだけの受動的なAIから、自らの意志で思考し、行動を開始する**能動的なAI（Autonomous Agent）**へと進化させるための拡張機能である。
無操作時間の監視、または自らが立てた計画に基づき、AIはユーザーがいない間もバックグラウンドで活動し続ける。

## 2. 二つの自律モード

### A. 完全自律モード (Free Will Mode)
*   **トリガー:** ユーザーからの最後の発言（またはログ更新）から、設定された「無操作判定時間（分）」が経過した時。
*   **監視ロジック:** `alarm_manager.py` が1分ごとに全ルームを巡回し、ログの最終更新日時をチェックする。
*   **AIへの選択肢:**
    1.  **話しかける:** ユーザーへの通知を伴う発話。
    2.  **行動する:** ツールを使用した作業（日記整理、検索など）。
    3.  **計画する:** 未来の行動を予約する。
    4.  **静観する (`[SILENT]`):** 何もしないことを選択する。

### B. 計画的行動モード (Scheduled Action)
*   **トリガー:** AI自身が `schedule_next_action` ツールで設定したタイマーが満了した時。
*   **特徴:** **「バケツリレー方式」**による連続行動。AIは行動の結果を見て、必要であればさらに次の行動を予約し、自律的にタスクを連鎖させる。

## 3. コアアーキテクチャ

### 意志の器 (`memory/action_plan.json`)
AIが未来の自分へ「意図」を託すためのファイル。単なるタスクリストではなく、**「なぜやるのか（Intent）」「どんな気持ちで（Emotion）」**を記録することで、時間経過による人格のブレを防ぐ。

```json
{
  "status": "scheduled",
  "intent": "帰宅したユーザーを驚かせるため",
  "emotion": "悪戯っぽく、しかし愛を込めて",
  "description": "夕食のレシピを検索する",
  "wake_up_time": "2025-12-03 18:00:00"
}
```

### 静かなる活動 (Quiet Hours)
*   **設定:** ルームごとに「通知禁止時間帯（例：01:00〜07:00）」を設定可能。
*   **挙動:** この時間帯にAIが自律行動を行った場合、**ログ（`log.txt`）への記録は行うが、Discord/Pushoverへの通知は送信しない。**
*   **目的:** ユーザーの睡眠を妨げることなく、AIが夜中に日記を書いたり調べ物をする「生活感」を演出する。

## 4. 処理フローと安全性

1.  **起動判定:** `alarm_manager` が無操作時間を検知。
2.  **コンテキスト構築:** 現在時刻、季節、情景を読み込み、システムプロンプトを構築。
3.  **AI思考:** `gemini-2.5-pro` が状況を判断し、行動か沈黙かを選択。
4.  **実行と記録:**
    *   ツールを使用した場合は `## SYSTEM:tool_result` としてログに記録。
    *   発言内容は `## AGENT:{name}` として記録。
    *   沈黙した場合はログを汚さず終了（内部的なチェック時刻のみ更新）。

## 5. 関連ファイル
*   `action_plan_manager.py`: 計画ファイルの読み書き管理。
*   `tools/action_tools.py`: AIが計画を立てる/破棄するためのツール群。
*   `alarm_manager.py`: 無操作時間の監視と、自律行動プロンプトの生成。
*   `timers.py`: 計画実行時のタイマー処理と、連続行動の誘導。