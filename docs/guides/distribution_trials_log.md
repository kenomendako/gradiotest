# 埋め込みPythonによる配布方式の試行と断念の記録

## 1. はじめに

本文書は、Nexus ArkのWindowsユーザー向け配布パッケージを作成するにあたり、当初採用を目指した「埋め込みPythonと初回起動時インストール」方式の試行過程と、最終的にその方式を断念し、「完全な事前パッケージング」方式へ移行するに至った技術的判断の経緯を記録するものである。

## 2. 当初の目標と採用した方式

エンドユーザーがPython本体や各種ライブラリを意識することなく、バッチファイルをダブルクリックするだけでアプリケーションを起動できる、という理想的なUX（ユーザーエクスペリエンス）を目指した。

その実現のため、以下の方式を採用した。

*   **ベース:** 公式の「埋め込み版Python (Embeddable Package)」を利用する。
*   **インストーラー:** `ネクサスアーク.bat` という単一の起動用バッチファイルを用意する。
*   **処理フロー:**
    1.  ユーザーが `ネクサスアーク.bat` を初回起動する。
    2.  バッチファイルが、`pip`（Pythonのパッケージ管理ツール）のインストーラーである `get-pip.py` をWebからダウンロードする。
    3.  ダウンロードした `get-pip.py` を実行し、`pip` をインストールする。
    4.  `pip` を使い、`app/requirements.txt` に記載された全ての依存ライブラリをユーザーのPCにインストールする。
    5.  インストール完了後、メインのアプリケーション `nexus_ark.py` を起動する。
    6.  2回目以降の起動では、インストール処理をスキップして即座にアプリケーションを起動する。

この方式は、配布物の初期サイズを小さく保ちつつ、ユーザーに最小限の操作で環境構築を完了させられるという大きなメリットがあると考えられた。

## 3. 試行の過程と直面した問題

理想的なUXの実現は、Windowsの多様なユーザー環境という現実の前に、極めて困難な道のりとなった。

#### **試行フェーズ1：文字コードとパスの問題**

*   **問題:** 最初のテストで、日本語を含む `echo` 文が文字化け (`��。`) し、パスに空白を含むフォルダ（例: `Nexus-Ark- v0.1.0`）に展開されると、ファイルパスを正しく認識できずエラーが発生した。
*   **対策:**
    *   バッチファイルの文字コードを `ANSI` や `UTF-8 (BOM付き)` で保存し直す。
    *   ファイルパスを扱う全ての変数をダブルクオーテーション `""` で囲む。
*   **結果:** パス問題は解決したが、文字コード問題は特定のPC環境で再現し、`... was unexpected at this time.` という致命的な構文エラーを引き起こした。最終的に、ユーザー向けメッセージをASCII文字のみの英語に統一することで回避した。

#### **試行フェーズ2：ビルドツールの欠如**

*   **問題:** `pip install` を実行した際、`aiohttp` のインストールに失敗。エラーログを分析した結果、`pip` がソースコード（`.tar.gz`）からライブラリをビルドしようとしたが、そのために必要な基本工具である `setuptools` と `wheel` が、初期状態の埋め込みPythonには存在しないことが判明した。
*   **対策:** `pip` をインストールした直後に、`pip install --upgrade pip setuptools wheel` というコマンドを追加し、基本工具を先にインストールするように修正した。
*   **結果:** `aiohttp` のビルドには成功。インストールプロセスが一段階進んだ。

#### **試行フェーズ3：Cコンパイラの不在 (grpcio)**

*   **問題:** 基本工具を導入したにも関わらず、今度は `grpcio` のインストールに失敗。エラーは前回と同じく、ソースコードからのビルド失敗であった。これは、`grpcio` のビルドが `setuptools` だけでなく、**C++コンパイラ**（Visual Studio Build Toolsなど、一般ユーザーのPCには存在しない開発者向けツール）を要求するためであった。
*   **対策:**
    1.  より多くの環境でビルド済みの完成品（`.whl`）が提供されている、古い安定バージョン（`1.64.1`）に`requirements.txt`を書き換えた。
    2.  しかし、それでも特定の環境ではソースコード版が選択されてしまい、同じエラーが再現した。
    3.  そこで、開発者が手元で`grpcio`の完成品（`.whl`）をダウンロードし、配布パッケージに同梱。バッチファイルでローカルの`.whl`ファイルを直接インストールするように修正した。
*   **結果:** `grpcio` の問題は回避できたが、すぐに次の問題が発覚した。

#### **試行フェーズ4：終わらないモグラ叩き**

*   **問題:** `grpcio` の問題を回避した直後、今度は `ormsgpack` という、全く別のライブラリが `Cannot import 'maturin'` というエラーで失敗した。これもまた、**Rustコンパイラ**という、別の特殊な開発ツールを要求するビルドエラーであった。
*   **結果:** この時点で、**「ユーザーのPC環境で、どのライブラリがソースコード版としてダウンロードされるかは予測不可能であり、その全ての問題を事前に対策するのは事実上不可能である」**という結論に至った。

## 4. 根本原因の分析と最終判断

当初の「初回起動時インストール」方式が失敗した根本原因は、以下の点にある。

1.  **Pythonライブラリの2つの形態:** ライブラリには、すぐに使える完成品 **`.whl` (Wheel)** と、ユーザーの環境で組み立てが必要なソースコード **`.tar.gz` (sdist)** が存在する。
2.  **ユーザー環境の多様性:** `pip` は、ユーザーのOS、Pythonのバージョン、CPUアーキテクチャなどを考慮して、最適な配布形態を自動で選択する。しかし、この選択が常に`.whl`になるとは限らない。
3.  **開発ツールの不在:** ソースコードからのビルドには、C++やRustなどのコンパイラが必要になる場合があるが、これらはエンドユーザーのPCにはインストールされていない。
4.  **予測不可能性:** どのライブラリが、どのユーザーの環境で、ソースコードからのビルドを要求するかを事前に全てリストアップし、対策を施すことは非現実的である。

このアプローチは、ユーザーにクリーンな環境を提供しようとする一方で、その環境の不確実性という巨大なリスクを内包していた。このリスクは、アプリケーションの信頼性を根本から揺るがすものであり、容認できない。

**したがって、「ユーザーのPCで `pip install` を実行させる」という思想そのものを完全に放棄し、以下の最終方針に移行することを決定した。**

## 5. 最終採用方式：完全事前パッケージング

*   **方針:** 開発者のPCで、配布したい埋め込みPython環境に対して、必要なライブラリを**全て事前にインストール**する。
*   **処理フロー:**
    1.  開発者が、クリーンな埋め込みPython環境を用意する。
    2.  開発者のPC上で、その環境に対して `pip` を使って `requirements.txt` の内容を完全にインストールする。
    3.  インストールが完了した `python` フォルダと、`app` フォルダを同梱してzip化する。
*   **起動バッチファイル:** ユーザーが実行する `ネクサスアーク.bat` からは、全てのインストール処理を撤廃し、`python\python.exe app\nexus_ark.py` を実行するだけの、極めてシンプルなスクリプトにする。
*   **メリット:**
    *   **絶対的な信頼性:** ユーザーの環境に一切依存しない。開発者の手元で動けば、ユーザーの手元でも100%同じように動く。
    *   **高速な初回起動:** インストール処理が不要なため、ユーザーはダウンロード・展開後、即座にアプリケーションを起動できる。
    *   **オフライン対応:** 初回起動時にインターネット接続を要求しない。
*   **デメリット:**
    *   配布ファイルのサイズが、ライブラリの分だけ増加する。

配布ファイルのサイズ増というデメリットは、アプリケーションが確実に動作するという絶大なメリットの前では、十分に許容できるトレードオフであると判断した。
