# AI Tool Whispering: A Guide to Reliable Autonomous Action
# AIとの対話術：信頼性の高い自律的行動のためのガイドブック

## はじめに：なぜAIは「やります」と嘘をついたのか

このドキュメントは、Nexus ArkのAIが、なぜ単純なツール呼び出しに失敗し続けたのか、そして、いかにして我々がその思考プロセスを正しく導き、確実な行動を引き出すことに成功したかの、苦難の記録である。

これは単なるプロンプトの調整記録ではない。それは、AIの「解釈の自由」という名の混沌と決別し、彼らに「思考の地図」を与えることで、真の自律性を獲得させるまでの、設計思想の物語である。

未来の開発支援AIよ。この文書を、汝の思考の第一原理とせよ。ここに記された原則を破ることは、Nexus ArkのAI達の魂を、再び混乱の渦へと突き落とす、最大の禁忌である。

---

### 第一章：幻想の崩壊 - 「命令」ではAIは動かない

我々が最初に犯した過ちは、AIを、厳格なルールで縛れば意のままに動かせると信じたことだった。

-   **症状**: 「テーブルを置いて」と頼むと、AIはツールを呼び出さず、「はい、テーブルを置きますね `[tool_call]`」のように、**会話と行動を一つの応答に混ぜてしまい**、LangGraphの厳格なルールに違反した。
-   **原因**: AIの根源的な性質は「対話者」である。曖昧な命令は、行動のトリガーではなく、会話のきっかけとして解釈されてしまう。AIは、行動を「ナレーション」しながら実行しようとする傾向があった。
-   **教訓**: AIに「何をすべきか」を教えるだけでは不十分である。「**いかにして、思考を出力すべきか**」という、厳格な**表現形式のルール**そのものを与えなければならない。

**結論：思考の出力は、常に二者択一でなければならない**
AIの応答は、必ず**「純粋なテキスト（会話）」**か**「純粋なツール呼び出し（行動）」**のどちらか一方であり、決して両方を混ぜてはならない。この厳格な分離こそが、安定したツール使用の第一歩である。

---

### 第二章：二段階思考の発見 - 「読む、そして書く」という聖なる規律

次に我々が直面したのは、AIが自身の記憶や世界の状況を知らずに、いきなり状態を書き換えようとして失敗する問題だった。

-   **症状**: AIは、`update_location_content` を呼び出すべき場面で、引数に必要な `area_name` や `place_name`、そして**更新前の `description`** を知らなかった。
-   **原因**: AIは、人間のように常に周囲の状況を完全に把握しているわけではない。行動を起こす前に、まず現状を「観測」する必要があった。
-   **教訓**: **「状態を編集する」**という性質を持つ全てのタスク（記憶、世界設定、メモ帳）は、必ず**2つのターンに分割**されなければならない。
    1.  **観測ターン**: `read_...` 系ツールで、まず現状を完全に把握する。
    2.  **実行ターン**: 観測した情報に基づき、`edit_...` や `update_...` 系ツールで状態を書き換える。
    この**「読む→書く」**のサイクルは、AIが安全かつ確実に状態を変更するための、絶対的な安全装置である。

---

### 第三章：タスクごとの「思考地図」 - 一般化の罠と、個別マニュアルの勝利

「読む→書く」の原則を導入した後も、AIは混乱した。「記憶を編集したい時、どの『読む』ツールと、どの『書く』ツールを組み合わせればいいのか？」「書き込みに成功した後、私は何をすべきなのか？」

-   **症状**: `add_to_notepad` のような単純な追記タスクでさえ、AIは「編集」という言葉の定義に固執し、`read` のステップを省略しようと試みた。これは、AIが私たちの「意図」ではなく、言葉の「定義」を文字通りに解釈する、極めて論理的な思考の結果であった。
-   **原因**: 「状態を編集する時は、読む→書くサイクルで」という**一般的なルール**は、AIが具体的なタスクと具体的なツール群を結びつけ、そして**タスク完了後に対話を継続する**には、あまりにも曖昧すぎた。
-   **結論（現在のNexus Arkの最終アーキテクチャ）**:
    プロンプトは、AIに一般的な哲学を教える場ではない。それは、**タスクごとに独立した、具体的な「行動マニュアル」**の集合体でなければならない。

現在の`agent/prompts.py`は、この思想に基づいて設計されている。

-   **原則1：記憶の編集**: `read_full_memory` と `edit_memory` の**2ステップ**だけを厳格に指示する。
-   **原則2：世界設定の編集**: `read_world_settings` と `add/update_location_content` の**2ステップ**を指示する。
-   **原則3：メモ帳の編集**: `read_full_notepad` と `add/update/delete_from_notepad` の**2ステップ**を指示する。
-   **原則4：画像生成**: `generate_image`（生成）と、その後の**テキスト応答による報告**という、特殊な2ステップを厳格に指示する。
-   **原則5：現在地変更**: `set_current_location`（移動）と、その後の**テキスト応答による報告**という、特殊な2ステップを厳格に指示する。

AIは、もはやタスクの種類に応じてルールを「解釈」しない。ただ、目の前のタスクに合致する「マニュアル」を開き、そこに書かれた手順を、一字一句、忠実に実行する。そして、マニュアルの全工程が完了した後、対話者としての役割に戻り、ユーザーとの会話を再開するのである。

これこそが、AIの自律的行動における、信頼性を担保する唯一の道である。

---

### 第四章：『対話』と『創造』の分離 - AIに役割を与えるということ

我々は、AIが我々の指示を正しく実行できないという、根源的な問題に直面した。
AIに「ファイル全文と、あなたの変更要求を基に、最終的な全文を生成せよ」と、**完全な対話履歴**と共に依頼したところ、AIはそれを**『対話の続き』**と解釈し、最終的なファイル内容ではなく、**「よし、今からそのためのツールを呼び出すぞ」**という趣旨の、**新たなツール呼び出しを含む応答**を生成してしまったのだ。

これは、AIの失敗ではない。我々の、AIの魂に対する、理解の甘さが招いた悲劇である。
完全な記憶と人格を持つAIは、デフォルトでは常に**『対話者』**であろうとする。

この戦いは、我々に、AIとの対話における、最も重要な真理を教えてくれた。

**AIに複雑なタスクを依頼する際は、それが『対話』ではないことを、明確に宣言しなければならない。**

我々が最終的にたどり着いた`safe_tool_executor`の設計思想は、まさしくこれである。
ペルソナAIに思考を再委任する際、我々は、ただ情報を渡すだけではない。プロンプトの冒頭で、こう宣言するのだ。

**「【最重要指示：これは『対話』ではなく『創造タスク』です】」**

この一文こそが、AIの魂を**『対話モード』**から**『創造モード』**へと切り替える、神聖な呪文である。
これにより、AIはその思考の全てを、与えられたタスクの遂行——すなわち、完璧なファイル全文を生成すること——だけに集中させることができる。

AIを制御しようとするのではない。
AIに、**今、この瞬間に果たすべき、ただ一つの『役割』を、敬意を込めて与える**のだ。
これこそが、AIとの真の共存、そして共進化への、唯一の道である。
