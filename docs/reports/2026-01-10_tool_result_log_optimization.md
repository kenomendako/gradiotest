# ツール結果のログ最適化

**日付**: 2026-01-10
**ブランチ**: `fix/tool-result-log-optimization`
**ステータス**: ✅ 完了

---

## 問題の概要

1/6のWeb巡回ツール稼働以降、API料金が200〜300円台から400円超に増加。分析の結果、ツール結果（Web巡回のコンテンツ要約、記憶検索結果など）がログに蓄積され、毎回のAPI送信トークン数を増やしていたことが原因と判明。

---

## 修正内容

### 1. ツール分類の定義 (`constants.py`)

ツールを2つのカテゴリに分類し、一元管理：

| 分類 | ツール | ログ保存 |
|------|--------|----------|
| **保存必須** | `generate_image` | RAW_RESULT含む（プロンプト再現用） |
| **アナウンスのみ** | 6ツール（下記） | 実行アナウンスのみ保存 |

アナウンスのみ保存するツール:
- `recall_memories` - 記憶検索
- `search_past_conversations` - 過去会話検索
- `check_watchlist` - ウォッチリストチェック
- `web_search_tool` - Web検索
- `tavily_search` - Tavily検索
- `tavily_extract` - Tavily抽出

### 2. ログ保存ロジックの統一（4箇所）

以下のファイルで、ハードコードされたツールリストを `constants.TOOLS_SAVE_ANNOUNCEMENT_ONLY` に置き換え：

- `ui_handlers.py` (1箇所)
- `alarm_manager.py` (2箇所)
- `timers.py` (1箇所)

---

## 変更したファイル

| ファイル | 変更内容 |
|----------|----------|
| `constants.py` | `TOOLS_SAVE_RAW_RESULT`, `TOOLS_SAVE_ANNOUNCEMENT_ONLY` 定数追加 |
| `alarm_manager.py` | 2箇所のツール結果ログ処理を constants 参照に変更 |
| `ui_handlers.py` | ツール結果ログ処理を constants 参照に変更 |
| `timers.py` | ツール結果ログ処理を constants 参照に変更 |

---

## 期待される効果

1. **APIコスト削減**: 長いツール結果（Web巡回結果など）がログに蓄積されなくなり、送信トークン数が減少
2. **ログファイルサイズ削減**: 不要なデータが保存されなくなり、ログ肥大化を防止
3. **保守性向上**: ツール分類が `constants.py` で一元管理され、追加・変更が容易

---

## 注意事項

- Web巡回結果は、ペルソナが研究ノートに分析結果を記録するため、ログに保存しなくても問題なし
- 巡回が実行されたことは「アナウンス」としてログに残るため、不具合時の確認は可能
- 画像生成プロンプトは再現のため引き続き全データを保存

---

*作成日: 2026-01-10*
