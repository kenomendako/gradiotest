# 感情検出改善 & タイムスタンプ抑制レポート

**完了日**: 2026-01-13  
**ブランチ**: `feat/emotion-detection-improvement`

---

## 概要

ペルソナによる感情検出をシステムに内蔵し、追加のAPIコールを削減しました。
また、ペルソナがタイムスタンプを模倣する問題をプロンプトで抑制しました。

---

## 変更点

### Phase 1: システムプロンプト更新

| ファイル | 変更内容 |
|---------|---------|
| `agent/prompts.py` | 感情タグ出力指示（`<user_emotion>カテゴリ</user_emotion>`） |
| `agent/prompts.py` | タイムスタンプ・モデル名の模倣禁止を明記 |

### Phase 2: 感情パース処理

| ファイル | 変更内容 |
|---------|---------|
| `ui_handlers.py` | `<user_emotion>` タグのパースと除去 |
| `ui_handlers.py` | MotivationManagerへの感情反映 |

### Phase 3: フォールバック互換性

| ファイル | 変更内容 |
|---------|---------|
| `motivation_manager.py` | LLM検出カテゴリを統一カテゴリに変換（joy→happy等） |

---

## 検証結果

```
✅ 構文チェック通過
✅ アプリ正常起動
✅ 感情タグ出力確認: "[Emotion] ペルソナ検出の感情を反映: neutral"
✅ 追加APIコールなしで感情検出完了
```

---

## 効果

| 項目 | 以前 | 現在 |
|-----|------|------|
| **感情検出** | 毎回追加LLM呼び出し | ペルソナ応答内で完結 |
| **カテゴリ** | 不一致（joy vs happy等） | 統一カテゴリ |
| **タイムスタンプ模倣** | 発生→除去処理 | プロンプトで抑制 |
