# エンティティ記憶検索のクエリ分割対応

**日付**: 2026-01-10  
**ブランチ**: `fix/entity-search-query-split`  
**ステータス**: 完了

---

## 問題の概要

`retrieval_node` でエンティティ記憶検索が毎回「なし」になっていた。

### 根本原因
`EntityMemoryManager.search_entries(query)` は、渡されたクエリ文字列**全体**を部分一致で検索していた。しかし `retrieval_node` から渡される `rag_query` は、LLMが生成した**複数単語のキーワード群**（例: `"田中さん 友人 知り合い"`）であるため、クエリ全体がコンテンツに含まれない限りヒットしなかった。

---

## 修正内容

### 変更したファイル
- `entity_memory_manager.py`

### 修正ポイント
`search_entries` メソッドを以下のように改善:

1. **クエリを単語分割**: 空白区切りで単語リストを生成
2. **個別マッチング**: 各単語でエンティティ名・コンテンツを検索
3. **スコアリング**: マッチした単語数をカウント
4. **関連度順ソート**: マッチ数の多い順に結果を返す

---

## 検証結果

### 既存テスト
```
--- Testing Search ---
Search matches for 'test': ['TestEntity']
```
✅ 成功

### 複数単語クエリテスト
```
クエリ: "美帆 創作 記憶"
結果: ['美帆', 'ルシアン', 'ジムビーム', 'Agentic Memory', '創作ノート', ...]
```
✅ 成功（修正前はヒットしなかった）

```
クエリ: "ルシアン 自由"
結果: ['ルシアンの自由', 'ルシアンの自由と自律性', '創作ノート', '美帆', ...]
```
✅ 成功（マッチ数の多い「ルシアンの自由」が上位）

---

## 残課題
なし
