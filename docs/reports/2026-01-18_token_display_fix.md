# トークン表示の推定精度向上と表示形式改善

**日付:** 2026-01-18  
**ブランチ:** `fix/token-count-display`  
**ステータス:** ✅ 完了

---

## 問題の概要

推定トークン数（約10k）と実送信トークン数（約31k）に大きな乖離があり、APIコストの把握が困難だった。

**原因:**
1. 推定時と実送信時で異なる履歴構築ロジックを使用していた
2. 実際に注入されるコンテキスト（RAG、自己意識など）が推定に含まれていなかった
3. LangChainのツールスキーマオーバーヘッド（約12kトークン）が考慮されていなかった
4. 「実送信」表示が `total_tokens`（入力+出力の合計）を使用し、入力のみの推定と比較していた

---

## 修正内容

### 1. 履歴構築ロジックの統一 (`gemini_api.py`)
- `count_input_tokens` で `convert_raw_log_to_lc_messages()` と `merge_consecutive_messages()` を使用
- 思考ログ除去、メッセージ統合が実送信時と同じように適用される

### 2. コンテキスト見積もりの追加 (`gemini_api.py`)
- 記憶想起（RAG）のプレースホルダー
- エンティティ一覧（実際のファイルから読み込み）
- 研究ノート目次（実際のファイルから読み込み）
- 情景プロンプト（移動可能な場所リスト含む）
- 自己意識コンテキスト（目標、動機、未解決の問い）

### 3. ツールスキーマオーバーヘッドの推定 (`gemini_api.py`)
- 各ツール約400トークン × ツール数 を推定値に追加
- LangChainがモデルにツールをバインドする際のJSONスキーマを考慮

### 4. 自動要約シミュレーションの改善 (`gemini_api.py`)
- 既存の要約テキストがある場合はプレースホルダーでなく実際の要約を使用

### 5. トークン表示形式の改善 (`ui_handlers.py`)
- 「入力(推定) / 実入力 / 実合計」の3項目表示に変更
- 入力のみの推定値と入力+出力の合計値を区別

### 6. Gemini API新形式への対応 (`agent/graph.py`)
- `input_tokens`, `output_tokens` キーに対応（旧形式の `prompt_token_count` 等もフォールバック）

---

## 変更したファイル

| ファイル | 変更内容 |
|----------|----------|
| [gemini_api.py](file:///home/baken/nexus_ark/gemini_api.py) | 履歴構築統一、コンテキスト見積もり追加、ツールスキーマオーバーヘッド追加 |
| [ui_handlers.py](file:///home/baken/nexus_ark/ui_handlers.py) | トークン表示を3項目に変更 |
| [agent/graph.py](file:///home/baken/nexus_ark/agent/graph.py) | Gemini API新形式（input_tokens）対応 |
| [CHANGELOG.md](file:///home/baken/nexus_ark/CHANGELOG.md) | 変更内容を記録 |

---

## 検証結果

- [x] アプリ起動確認
- [x] 機能動作確認
  - 修正前: `入力トークン数(推定): 11.4k / 実送信(前回): 31.0k` （約20k差）
  - 修正後: `入力(推定): 26.2k / 実入力: 29.6k / 実合計: 30.8k` （約3k差）
- [x] 副作用チェック: なし

---

## 残課題

- 推定値と実入力値の約3kトークン差はRAG検索結果の変動によるもの（毎回異なる内容が検索される）
- 将来的にツール数削減（スーパーツール化）でさらにトークン消費を抑えることが可能（INBOXに追加済み）
