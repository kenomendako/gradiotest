# トークン表示の不整合修正

**日付:** 2026-01-11  
**ブランチ:** `main`  
**ステータス:** ✅ 完了

---

## 問題の概要

1. 「エピソード記憶の参照期間（中期記憶）」を変更しても、推定トークン数が更新されない
2. チャット後に実送信トークン数が表示されない

---

## 修正内容

### 1. エピソード記憶ドロップダウンのパースロジック修正 (`gemini_api.py`)

UIドロップダウンの選択値（`"過去 2週間"`）と、`gemini_api.py` のパースロジック（`"14日間"` を期待）の不一致を修正。

- 正規表現で `"過去 X日"` `"過去 X週間"` `"過去 Xヶ月"` 形式をパースするよう変更
- 日数に応じた推定文字数（300〜3000文字）を計算するロジックを改善

### 2. 実送信トークン数の表示キー名修正 (`ui_handlers.py`)

- `agent/graph.py` は `{"total_tokens": ...}` を返していた
- `ui_handlers.py` の `_format_token_display` は `{"total": ...}` を期待していた
- キー名を `"total"` → `"total_tokens"` に修正

---

## 変更したファイル

- `gemini_api.py` - エピソード記憶期間のパースロジックを修正（L870-927）
- `ui_handlers.py` - 実トークン数表示のキー名を修正（L73）

---

## 検証結果

- [x] アプリ起動確認
- [x] 機能動作確認
  - エピソード記憶期間を変更すると推定トークン数が変化することを確認
  - チャット後に `入力トークン数(推定): 26.7k / 実送信(前回): 25.2k` と表示されることを確認
- [x] validate_wiring.py 実行: 今回の変更に関連するエラーなし（既存の別の問題は存在）

---

## 残課題

なし（本タスクの範囲では完了）
