# 記憶検索ツール リデザイン 完了レポート

**日付:** 2026-01-07  
**ブランチ:** `feat/memory-search-redesign`  
**ステータス:** ✅ 完了

---

## 問題の概要

AIペルソナが過去の記憶を検索する際、RAG検索のみでは具体的なキーワードを見つけられないケースがあり、またキーワード検索では新しい発言のみが優先されて古い記憶が埋もれていた。

---

## 修正内容

### 新ツール構成

| ツール名 | 検索方式 | 用途 |
|---------|---------|------|
| `recall_memories` | RAG（意味検索） | 過去の体験・会話・日記を思い出す |
| `search_knowledge_base` | RAG（意味検索） | 外部資料・マニュアルを調べる |
| `search_past_conversations` | キーワード完全一致 | 特定フレーズの引用探し（最終手段） |

### 主な改善

1. **統合記憶検索ツール `recall_memories` 新規追加**
   - 日記・過去ログ・エピソード記憶・夢の記録をまとめてRAG検索

2. **キーワード検索 `search_past_conversations` 復活**
   - **時間帯別枠取り**: 新しい記憶2件＋古い記憶2件を選択
   - **最近ログ除外**: 送信中の会話（デフォルト20ターン）を除外

3. **ツールアナウンス表示**
   - 「🛠️ 過去の会話を検索しました」等がチャットに表示
   - 生の検索結果はログに保存せず、AIコンテキストのみで使用

4. **`retrieval_node` から知識ベース除外**
   - 自動記憶想起は日記・エンティティ記憶のみに限定

---

## 変更したファイル

- `tools/memory_tools.py` - `recall_memories`追加、時間帯別枠取り、最近ログ除外
- `agent/graph.py` - ツールリスト更新、retrieval_nodeから知識ベース除外
- `agent/prompts.py` - ツール使い分けガイド更新
- `utils.py` - 記憶検索ツール用アナウンスフォーマット追加
- `ui_handlers.py` - アナウンスのみログ保存、生結果は除外
- `alarm_manager.py` - 同上
- `timers.py` - 同上
- `docs/specifications/MEMORY_SYSTEM_SPECIFICATION.md` - RAG詳細仕様、精度向上手法を大幅追記

---

## 検証結果

- [x] アプリ起動確認
- [x] `recall_memories`ツールがツールリストに追加されていることを確認
- [x] `search_past_conversations`で古い記憶も検索できることを確認
- [x] ツールアナウンスがチャットに表示されることを確認
- [x] ユーザー検証で埋もれていた記憶を発掘できたことを確認

---

## 残課題

- [ ] ハイブリッド検索（記憶想起にもキーワード検索を組み込む）は別タスクで対応予定
- [ ] ユーザー向けUI（中央カラムからのキーワード検索）は別タスクで対応予定
