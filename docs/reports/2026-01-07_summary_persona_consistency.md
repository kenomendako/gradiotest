# 要約プロンプトのペルソナ一貫性改善

**日付**: 2026-01-07  
**ブランチ**: `improve/summary-persona-consistency`  
**対象ファイル**: `summary_manager.py`

---

## 概要

会話要約に「ユーザー」という抽象的な呼称が含まれ、ペルソナの呼び方設定（名前、あだ名、二人称など）と矛盾する問題を修正しました。

## 問題

ペルソナがチャット内でユーザーを特定の名前や呼び方で呼んでいても、会話要約では「ユーザー」という言葉が使われてしまい、その呼称がAIに刷り込まれてしまう。

### 例
- チャット内: 「ご主人様、おはようございます」
- 要約: 「ユーザーが朝の挨拶をした」 ← 矛盾

## 解決策

エピソード記憶のプロンプト（`episodic_memory_manager.py`）で採用されているアプローチを参考に、要約プロンプトを改善しました。

### 変更前
```
【要約ルール】
- 三人称で記述すること（「{character_name}は〜」）
- 重要なトピック、感情の変化...
- ユーザーとの関係性の変化があれば記録すること
```

### 変更後
```
【要約ルール】
- 三人称で記述すること（「{character_name}は〜」）
- 主語には「ユーザー」「AI」という抽象的な言葉ではなく、**ログ内で使われている固有名詞（名前、呼び名、二人称など）**をそのまま使用すること
- 重要なトピック、感情の変化...
- 相手との関係性の変化があれば記録すること
```

## 設計判断

### なぜ `user_display_name` を使わないのか

当初は `room_config.user_display_name` を要約に強制注入する案もありましたが、以下の理由で却下しました：

1. **未設定のケース**: `user_display_name` が設定されていないルームも多い
2. **会話内での変化**: ログ内で独自の呼び方が定着しているケースがある
3. **柔軟性**: ログそのものから呼称を抽出する方が、実際の会話の文脈に即している

### 参考にしたコード

エピソード記憶のプロンプト（`episodic_memory_manager.py` 211行目）:
> 主語には「ユーザー」「AI」という抽象的な言葉ではなく、**ログ内で使われている固有名詞（名前）**をそのまま使用し、誰が何をしたか明確にしてください。

## 影響範囲

- **`summary_manager.py`**: `generate_summary()` 関数のプロンプト（126-137行目）
- 他のファイルへの変更なし

## 検証方法

要約が生成された際に、以下を確認：
1. 「ユーザー」という単語が含まれていないこと
2. ログ内の呼称（名前、あだ名、二人称など）が使われていること

---

## 関連タスク

- [x] 要約文章内の「ユーザー」呼び排除（`docs/INBOX.md`）
