# APIキーローテーションの1周制限の実装報告

## 概要
Gemini APIの `ResourceExhausted` (429) エラー発生時の自動ローテーション機能において、利用可能な全てのAPIキーを1周試行した後はリトライを停止する制限を実装しました。これにより、全てのキーが枯渇している場合に無限ループに陥ったり、回復待ちで長時間プロセスが占有されたりすることを防止します。

## 変更内容

### 1. キー選択ロジックの強化 (`config_manager.py`)
- `get_next_available_gemini_key` 関数を拡張し、`excluded_keys`（除外リスト）を受け取れるようにしました。
- 呼び出し側で「既に試したキー」をこのリストに含めることで、同じキーが1回のセッションで二度選ばれることを確実に防ぎます。

### 2. チャット応答時の制限 (`gemini_api.py`)
- `invoke_nexus_agent_stream` 内に `tried_keys` セットを導入しました。
- 429エラーによるローテーションが発生するたびに試行済みキーを記録し、全キーを試しても成功しない場合は「利用可能なすべてのAPIキーを試しましたが、成功しませんでした」というエラーを返して終了します。

### 3. RAG索引更新時の制限 (`rag_manager.py`)
- `RAGManager` クラスに `self.tried_keys` を追加しました。
- 大量のファイルを埋め込むRAG索引更新プロセスにおいて、429エラーが発生した際にキーをローテーションしますが、1つの `RAGManager` インスタンス（1回の更新ジョブ）につき各キーの試行を1回に制限しました。
- 全てのキーで429エラーが発生した場合は、索引更新を安全に中断し、ユーザーに通知します。

## 検証結果
- **ロジック検証**: 模擬的なAPIキー環境にて、除外リストが正しく機能し、全キー試行後に `None` が返されることをスクリプトで確認しました。
- **無限ループ防止**: 全てのキーが枯渇状態（または1周試行済み）になると、即座にエラーメッセージが表示され、処理が停止することを確認しました。

## 影響範囲
- Gemini APIを使用するチャットおよびRAG索引更新機能。
- 他のプロバイダ（Zhipu, OpenAI等）には影響しません（Gemini専用のローテーション機能であるため）。
