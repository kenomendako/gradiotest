# エンティティ記憶 v2 実装レポート

**日付:** 2026-01-11  
**ブランチ:** `feat/entity-memory-v2`  
**ステータス:** ✅ 完了

---

## 問題の概要

エンティティ記憶の自動想起がコンテキストを圧迫し、記録が偏る問題を解決するため、要件定義書（`docs/specs/entity_memory_v2.md`）に基づき2つの機能を実装。

---

## 修正内容

### Phase 1: 目次方式への移行
- 自動想起を廃止し、エンティティ名の一覧のみをシステムプロンプトに含める
- ペルソナが `read_entity_memory` ツールで能動的に取得する形式に変更

### Phase 2: 二層記録システム（影の僕方式）
- 睡眠処理で「影の僕」AI（Flash Lite）が会話から客観的にエンティティ候補を抽出
- 候補にRAG検索で関連記憶を付与
- 次回会話時にペルソナへシステムメッセージとして提案を伝達

---

## 変更したファイル

- `agent/prompts.py` - `{entity_list_section}` プレースホルダを追加
- `agent/graph.py` - 自動想起削除、エンティティ一覧生成、ペンディングメッセージ注入
- `dreaming_manager.py` - 4つの新規メソッド追加（抽出、フォーマット、キュー、取得）
- `ui_handlers.py` - バグ修正：`multimodal_input` のbool型チェック
- `gemini_api.py` - バグ修正：`lookback_days_str` のdict型チェック

---

## 検証結果

- [x] アプリ起動確認
- [x] エンティティ自動想起が無効化されていることを確認
- [x] エンティティ一覧がシステムプロンプトに含まれることを確認
- [x] チャット機能の正常動作を確認

---

## 残課題

- **Gradio警告の調査**: `Unexpected argument. Filling with None.` 警告が大量に発生。機能に影響なしだがINBOXに追加して後日調査。
