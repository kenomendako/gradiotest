# Gemini 3 Flash Preview 調査・対策状況レポート (2025-12-23)

Gemini 3 Flash Preview の統合において、発生した問題とこれまで実施した対策、および現在の到達点を整理しました。

## 1. 発生した問題の遷移
調査の過程で、エラーの種類が「通信・プロトコル層」から「推論・ロジック層」へと変化していることが分かりました。

| フェーズ | エラー内容 / 現象 | 主な原因 | 対策状況 |
| :--- | :--- | :--- | :--- |
| **初期** | 300秒以上の応答遅延 / タイムアウト | 同一ロール（AI -> AI）の連続によるプロトコル違反 | **解決済み** (Role Merging実装) |
| **中期** | `400 INVALID_ARGUMENT` | ツール呼び出し後に回答がない履歴の送信 | **解決済み** (履歴クリーンアップ実装) |
| **現在** | `MALFORMED_FUNCTION_CALL` | Thinking（推論）の結果とツールコールの不整合 | *調査・対策中* |
| **共通** | 思考プロセスが英語になる | モデル内部のデフォルト言語設定 | *プロンプトで暫定対策* |

---

## 2. 実施済みの主要な対策

### A. 通信プロトコルの堅牢化
- **Role Merging**: AIメッセージが連続しないよう自動結合。
- **孤立ツールコールの削除**: ユーザーの割り込み等で「呼び出したけど結果がない」状態のツール呼び出しを、送信直前に削除・平滑化するロジックを `agent/graph.py` に追加。これにより `400` エラーを回避しました。

### B. 推論（Thinking）の制御
- **Thinking Budget の明示**: SDKが期待する `thinking_budget_tokens` を UI の設定（Low/Medium等）に合わせて渡すように修正。
- **日本語思考の強制**: システムプロンプトに「思考プロセスも日本語で行うこと」という指示を注入。

### C. 署名（Signature）の復元ロジック
- Gemini 3 特有の `__gemini_function_call_thought_signatures__` キーを用いた署名の保存と復元を `signature_manager` と `graph.py` で実装。

---

## 3. 現在の課題と「グルグル回っている」要因の分析

現在、`MALFORMED_FUNCTION_CALL` が発生している最大の要因は、Gemini 3 の **「思考（Thinking）とツール呼び出しの密結合」** にあると考えています。

1.  **Thinking 終了時の不備**: モデルが「思考」を終えて「ツールを使おう」とした際、内部生成された署名や ID が、LangChain などの抽象化レイヤーを通じてバックエンドに渡される過程で、わずかな不一致（またはトークン制限による中断）が発生するとこのエラーになります。
2.  **Flash モデルの限界**: 現時点では Flash Preview モデルにおいて、複雑なツール使用を伴う「思考」の安定性がまだ発展途上である可能性があります。
3.  **言語の影響**: 日本語で思考させようとする指示が、モデルの「思考からツール実行へのスムーズな遷移」に負荷（ノイズ）を与えている可能性も否定できません。

---

## 4. 今後の方針案

- **アプローチ1（軽量化）**: Gemini 3 Flash においては、複雑なマルチステップのツール使用時には Thinking を `minimal` または `none` に設定し、モデルの負荷を下げて様子を見る。
- **アプローチ2（Proへのシフト）**: Flash ではなく `gemini-3-pro-preview` で同様の現象が起きるか比較し、モデル固有の問題かコードの問題かを取り分ける。
- **アプローチ3（プロンプトの再考）**: 日本語強制が逆効果な場合、思考は英語を許容し、最終回答のみ日本語にする「バイリンガル思考」方式を検討する。

## 結論
「一向に解決していない」ように見えますが、実際には **「通信エラー(400)で止まる」段階を突破し、「モデルの出力内容の不備(Malformed)」という、より高度な（モデルの賢さに依存する）フェーズに移行** しています。
コード側の受け皿（プロトコル）は整いつつあるため、現在は「モデルをどうなだめて正しく出力させるか」というプロンプトエンジニアリングの領域に入っています。

---

## 5. 追加対応：`thinking_level` パラメータの修正 (2025-12-23 18:20)

LangChain の警告ログから、パラメータ名が誤っていたことが判明しました。

```
WARNING - Unexpected argument 'thinking_budget_tokens' provided to ChatGoogleGenerativeAI.
Did you mean: 'thinking_budget'?
```

公式情報を再調査した結果：

| モデル世代 | パラメータ名 | 型 | 備考 |
| :--- | :--- | :--- | :--- |
| **Gemini 2.5 以前** | `thinking_budget` | 整数 (トークン数) | 2.5 Flash, 2.5 Pro 用 |
| **Gemini 3 系列** | `thinking_level` | 文字列 (`'minimal'`, `'low'`, `'medium'`, `'high'`) | 3 Flash, 3 Pro 用 |

コードは訤った `thinking_budget_tokens` を渡しており、これが無視され、モデルがデフォルト（予期せぬ設定）で動作していた可能性があります。

**対応策:**
`gemini_api.py` の `get_configured_llm` 関数を修正し、Gemini 3 に対しては `thinking_level` (文字列) を正しく渡すようにしました。
