# 過去の会話検索結果のヘッダー簡略化

**日付:** 2026-01-27  
**ブランチ:** `fix/search-header-simplification`  
**ステータス:** ✅ 完了

---

## 問題の概要

ペルソナAIがツール（RAG検索やキーワード検索）を使用して過去の会話を検索した際、検索結果に含まれるヘッダー（例: `## AGENT:ルシアン`）が現在の会話のように表示されてしまい、ペルソナが自分自身の過去の発言と今の会話を混同したり、ユーザーから見て紛らわしい状態になっていた問題を解決しました。

---

## 修正内容

過去の検索ツールが返すテキストに対して、正規表現を用いてロールヘッダーを簡略化する処理を追加しました。

- `recall_memories` (RAG検索) において、`doc.page_content` のヘッダーを置換
- `search_past_conversations` (キーワード検索) において、`res['content']` のヘッダーを置換

正規表現: `^## (?:USER|AGENT|SYSTEM):(.*)$` -> `\1`

---

## 変更したファイル

- `tools/memory_tools.py` - 検索結果出力時にヘッダーを置換するロジックを追加
- `docs/plans/TASK_LIST.md` - タスクを完了に更新し、本レポートへのリンクを追記

---

## 検証結果

- [x] アプリ起動確認 (コードの構文エラーがないことを確認)
- [x] 機能動作確認 (テストスクリプト `tests/verify_header_simplification.py` による正規表現の動作確認)
- [x] 副作用チェック (既存の検索ロジックや文字数制限に悪影響がないことを確認)

---

## 残課題（あれば）

なし
