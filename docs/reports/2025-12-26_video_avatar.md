# 動画アバター機能レポート

**日付:** 2025-12-26  
**ブランチ:** `feat/video-avatar-idle`  
**ステータス:** ✅ 完了

---

## 問題の概要

Grokなどで生成した動画をペルソナのプロフィール表示に使用できるようにしたい。また、AI応答生成中は「思考中」の動画に切り替わる表現を実装したい。

---

## 修正内容

### 1. 動画アバター表示機能
- `gr.Image` から `gr.HTML` に変更し、base64エンコードした動画を `<video>` タグで表示
- 動画ファイル（mp4, webm, gif）が存在すればループ再生、なければ静止画 `profile.png` にフォールバック

### 2. アバターモード切り替え
- ラジオボタンで「静止画」「動画」を選択可能
- モード設定はルームごとに保存

### 3. 待機/思考中アバターのアップロード
- 「待機アバターをアップロード」→ `avatar/idle.mp4` として保存
- 「思考中アバターをアップロード」→ `avatar/thinking.mp4` として保存

### 4. 応答中のアバター自動切り替え（既存実装を活用）
- AI応答生成開始時に `thinking` 状態に切り替え
- 応答完了時に `idle` 状態に復帰

---

## 変更したファイル

- `nexus_ark.py` - アバター変更UI（ラジオボタン、アップロードボタン2つ）追加
- `ui_handlers.py` - `get_avatar_html()` にmode引数追加、`handle_avatar_upload()`、`handle_thinking_avatar_upload()`、`handle_avatar_mode_change()` 追加
- `constants.py` - `AVATAR_DIR` 定数追加（既存）

---

## 検証結果

- [x] アプリ起動確認
- [x] 動画アバター表示確認（ループ再生）
- [x] 静止画モード切り替え確認
- [x] 思考中アバター切り替え確認
- [x] 画像の切り取り問題修正（object-fit: contain）

---

## 残課題

- 将来的な「感情表現」「表情メタデータ」対応は別タスクとして検討
