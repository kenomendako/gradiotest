# エピソード記憶システムの問題修正

**日付:** 2026-01-17  
**ブランチ:** `fix/episodic-memory-issues`  
**ステータス:** ✅ 完了

---

## 問題の概要

エピソード記憶システムに複数の問題が発見された：

1. **絆確認エピソードが「ゴミデータ」化**: `_check_and_create_bonding_episode`が具体的な会話内容を伴わない定型文しか生成しなかった
2. **2026-01-15の日次エピソード記憶が欠落**: 旧形式データ移行時に`time: "00:00:00"`が設定され、ログとのマッチングができなくなっていた
3. **達成エピソードがある日に日次要約が生成されない**: 同じ日付に任意のエピソードがあると追加が拒否されていた
4. **UIで複数エピソードの一部しか表示されない**: 同じ日付の複数エピソードのうち最初の1件のみ表示されていた
5. **ドロップダウンに重複日付が表示される**: 同じ日付が複数回表示されていた
6. **テキストボックスが下にスクロールされる**: 長いテキストを読み込んだ際に自動的に下にスクロールされ、先頭のエピソードが見えなかった

---

## 修正内容

### 1. 絆確認エピソード機能の廃止
- `_check_and_create_bonding_episode`メソッドを削除

### 2. 旧形式データ移行時のスキップロジック追加
- `update_memory_by_session`で`time: "00:00:00"`のセッションをスキップ

### 3. 特殊タイプエピソードの重複判定修正
- `update_memory`: 特殊タイプ（achievement, bonding, discovery）がある日でも日次要約を生成対象に
- `_append_single_episode`: 特殊タイプのエピソードは重複とみなさず追加を許可

### 4. UI表示の改善
- **同じ日付の全エピソードを表示**: `handle_episodic_selection_from_dropdown`を修正
- **タイプ別ラベル表示**: 🏆 目標達成、💕 絆確認、💡 発見、📝 日次要約
- **作成順でソート**: 古いエピソードを先に表示
- **複数エピソードの案内**: 冒頭に「📌 この日には N 件のエピソードがあります」を表示
- **ドロップダウン重複排除**: 3箇所すべてで`set()`を使用して重複を排除

### 5. テキストボックスのスクロール位置修正
- `episodic_detail_text`に`autoscroll=False`を設定

---

## 変更したファイル

| ファイル | 変更内容 |
|---------|---------|
| [motivation_manager.py](file:///home/baken/nexus_ark/motivation_manager.py) | 絆確認エピソード機能を廃止 |
| [episodic_memory_manager.py](file:///home/baken/nexus_ark/episodic_memory_manager.py) | 旧形式スキップ、特殊タイプ重複判定修正 |
| [ui_handlers.py](file:///home/baken/nexus_ark/ui_handlers.py) | 複数エピソード表示、重複排除、ソート |
| [nexus_ark.py](file:///home/baken/nexus_ark/nexus_ark.py) | autoscroll=False設定 |

---

## 検証結果

- [x] コード変更のコミット確認
- [x] 既存の絆確認エピソード削除確認（1件削除）
- [x] 2026-01-15のエピソード記憶生成確認（達成 + 日次要約の2件が表示される）
- [x] ドロップダウンで日付が1回のみ表示されることを確認
- [x] テキストボックスが先頭から表示されることを確認

---

## 残課題

なし
