# ルーム削除バグ修正・安全化レポート

> 日付: 2025-12-25  
> ブランチ: `fix/room-creation-double-notification`

---

## 📋 修正内容

### 1. 新規ルーム作成時の通知2回表示問題

**原因:**
- `handle_create_room`がドロップダウンの`value`を新しいルームに更新
- これにより`room_dropdown.change`イベントが発火
- 各設定コンポーネントの`.change`イベントが連鎖発火
- `handle_save_room_settings`が複数回呼ばれ、通知が重複表示

**解決策（方針C）:**
- 新規ルーム作成後、自動でルームを切り替えないように変更
- ドロップダウンの`choices`のみ更新し、`value`は変更しない
- 通知メッセージに「ルーム選択メニューから切り替えてください」の案内を追加

**修正ファイル:**
- `ui_handlers.py` L1757-1768

---

### 2. ルーム削除の引数配線バグ

**原因:**
- `room_delete_confirmed_state`がinputsに含まれていなかった
- そのため引数の順序がズレ、意図しないルームが削除対象になっていた

**影響:**
- ユーザーが「新規_2」を削除しようとしたが、「ルシアン」のルームが削除された
- 幸い、ファイル権限エラーでフォルダ削除は失敗したが、中身のファイルは消失

**解決策:**
- `nexus_ark.py`: inputsに`room_delete_confirmed_state`を追加
- `ui_handlers.py`: 関数シグネチャの引数順序を修正
- 重複した古い関数定義（L4121-4223）を削除

**修正ファイル:**
- `nexus_ark.py` L1926
- `ui_handlers.py` L1848-1854

---

### 3. ルーム削除の安全化（ゴミ箱移動）

**変更内容:**
- `shutil.rmtree`（完全削除）→ `send2trash`（ゴミ箱移動）に変更
- 誤削除時にWindowsゴミ箱から復元可能に
- 通知メッセージを「ゴミ箱に移動しました。復元が必要な場合はPCのゴミ箱を確認してください。」に変更

**修正ファイル:**
- `room_manager.py` L12, L448-491
- `ui_handlers.py` L6, L1867-1868
- `requirements.txt`: `send2trash>=1.8.0`を追加

---

### 4. キャラクターデータの自動バックアップ

**設定内容:**
- `characters`フォルダにGitリポジトリを初期化
- 毎日午前3:00に自動コミットするタスクスケジューラを登録
- 画像やキャッシュファイルは`.gitignore`で除外

**追加ファイル:**
- `characters/.gitignore`
- `scripts/characters_backup.ps1`

---

## 📚 教訓

1. **Gradioのイベント連鎖**: プログラムによる値の変更もユーザー操作と同様に`.change`イベントを発火させる
2. **引数の順序**: `.change`イベントのトリガーとなるStateは必ずinputsに含め、関数シグネチャと一致させる
3. **安全な削除**: 完全削除ではなくゴミ箱移動を基本とする
4. **バックアップ**: 重要なデータはGitで定期バックアップを取る

---

## ✅ 検証状況

- [x] 新規ルーム作成時の通知が1回のみ表示
- [x] ルーム切り替え時の通知が1回のみ表示（デバウンス対策）
- [x] ルーム削除がゴミ箱に移動（手動確認済み）
- [x] 自動バックアップタスク登録済み
- [x] gemini_api.pyのdatetimeエラー解消
