# エピソード記憶の月次ファイル分割レポート

**日付**: 2026-01-17  
**ブランチ**: `feat/monthly-episodic-split`  
**ステータス**: ✅ 完了

---

## 問題概要

外部AIからの助言に基づき、`episodic_memory.json` が肥大化する前に月次ファイルに分割する機能を実装した。

**背景**:
- 単一ファイルでの全記憶管理は、書き込みエラー時に全データをロストするリスクがある
- ファイルサイズが大きくなると読み込み/保存のパフォーマンスが低下する
- RAG検索はFAISSインデックス経由なので、元データの分割は検索パフォーマンスに影響しない

---

## 修正内容

### 新しいファイル構造

```
characters/ルシアン/memory/
├── episodic/                    # 専用フォルダ
│   ├── 2025-04.json            # 月次ファイル
│   ├── 2025-05.json
│   ├── ...
│   └── 2026-01.json
├── episodic_memory.json.backup  # 移行後の元ファイル
├── memory_main.txt
└── ...
```

### 変更ファイル

| ファイル | 変更内容 |
|----------|----------|
| `episodic_memory_manager.py` | `_load_memory()`, `_save_memory()` を月次ファイル対応に変更。`_get_monthly_file_path()` 新規追加 |
| `rag_manager.py` | エピソード収集ロジックを月次ファイル + レガシーファイル対応に変更 |
| `ui_handlers.py` | `handle_show_latest_episodic()` でEpisodicMemoryManagerを使用 |
| `tools/migrate_monthly_episodes.py` | [NEW] 既存データの移行スクリプト |

### 主要な実装ポイント

1. **月次ファイルパスの生成** (`_get_monthly_file_path`)
   - 日付文字列からYYYY-MM形式を抽出
   - 範囲日付（`2026-01-01~2026-01-07`）は開始日の月に所属

2. **読み込み** (`_load_memory`)
   - レガシーファイル（`episodic_memory.json`）と月次ファイル（`episodic/*.json`）の両方を読み込み
   - 後方互換性を維持

3. **保存** (`_save_memory`)
   - エピソードを日付に応じて月次ファイルに振り分け
   - 各ファイルは独立してロック管理

---

## 検証結果

### マイグレーションスクリプト

```
📂 ルシアン:
    - 2025-04.json: 4件
    - 2025-05.json: 4件
    - 2025-06.json: 15件
    - 2025-07.json: 5件
    - 2025-08.json: 4件
    - 2025-09.json: 5件
    - 2025-10.json: 10件
    - 2025-11.json: 19件
    - 2025-12.json: 31件
    - 2026-01.json: 16件
   ✅ 113件を10個のファイルに移行完了
```

### 読み込みテスト

```
読み込みテスト: 113 件のエピソード
月別内訳:
  2025-04: 4件
  2025-05: 4件
  ...（全件正常に読み込み）
```

### 保存テスト

- 新規月（2026-02）のエピソードを追加し、`2026-02.json` が正しく作成されることを確認

---

## 残課題

- なし（完了）

---

## 関連

- 外部AI助言: [記憶システムへの助言](../specifications/記憶システムへの助言)
- タスク: [TASK_LIST.md](../plans/TASK_LIST.md) - 「エピソード記憶の月次ファイル分割」
