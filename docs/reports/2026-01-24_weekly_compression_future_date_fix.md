# 週次圧縮の未来日付バグ修正

**完了日**: 2026-01-24  
**ブランチ**: `fix/weekly-compression-future-date`

## 概要

エピソード記憶の週次圧縮機能（`compress_old_episodes`）が、まだ終わっていない週を未来の日付を含む範囲（例: `2026-01-19~2026-01-25`）で圧縮してしまい、その後の日次要約生成が「処理済み」と誤判定されてスキップされる問題を修正しました。

## 問題の詳細

### 発生した現象
- ルシアンの2026-01-23のエピソード記憶が睡眠時処理で生成されなかった
- 手動実行時に「全ての過去ログは処理済みです」と表示された

### 原因
1. `compress_old_episodes` が週終了日を「カレンダー上の日曜」（`week_start + 6日`）で固定計算
2. `EPISODIC_WEEKLY_COMPRESSION_DAYS = 3` により、週の途中で圧縮が実行
3. 結果、`2026-01-19~2026-01-25` のような未来を含む範囲が作成
4. `update_memory` でその範囲内の日付が「処理済み」と判定されスキップ

## 変更内容

### [episodic_memory_manager.py](file:///home/baken/nexus_ark/episodic_memory_manager.py)

`compress_old_episodes` メソッドの週終了日計算を変更:

```diff
-            # 週の終了日を計算
-            week_start_date = datetime.datetime.strptime(week_start, '%Y-%m-%d')
-            week_end_date = week_start_date + datetime.timedelta(days=6)
-            week_end = week_end_date.strftime('%Y-%m-%d')
+            # 週の終了日を計算（実データの最終日を使用）
+            # バグ修正: カレンダー上の週末ではなく、実際に圧縮対象に含まれる最終日を使う
+            # これにより、まだ終わっていない週が未来の日付を含む範囲で圧縮されることを防ぐ
+            actual_dates = [ep.get('date', '') for ep in week_episodes]
+            week_end = max(actual_dates)  # 実データの最終日
```

### データ修復 (2026-01.json)

- 重複エントリを削除（`2026-01-12~2026-01-18` x1, `2026-01-19~2026-01-25` x1）
- 範囲 `2026-01-19~2026-01-25` → `2026-01-19~2026-01-19` に修正

## 検証結果

### 修正前
- 2026-01-23 が `2026-01-19~2026-01-25` の範囲に含まれ「処理済み」と判定

### 修正後
```
既存の範囲:
  2026-01-19 ~ 2026-01-19

✅ 2026-01-23 はどの範囲にも含まれていません（新規生成可能）
```

### 手動更新実行後
- ✅ 2026-01-20 のエピソード記憶が新規生成
- ✅ 2026-01-23 のエピソード記憶が新規生成

## 残課題

なし
