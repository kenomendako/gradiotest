# 研究・分析ノートのコンテキスト注入最適化レポート

**日付:** 2026-01-10  
**ブランチ:** `feat/research-notes-rag-optimization`  
**ステータス:** ✅ 完了

---

## 問題の概要

研究・分析ノート（research_notes.md）の全文が毎ターン送信されることによるトークンの過剰消費とコンテキスト圧迫を解消するため、RAG（検索）による長期記憶化と、システムプロンプトの「目次（索引）化」への移行を実施しました。

---

## 修正内容

1. **RAGインデックス化**: `research_notes.md` を記憶索引の更新対象に追加し、`type: "research_notes"` メタデータを付与して検索可能にしました。
2. **システムプロンプトの目次化**: `graph.py` を修正し、全文送信の代わりに最新の見出し（H2レベル）を最大10件表示する「目次」方式に変更しました。
3. **ラベル対応**: 記憶検索ツール（`recall_memories`）の出力で、研究ノート由来の情報に適切なラベルが表示されるようにしました。

---

## 変更したファイル

- `rag_manager.py` - 研究ノートを差分インデックス化の対象に追加。
- `agent/graph.py` - プロンプト生成時に全文ではなく見出しリストを抽出するよう変更。
- `tools/memory_tools.py` - 検索結果の表示ラベルに「研究・分析ノート」を追加。

---

## 検証結果

- [x] RAG収集ロジックの動作確認（research_notes.mdが正しく検出・ハッシュ化されること）
- [x] プロンプト抽出ロジックの動作確認（H2見出しのみが正しく抽出され、ガイド文が表示されること）
- [x] 既存の `read_research_notes` ツールとの整合性（編集時には全文が供給されることの再確認）

---

## 残課題

なし
