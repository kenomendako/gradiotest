# 完了レポート: RAG モデル不整合対策および内部処理モデルの最適化

**日付:** 2026-02-01  
**ブランチ:** `feat/internal-model-settings-reorganization`  
**ステータス:** ✅ 完了

---

## 問題の概要

1.  **RAG モデル不整合**: エンベディングモデルを切り替えた際に、既存の索引と整合性が取れなくなり、検索精度が著しく低下するリスクがあった。
2.  **フォールバックの不透明性**: ローカルモデルが失敗して API にフォールバックした際、ユーザーがそれに気づけないため、予期せぬ API 課金や速度低下を招く恐れがあった。
3.  **内部処理モデルの冗長出力**: Llama 3.1 8B 等の高速なモデルを内部処理（RAG クエリ抽出等）に使用した際、余計な解説が含まれることで RAG 検索の精度が悪化していた。

---

## 修正内容

### 1. RAG 一貫性チェックの実装
- `rag_manager.py` において、索引作成時のモデル ID を `model_info.json` に保存するように変更。
- 検索時に現在のモデル設定と照合し、不一致がある場合は警告を表示する仕組みを導入。
- UI に「🗑️ 索引を初期化して再構築」ボタンを追加し、モデル変更時の安全な再処理を可能にした。

### 2. システム通知（フォールバック警告）の実装
- `utils.py` にグローバルな通知バッファ `SYSTEM_NOTICES` を追加。
- `rag_manager.py`, `llm_factory.py` でフォールバック発生時に通知を追加するように修正。
- `ui_handlers.py` でチャット応答の冒頭にこれらを表示するように統合。

### 3. 内部処理モデルの出力最適化
- `agent/graph.py` の `retrieval_node` において、プロンプトを `SystemMessage` と `HumanMessage` に分離し、抽出形式を厳格に指定。
- 正規表現 (`re.search`) をパースに導入し、前置きが含まれた場合でも確実にキーワードを抽出可能にした。

---

## 変更したファイル

- `utils.py`: システム通知バッファと管理関数の追加。
- `rag_manager.py`: モデル ID 保存、検証ロジック、再構築ハンドラの実装。
- `llm_factory.py`: フォールバック発生時の通知追加。
- `ui_handlers.py`: 索引再構築ハンドラ、チャット画面への通知表示の追加。
- `nexus_ark.py`: 再構築ボタンの UI 配置と配線。
- `agent/graph.py`: RAG クエリ抽出プロンプトとパースロジックの改善。

---

## 検証結果

- [x] **アプリ起動確認**: `python nexus_ark.py` で正常に起動。
- [x] **機能動作確認**:
    - モデル不一致時に警告が表示されることを確認。
    - 「索引を初期化して再構築」で正しくデータが更新されることを確認。
    - Llama 3.1 8B 使用時に、余計な解説があってもキーワードが抽出されることを確認。
- [x] **副作用チェック**:
    - `tools/validate_wiring.py` を実行。一部の `yield` を使用する関数で `Returns 0 items` と報告されますが、これは静的解析ツールがジェネレータを正しく判定できていないための偽陽性であり、実際の動作には影響ないことを確認済み。

---

## 残課題（あれば）

なし。
