# 自律行動の不具合（空応答・発火停止）修正レポート

**日付:** 2026-01-04  
**ブランチ:** `bugfix/autonomous-action-anomaly`  
**ステータス:** ✅ 完了

---

## 問題の概要

睡眠時の記憶整理処理（特に現行ログ索引更新）が長時間実行されると、スケジューラスレッドがブロックされ、以降の自律行動チェックが一切実行されなくなる問題が発生していた。

---

## 修正内容

### 1. 現行ログ索引更新のタイムアウト機構追加
- `alarm_manager.py` の睡眠時記憶整理処理において、現行ログ索引更新に10分のタイムアウトを設定
- `ThreadPoolExecutor` を使用し、処理が完了しない場合も後続処理が継続されるよう保護

### 2. ストリーミング処理の堅牢化
- `agent/graph.py` で空文字や空白のみのチャンクをフィルタリング
- 不要な「空の応答」メッセージ生成を抑制

### 3. クールダウン判定の厳密化
- 動機モデルによるトリガー判定があっても、最終発火からの経過時間をチェック
- `constants.py` に `MIN_AUTONOMOUS_INTERVAL_MINUTES` を追加（デフォルト120分）

### 4. デバッグログの整理
- 冗長なログを削除し、クールダウン中のスキップ時のみログ出力

---

## 変更したファイル

- `alarm_manager.py` - タイムアウト機構追加、クールダウン判定修正、ログ整理
- `agent/graph.py` - 空チャンクフィルタリング強化
- `constants.py` - 自律行動の最小間隔定数追加

---

## 検証結果

- [x] アプリ起動確認
- [x] 自律行動の正常発火を確認（DEBUG ログで判定プロセス追跡）
- [x] 再起動後も発火時刻が維持されることを確認

---

## 残課題

- 現行ログ索引更新が頻繁にタイムアウトする場合は、処理の最適化が必要
