# 階層的エピソード記憶圧縮

**日付:** 2026-01-18  
**ブランチ:** `fix/sleep-episodic-daily-summary`, `feat/hierarchical-episodic-compression`  
**ステータス:** ✅ 完了

---

## 問題の概要

1. **睡眠時処理の日次要約が三人称になる問題** — 廃止されたはずの`update_memory_by_session`が呼ばれていた
2. **長期記憶のAPIコスト問題** — 60日経過後に週次圧縮では、中期記憶が活用されていなかった

---

## 修正内容

### 1. 睡眠時処理の修正
- `alarm_manager.py`: `update_memory_by_session` → `update_memory` に変更

### 2. 階層的圧縮の実装

| 圧縮レベル | 閾値 | 目標文字数 | 変更 |
|-----------|------|-----------|------|
| 日次 | - | 800-1500 | 変更なし |
| 週次 | **3日**経過 | 600 | 60日→3日に短縮 |
| 月次 | **4週**経過 | 800 | **新規追加** |

### 3. プロンプト改善
- 週次・月次圧縮: ペルソナ視点、★マーク（高Arousal）継承、客観的事実重視

---

## 変更したファイル

- `alarm_manager.py` — 日次要約呼び出しに変更、月次圧縮追加
- `episodic_memory_manager.py` — 週次圧縮閾値変更、`compress_weekly_to_monthly`追加
- `constants.py` — 階層的圧縮の定数追加
- `docs/specifications/MEMORY_SYSTEM_SPECIFICATION.md` — 仕様書更新

---

## 効果

| 送信設定 | 概算文字数 | 備考 |
|---------|-----------|------|
| 過去3日 | ~4,500 | 日次3件 |
| 過去1週間 | ~5,100 | 日次3+週次1 |
| 過去1ヶ月 | ~7,000 | 従来比1/6 |
| 過去3ヶ月 | ~9,000 | 実用的な範囲に |

---

## 検証結果

- [x] 構文チェック（全ファイルOK）
- [x] アプリ起動確認（ユーザー確認済み）
- [x] 2026-01-17の日次要約が一人称で生成

---

## 残課題

なし
