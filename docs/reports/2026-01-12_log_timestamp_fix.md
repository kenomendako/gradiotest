# チャット支援のログ修正でタイムスタンプを誤削除する問題の修正 (2026-01-12)

## 概要
チャット支援ツールの「読点修正（ログ修正）」機能を使用した際、AIによる修正後に元のメッセージにあったタイムスタンプが消失してしまう問題を修正しました。

## 原因分析
- **厳密すぎる正規表現**: 以前の修正で導入されたタイムスタンプ抽出用の正規表現が `\n\n` で始まることを前提としていたため、ログの状態（改行が1つしかない、または本文直後にあるなど）によってはマッチングに失敗していました。
- **モデル名の考慮漏れ**: タイムスタンプ末尾に付加される「 | モデル名」の形式が一部考慮されておらず、マッチングが不安定になっていました。
- **単純な結合ロジック**: `\n\n`.join() を使用した結合だったため、抽出に失敗した際に本文の一部として扱われたり、空のパーツが混入して意図しない挙動をしていました。

## 修正内容
### `ui_handlers.py`
- タイムスタンプ抽出用の正規表現を以下のように改善しました：
  `r'(\d{4}-\d{2}-\d{2} \(...\) \d{2}:\d{2}:\d{2}(?: \| .*)?)$'`
  - 文頭の改行指定を削除。
  - モデル名付記（` | .*`）をオプションで包含。
- 再結合時のロジックを明示的な文字列操作に変更し、パーツの有無に応じて適切な改行を挿入するようにしました。

## 検証
- テストスクリプト `tests/verify_timestamp_fix.py` により、多様なログ形式での正常動作を確認済みです。

## 関連ファイル
- `ui_handlers.py`
