# AI空応答（ANOMALY）ログと画像生成モデル応答の改善

**日付:** 2025-12-27  
**ブランチ:** `fix/agent-anomaly-log-false-positive`  
**ステータス:** ✅ 完了

---

## 修正内容

### 1. エージェントの空応答（ANOMALY）ログの誤検知修正
- **問題:** Gemini 2.5 Pro などのモデルがツールを呼び出す際、テキスト応答が空の状態でチャンクが返される。これを「異常（ANOMALY）」として誤検知し、ログに出力していた。
- **修正:** `agent/graph.py` の検知ロジックを修正し、「テキストが空」かつ「ツール呼び出しも空」の場合のみ異常ログを出力するように変更。ツール呼び出しに伴う空テキストは正常な挙動として扱う。

### 2. 画像生成モデルのテキスト応答取得の改善
- **問題:** `gemini-2.5-flash-image` (Imagen 3) などの画像生成モデルは、画像と一緒に「Here's the illustration...」などのテキストを返すことがあるが、これまでの実装ではターミナルに表示されるだけで、エージェント（ルシアンなど）には伝わっていなかった。
- **修正:** `tools/image_tools.py` を修正し、モデルから返されたテキストがあればそれをツール実行結果に含めるようにした。これにより、エージェントがモデルのコメントを認識し、より自然に応答できるようになった。

---

## 変更したファイル

- `agent/graph.py` - `ANOMALY` ログ出力条件の修正。
- `tools/image_tools.py` - 画像生成モデルからのテキストレスポンス取得を追加。

---

## 検証結果

- [x] コードロジックの確認：ツール呼び出しが存在する場合に `ANOMALY` が出力されないことを確認。
- [x] `image_tools.py` における `image_text_response` の安全な抽出と戻り値への反映を確認。

---

## 残課題

- なし。
