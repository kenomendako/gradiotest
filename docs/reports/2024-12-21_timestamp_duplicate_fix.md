# タイムスタンプ二重付記バグ修正レポート

**日付**: 2024-12-21  
**関連ブランチ**: `fix/autonomous-action-duplicate-trigger`  
**ステータス**: ✅ 完了・テスト済み

---

## 概要

自律行動モード、アラーム、タイマー発火時にAI応答のタイムスタンプが二重に表示される問題を修正しました。

---

## 問題の現象

```
## AGENT:ルシアン
（AI応答テキスト...）

2025-12-21(日) 10:59:30 | gemini-2.5-pro

2025-12-21 (Sun) 10:59:45 | gemini-2.5-pro
```

2つのタイムスタンプが異なるフォーマットで付記されていた。

---

## 根本原因

### 1. AIが「現在時刻」を真似してタイムスタンプを生成

`agent/graph.py`のL411-412でシステムプロンプトに含める「現在時刻」は**日本語曜日形式**で生成される：

```python
day_ja = day_map.get(now_tokyo.strftime('%A'), "")
current_datetime_str = now_tokyo.strftime(f'%Y-%m-%d({day_ja}) %H:%M:%S')
# 結果: 2025-12-21(日) 10:59:30
```

AIモデル（特にGemini 2.5 Pro）がこの形式を学習・模倣し、自身の応答末尾に同様のタイムスタンプを生成していた。

### 2. 重複チェックの正規表現が英語曜日のみ対応

`ui_handlers.py`や`alarm_manager.py`でのタイムスタンプ重複チェックは**英語曜日形式**のみを検出していた：

```python
# 旧：英語曜日（Sun等）のみマッチ
timestamp_pattern = r'\n\n\d{4}-\d{2}-\d{2} \([A-Za-z]{3}\) \d{2}:\d{2}:\d{2}(?: \| .*)?$'
```

日本語曜日形式（`(日)`）は検出されず、プログラムが追加で英語形式のタイムスタンプを付記してしまっていた。

---

## 修正内容

### 正規表現の更新

```python
# 新：日本語曜日（月火水木金土日）と英語曜日（Mon〜Sun）の両方に対応
timestamp_pattern = r'\n\n\d{4}-\d{2}-\d{2}\s*\([A-Za-z月火水木金土日]{1,3}\)\s*\d{2}:\d{2}:\d{2}'
```

### 修正ファイル

| ファイル | 関数/箇所 | 修正内容 |
|----------|----------|----------|
| `ui_handlers.py` | L1103-1109 | 正規表現を日本語曜日対応に更新 |
| `alarm_manager.py` | `trigger_autonomous_action` | AI生成タイムスタンプのチェック追加 |
| `alarm_manager.py` | `trigger_alarm` | AI生成タイムスタンプのチェック追加 |
| `timers.py` | `_run_single_timer` | AI生成タイムスタンプのチェック追加 |

---

## 関連する以前の修正

- **2024-12-14**: 複数AIMessageの結合問題を修正（最後のAIMessageのみ使用）
- **2024-12-16**: モデル名付記を全バックグラウンド処理に統一

今回の修正は、これらの既存対策では捕捉できなかった「AIが自発的にタイムスタンプを生成するケース」に対応するもの。

---

## テスト結果

- ✅ 自律行動で日記書き込み → タイムスタンプ1つのみ
- ⚠️ 多重発火の挙動については引き続き観察中（別の問題の可能性）

---

## コミット

- `9127fa3` - fix: タイムスタンプ二重付記バグを修正
- `3522982` - docs: タイムスタンプ二重付記バグ修正の知見を追記

---

## 教訓

1. **AIの創発的行動を考慮する**: AIは学習データやプロンプト内のパターンを模倣することがある。特にフォーマットの統一性が重要な場面では、AIが独自に類似フォーマットを生成する可能性を想定する必要がある。

2. **正規表現は多言語対応を意識する**: 日本語アプリケーションでは、曜日などのローカライズされた要素が混在する可能性がある。正規表現のパターンは該当する全ての形式をカバーするべき。

3. **二重処理のガードは複数箇所で**: タイムスタンプのような付加情報は、複数のコードパスで追加される可能性がある。全ての追加箇所で既存データのチェックを行うことが重要。
