# 有料プランAPIキー保存問題の修正

**日付:** 2025-12-27  
**ブランチ:** `fix/paid-api-key-save`  
**ステータス:** ✅ 完了

---

## 問題の概要

「🔑 APIキー / Webhook管理」の「有料プランのキーを選択」チェックボックスでキーを選択しても、その設定が保存されず、再起動後にリセットされてしまう問題が発生していた。これにより、有料キーを設定しているにもかかわらず画像生成（新モデル）が制限される副作用が生じていた。

---

## 修正内容

### 1. イベントハンドラーの登録
- `nexus_ark.py` において、`paid_keys_checkbox_group` に `change` イベントが登録されていなかったため追加。
- 変更時に `ui_handlers.handle_paid_keys_change` を呼び出すように設定。

### 2. UI連携の修正
- 有料キーの選択状態が変更された際、チャット入力欄のAPIキー選択ドロップダウン（`api_key_dropdown`）の表示（`(Paid)` ラベルの有無）も即座に更新されるようにした。

---

## 変更したファイル

- `nexus_ark.py` - `paid_keys_checkbox_group.change` イベントの追加。

---

## 検証結果

- [x] アプリ起動確認
- [x] 「有料プランのキーを選択」でチェックを入れた際、即座に保存通知（`gr.Info`）が表示されることを確認。
- [x] アプリ再起動後も、選択したキーのチェック状態が保持されていることを確認。
- [x] チャット入力欄のドロップダウンで、有料キーに `(Paid)` ラベルが表示されることを確認。

---

## 残課題

- なし。画像生成ストッパーの仕様については別途検討。
