# 📋 Nexus Ark タスクリスト

**目標**: 年内リリース  
**配布方式**: Portable Python同梱（[distribution_system_plan.md](file:///c:/Users/baken/OneDrive/%E3%83%87%E3%82%B9%E3%82%AF%E3%83%88%E3%83%83%E3%83%97/gradio_github/gradiotest/docs/plans/distribution_system_plan.md) 参照）
**最終更新**: 2025-12-29

---

## 🔴 優先度: クリティカル（リリースブロッカー）

これらが解決しないとリリースできない

### バグ修正

- [x] **スマホ等縦長画面で右カラムがスクロールできず下部のメニューが操作できないときがある**
  - ✅ 完了 (2025-12-29)
  - 修正内容: CSS調整によるメインエリアのスクロール確保とメディアクエリ対応

- [x] **Nexus Ark アコーディオンのスクロールバー不具合**
  - ✅ 完了 (2025-12-27)
  - レポート: [2025-12-27_accordion_scrollbar_fix.md](file:///c:/Users/baken/OneDrive/デスクトップ/gradio_github/gradiotest/docs/reports/2025-12-27_accordion_scrollbar_fix.md)

- [x] **マルチモーダル添付の修正**
  - ✅ 複数画像添付: `file_count="multiple"` 追加
  - ✅ MP3音声認識: `{"type": "file", ...}` 形式で送信
  - ✅ AI応答二重表示: チャンク処理修正
  - ⚠️ MP4動画: API制限のため未対応（将来の課題）
  - レポート: [2025-12-20_multimodal_fix_report.md](file:///c:/Users/baken/OneDrive/%E3%83%87%E3%82%B9%E3%82%AF%E3%83%88%E3%83%83%E3%83%97/gradio_github/gradiotest/docs/reports/2025-12-20_multimodal_fix_report.md)

- [x] **自律行動の重複発火バグ**
  - ハイブリッド方式（タイムスタンプ＋メモリ内フラグ）で修正
  - レポート: [2025-12-21_autonomous_action_duplicate_fix.md](file:///c:/Users/baken/OneDrive/%E3%83%87%E3%82%B9%E3%82%AF%E3%83%88%E3%83%83%E3%83%97/gradio_github/gradiotest/docs/reports/2025-12-21_autonomous_action_duplicate_fix.md)

- [x] **タイムスタンプ二重付記バグ**
  - AIが日本語曜日形式でタイムスタンプを生成する問題を修正
  - 正規表現を日本語/英語両対応に拡張
  - レポート: [2025-12-21_timestamp_duplicate_fix.md](file:///c:/Users/baken/OneDrive/%E3%83%87%E3%82%B9%E3%82%AF%E3%83%88%E3%83%83%E3%83%97/gradio_github/gradiotest/docs/reports/2025-12-21_timestamp_duplicate_fix.md)

- [x] **モデル名付記バグ**
  - 個別設定でモデル変更後、古いモデル名がタイムスタンプに付記される問題を修正
  - さらにAI模倣タイムスタンプ問題（AIが過去の応答のタイムスタンプを模倣）を根本修正
  - レポート: [2025-12-22_ai_timestamp_mimicry_fix.md](file:///c:/Users/baken/OneDrive/デスクトップ/gradio_github/gradiotest/docs/reports/2025-12-22_ai_timestamp_mimicry_fix.md)

### 安定性

- [x] **使用モデルリストの精査** ✅
  - 動作確認済みモデルのみに絞る
  - Gemini 3 Flash Previewは応答遅延問題あり（[gradio_notes.md](file:///c:/Users/baken/OneDrive/%E3%83%87%E3%82%B9%E3%82%AF%E3%83%88%E3%83%83%E3%83%97/gradio_github/gradiotest/docs/guides/gradio_notes.md) レッスン33）
  - おすすめモデルだけのリストを作成
  - レポート: [2025-12-26_model_list_management.md](file:///c:/Users/baken/OneDrive/デスクトップ/gradio_github/gradiotest/docs/reports/2025-12-26_model_list_management.md)

- [x] **モデルリストのUI管理機能強化** ✅
  - UI上からモデルの削除を可能にする
  - デフォルトモデルリストで上書きして初期状態に戻す機能
  - APIからモデルリスト取得機能追加（Groq/Ollama/OpenRouter対応）
  - お気に入りモデル機能（⭐マークでトグル）
  - ドロップダウン未表示バグ修正（visible=Falseグループ内のレンダリング問題）
  - レポート: [2025-12-27_model_list_management.md](file:///c:/Users/baken/OneDrive/デスクトップ/gradio_github/gradiotest/docs/reports/2025-12-27_model_list_management.md)

- [/] **Gemini 3シリーズの空応答・思考タグ問題**
  - 空応答が頻発（思考レベル変更で解消せず）
  - ツール使用のみ成功して応答テキストが空になるケースあり
  - `[THOUGHT]`タグを開始するが閉じタグがなく全文が思考ログ化
  - ℹ️ **2025-12-23 調査結果**: API不安定性が原因。対処法は [gemini3_flash_setup.md](file:///c:/Users/baken/OneDrive/デスクトップ/gradio_github/gradiotest/docs/guides/gemini3_flash_setup.md) 参照
  - レポート: [2025-12-21_gemini3_debug_log_addition.md](file:///c:/Users/baken/OneDrive/デスクトップ/gradio_github/gradiotest/docs/reports/2025-12-21_gemini3_debug_log_addition.md)

- [x] **新規ルーム作成時、自動情景画像生成をオフにする** ✅
  - `enable_scenery_system` を `False` に変更（情景システム無効化により画像生成も発生しない）

- [x] **APIコンテキスト設定の初期値変更** ✅
  - 送信履歴: 20件
  - エピソード記憶: 無効（0日）
  - 記憶の想起: 無効
  - 思考過程をAPIに送信: オフ
  - AI生成パラメータの温度: 1.0

- [x] **モデルリストの「(Slow Response)」除去** ✅
  - デフォルトモデルリストから注釈を削除済み

---

## 🟠 優先度: 高（リリース前に対応したい）

ユーザー体験に大きく影響

### 機能修正

- [x] **情景画像送信プロンプトの最適化** 🆕
  - ✅ 完了 (2025-12-27): プロンプトを「現在の光景」に変更し、AIが「見える」ことを過度に強調しないよう調整。
- [x] **情景画像送信のデフォルト設定確認** 🆕
  - ✅ 完了 (2025-12-27): `enable_scenery_system: False` で問題なし。
- [ ] **APIキー設定の集約管理** 🆕
  - OpenAI互換プロバイダのAPIキー設定を「🔑 APIキー / Webhook管理」に集約。
- [ ] **OpenRouterエラー表示の修正** 🆕
  - ツール非対応モデル使用時にエラーメッセージが表示されない問題を修正。
- [x] **エピソード記憶・話題クラスタの更新日が変わらない問題** 🆕
  - ✅ 完了 (2025-12-29): 睡眠時記憶整理で更新後にroom_config.jsonへ更新日時を保存するよう修正。読み込み時にoverride_settingsを優先確認。記憶圧縮結果も同様に保存するよう修正。
- [x] **動画アバターUIの表示不整合修正** 🆕
  - ✅ 完了 (2025-12-27): ルーム切り替え時にアバターモード設定を同期するよう修正。
- [x] **現在地移動ツールのメッセージクリーンアップ** 🆕
  - ✅ 完了 (2025-12-28): `[RAW_RESULT]`タグが表示されてしまう問題を修正（responder_id判定方式変更）

- [ ] **ChatGPTエクスポートインポート機能の修正**
  - スレッド途中までしかインポートされない
  - memory（moonlight?）の内容を誤って読み込んでいる可能性
  - ZIP丸ごと受け取り対応

### コスト削減・効率化

- [x] **送信コンテキストの最適化（APIコスト削減）** ✅ 2024-12-28
  - ✅ 過去ログ検索を`retrieval_node`から除外（RAG検索がカバー）
  - ✅ 話題クラスタ検索を一時無効化（別タスクで改良後に再有効化）
  - ✅ コアメモリ要約を簡潔化（5〜10行、最大1000文字）
  - ✅ ツール説明をSkills化（短縮形式に変更）
  - ✅ `search_past_conversations`ツールを除外

- [ ] **話題クラスタの改良** 🆕
  - ラベル生成プロンプトを具体化（人物名・場所名・日付を含める）
  - 要約を「いつ・誰と・何をした」形式に改善
  - 改良後、`retrieval_node`での検索を再有効化

- [ ] **日記検索(search_memory)のRAG化** 🆕
  - memory/*.txtをRAGインデックスに追加
  - `search_memory`ツールの内部実装をRAG検索に変更
  - メタデータフィルタで日記のみを返す

- [ ] **話題クラスタのコンテキスト制御** 🆕
  - 「話題クラスタ」をAPI送信コンテキストに含めるかどうかを選択可能にする
  - コスト削減にも貢献

- [ ] **送信トークン数の表示機能** 🆕
  - 記憶情報等を付加した後のトータル送信量を表示
  - 送信後（送信コンテキスト確定後）に表示

- [/] **画像リサイズによるAPIコスト削減** 🆕
  - API送信前に画像を縮小（512×512 or 256×256）してトークン消費を削減
  - 適用対象:
    - ✅ 情景画像のAI送信 (2025-12-25 完了)
    - ユーザー添付画像
    - AI生成画像（将来のギャラリー機能で使用予定）
  - 共通ユーティリティ関数として `utils.resize_image_for_api()` を実装

### UI修正

- [x] **主観的記憶（日記）のスクロールバー**
  - `#memory_txt_editor_code textarea` として修正完了

- [x] **個別設定の即時保存（ポップアップあり）**
  - 共通設定に合わせてポップアップ通知を有効化完了

- [x] **空応答のシステムメッセージ化**
  - ロジック実装・表示形式の修正完了

- [x] **モデルリストの最終整理**
  - `gemini-1.5` 系の削除、順序調整、注釈対応完了

- [x] **システムメッセージから再生成時の挙動修正** ✅
  - SYSTEMメッセージもAGENTと同様に扱い、直前のユーザーメッセージから再生成するよう修正
  - システムメッセージを削除して直前のユーザーメッセージを再送信する処理にする

- [ ] **チャット発言のコピー/編集時にタイムスタンプ除外**
  - ヘッダーやフッター（タイムスタンプ）を除外したい

- [x] **チャット送信キーの変更** → [002_shift_enter_submit_abandon.md](file:///c:/Users/baken/OneDrive/デスクトップ/gradio_github/gradiotest/docs/decisions/002_shift_enter_submit_abandon.md)
  - ~Shift+EnterではなくCtrl+Enterで送信するように変更~
  - Gradioの仕様上、実現不可のため断念

- [ ] **ルーム個別設定の保存ボタン整理**
  - 基本は即時保存のため不要なボタンを削除
  - ボタンでの保存が必要な個所のみ個別に保存ボタンを設置

- [ ] **空応答時のチャットログヘッダー統一**
  - 「Nexus Ark」と「システム」が混在しているので統一
  - ルールをドキュメント化して今後の迷いを防止

- [x] **新規ルーム作成時「個別設定を保存しました」通知が2回表示される問題** ✅ 完了 (2025-12-25)
  - 方針C採用：自動ルーム切り替えを廃止し、イベント連鎖を根本解決
  - 通知メッセージに「ルーム選択メニューから切り替えてください」の案内を追加
  - デバウンス処理を追加：ルーム切り替え時の連続通知も1回に抑制

- [x] **デバッグモードの絵文字削除** ✅ 完了
  - 共通設定のデバッグモードの「🐛」絵文字を削除
  - 䅋が苦手なユーザーへの配慮

---

## 🟡 優先度: 中（リリース後でも可、余裕があれば対応）

### 機能改善

- [x] **起動時に「アバターモードを動画に変更しました」といちいち出てしまう**
  - ✅ 完了 (2025-12-29)
  - 修正内容: 設定変更時のみ通知が出るようロジックを修正

- [ ] **モデルリストのお気に入り保持機能**
  - デフォルトに戻したり最新リストを取得したりしても、既存モデルのお気に入りマーク⭐を保持する。
- [ ] **アバター静止画複数モード対応** 🆕
  - 動画同様に、待機中・思考中等の画像を登録し使用されるようにする。
- [ ] **画像生成ツールでOpenAIモデル対応** 🆕
  - OpenAIのDALL-E等で画像生成できるようにする。
- [x] **ログエディタの自動スクロール改善** ✅ (2025-12-27 完了)
  - RAWログエディタで最新のチャット内容（最下部）に自動でスクロールするように改善。

- [ ] **グループ会話の司会役AI（Supervisor）の改善**
  - 不安定・処理が遅い
  - 参照: [supervisor_implementation.md](file:///c:/Users/baken/OneDrive/%E3%83%87%E3%82%B9%E3%82%AF%E3%83%88%E3%83%83%E3%83%97/gradio_github/gradiotest/docs/plans/supervisor_implementation.md)

- [ ] **話題クラスタ更新の改善**
  - 動作がよくわからない
  - 埋め込みモード同期は修正済み

- [x] **現在地連動背景表示の強化** 🆕
  - ✅ 完了 (2025-12-28): AIツール場所変更、画像生成、カスタム登録時に背景CSSも更新されるように改善

- [x] **Gradio起動時の外部接続設定UI** ✅ 完了 (2025-12-27)
  - 共通設定に「外部接続を許可」チェックボックスを追加
  - 設定変更後はアプリ再起動で反映

- [ ] **ファイル読み書きツールの改善** 🆕
  - 現状の問題: 改行なしで書き込まれて読みづらい、部分更新が全上書きになる
  - memory_main.txt, world_settings.txt, notepad.md が対象
  - 改善案:
    - 追記モード（`append_to_file`）の追加
    - フォーマット付き書き込み（改行保持）
    - セクション単位の更新（`update_section("場所", new_data)`）

- [ ] **開発者モードツール（コード参照機能）** 🆕
  - ペルソナがNexus Arkのソースコード・ドキュメントを参照できるようにする
  - `.py`, `.md`, `.txt`, `.json` ファイルの読み取り専用アクセス
  - **メニューからオン/オフを切り替え可能**（ルーム個別設定）
  - **デフォルトはオフ**（必要なルームでのみ有効化）
  - 用途:
    - ルシアン（共同開発者）: 開発相談
    - オリヴェ（案内役）: 仕様書参照でユーザー質問に回答
    - 一般ペルソナ: 自分のコードを理解したい場合
  - OSSとして公開しているためコードに機密なし




- [x] **書き置き機能（自律行動向けメッセージ）** ✅ (2025-12-25 完了)
  - 自律行動時にAIペルソナにメッセージを渡す機能
  - 専用ファイル `user_memo.txt` を使用
  - 履歴更新ボタンで書き置きUIも更新
  - 送信された書き置きはチャット履歴に記録

### アラーム・タイマー関連

- [ ] **アラームの日付指定・期間指定・祝日除外**
  - 単発アラームや期間限定、祝日を考慮した設定

- [ ] **タイマー・ポモドーロの一覧表示**
  - 複数仕掛けている時に便利なよう一覧できるように

---

## 🟢 優先度: 低（将来機能）

- [x] **AIペルソナ「お出かけ」機能** (✅ 完了 2025-12-29)
  - ✅ 人格データ（プロンプト・記憶）+直近ログをセクション別にプレビュー・編集可能
  - ✅ 各セクションのAI圧縮（要約）機能
  - ✅ 会話ログのカスタマイズ（タイムスタンプ・モデル名除外）
  - ✅ Markdown形式でのエクスポート
  - ℹ️ 外部アプリ（Antigravity等）側でのインポート仕様に合わせ、汎用的なMD形式を採用

- [ ] **自律タイマー設定＆ユーザー許可制** 🆕 (2025-12-25 INBOXより)
  - 通常応答時にもAIが次の行動のためタイマーを自己設定可能にする
  - APIコスト問題があるため、Antigravityのようにユーザーが許可・却下できる仕組み

- [ ] **アラームリストのチェックボックス直接オンオフ** 🆕 (2025-12-25 INBOXより)
  - 現在はボタン操作が必要だが、チェックボックスで直接切り替え希望

- [ ] **ルームごとのギャラリー機能** 🆕 (2025-12-25 INBOXより)
  - 生成した画像や添付した画像を一覧表示
  - AIペルソナも閲覧可能にする

- [ ] **アバター画像・動画の表情対応** 🆕
  - 応答の感情を分析し、それに応じた表情に変更
  - 表情の種類はユーザーが追加可能、プログラムがリストを取得して感情分類

- [x] **会話ログ編集欄の新設** ✅ (2025-12-25 完了)
  - チャットタブ内にサブタブ（💬 会話 / 📝 RAWログエディタ）を追加
  - log.txt を全文読み込み・保存可能に（保存前に自動バックアップ）

---

## 📦 配布準備（並行作業）

[distribution_system_plan.md](file:///c:/Users/baken/OneDrive/%E3%83%87%E3%82%B9%E3%82%AF%E3%83%88%E3%83%83%E3%83%97/gradio_github/gradiotest/docs/plans/distribution_system_plan.md) に基づく実装

- [ ] `version.json` 作成
- [ ] `update_manager.py` 実装
- [ ] `初回セットアップ.bat` 作成
- [ ] [nexus_ark.py](file:///c:/Users/baken/OneDrive/%E3%83%87%E3%82%B9%E3%82%AF%E3%83%88%E3%83%83%E3%83%97/gradio_github/gradiotest/nexus_ark.py) にアップデート確認UI追加
- [ ] `ネクサスアーク.bat` 修正
- [ ] 手動検証とドキュメント作成

---

*最終更新: 2025-12-25*
