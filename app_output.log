--- [Nexus Ark] ロギング設定を完全に掌握しました ---
--- [分離思考型] グラフがコンパイルされました ---
--- グローバル・ロックの取得を試みます ---

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
警告: 古いロックファイルを検出しました。
  - 記録されていたPID: 5907 (このプロセスは現在実行されていません)
  古いロックファイルを自動的に削除して、処理を続行します。
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

--- ロックを取得しました (自動クリーンアップ後) ---
--- [テーマ] カスタムテーマ 'Nexus Ark' を適用します ---
アラームスケジューラスレッドを開始します.アラームスケジューラスレッドを起動しました.

/app/nexus_ark.py:452: UserWarning: You have not specified a value for the `type` parameter. Defaulting to the 'tuples' format for chatbot messages, but this is deprecated and will be removed in a future version of Gradio. Please set type='messages' instead, which uses openai-style dictionaries with 'role' and 'content' keys.
  chatbot_display = gr.Chatbot(

============================================================
アプリケーションを起動します...
起動後、以下のURLでアクセスしてください。

  【PCからアクセスする場合】
  http://127.0.0.1:7860

  【スマホからアクセスする場合（PCと同じWi-Fiに接続してください）】
  http://<お使いのPCのIPアドレス>:7860
  (IPアドレスが分からない場合は、PCのコマンドプロモートやターミナルで
   `ipconfig` (Windows) または `ifconfig` (Mac/Linux) と入力して確認できます)
============================================================

* Running on local URL:  http://0.0.0.0:7860
* To create a public link, set `share=True` in `launch()`.
--- UI初期化処理(handle_initial_load)を開始します ---
--- 情景をAPIで生成します (リビング_10182b0e_autumn_night) ---
WARNING: All log messages before absl::InitializeLog() is called are written to STDERR
E0000 00:00:1760154448.439710    7138 alts_credentials.cc:93] ALTS creds ignored. Not running on GCP and untrusted ALTS is not enabled.
--- 警告: 情景描写の生成中にエラーが発生しました ---
Traceback (most recent call last):
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/langchain_google_genai/chat_models.py", line 208, in _chat_with_retry
    return generation_method(**kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/google/ai/generativelanguage_v1beta/services/generative_service/client.py", line 869, in generate_content
    response = rpc(
               ^^^^
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/google/api_core/gapic_v1/method.py", line 131, in __call__
    return wrapped_func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/google/api_core/retry/retry_unary.py", line 294, in retry_wrapped_func
    return retry_target(
           ^^^^^^^^^^^^^
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/google/api_core/retry/retry_unary.py", line 156, in retry_target
    next_sleep = _retry_error_helper(
                 ^^^^^^^^^^^^^^^^^^^^
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/google/api_core/retry/retry_base.py", line 214, in _retry_error_helper
    raise final_exc from source_exc
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/google/api_core/retry/retry_unary.py", line 147, in retry_target
    result = target()
             ^^^^^^^^
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/google/api_core/timeout.py", line 130, in func_with_timeout
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/google/api_core/grpc_helpers.py", line 78, in error_remapped_callable
    raise exceptions.from_grpc_error(exc) from exc
google.api_core.exceptions.InvalidArgument: 400 API key not valid. Please pass a valid API key. [reason: "API_KEY_INVALID"
domain: "googleapis.com"
metadata {
  key: "service"
  value: "generativelanguage.googleapis.com"
}
, locale: "en-US"
message: "API key not valid. Please pass a valid API key."
]

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/app/agent/graph.py", line 178, in generate_scenery_context
    scenery_text = llm_flash.invoke(scenery_prompt).content
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/langchain_google_genai/chat_models.py", line 1676, in invoke
    return super().invoke(input, config, stop=stop, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 395, in invoke
    self.generate_prompt(
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 1023, in generate_prompt
    return self.generate(prompt_messages, stop=stop, callbacks=callbacks, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 840, in generate
    self._generate_with_cache(
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 1089, in _generate_with_cache
    result = self._generate(
             ^^^^^^^^^^^^^^^
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/langchain_google_genai/chat_models.py", line 1790, in _generate
    response: GenerateContentResponse = _chat_with_retry(
                                        ^^^^^^^^^^^^^^^^^
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/langchain_google_genai/chat_models.py", line 238, in _chat_with_retry
    return _chat_with_retry(**params)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/tenacity/__init__.py", line 338, in wrapped_f
    return copy(f, *args, **kw)
           ^^^^^^^^^^^^^^^^^^^^
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/tenacity/__init__.py", line 477, in __call__
    do = self.iter(retry_state=retry_state)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/tenacity/__init__.py", line 378, in iter
    result = action(retry_state)
             ^^^^^^^^^^^^^^^^^^^
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/tenacity/__init__.py", line 400, in <lambda>
    self._add_action_func(lambda rs: rs.outcome.result())
                                     ^^^^^^^^^^^^^^^^^^^
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/tenacity/__init__.py", line 480, in __call__
    result = fn(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/langchain_google_genai/chat_models.py", line 220, in _chat_with_retry
    raise ChatGoogleGenerativeAIError(msg) from e
langchain_google_genai.chat_models.ChatGoogleGenerativeAIError: Invalid argument provided to Gemini: 400 API key not valid. Please pass a valid API key. [reason: "API_KEY_INVALID"
domain: "googleapis.com"
metadata {
  key: "service"
  value: "generativelanguage.googleapis.com"
}
, locale: "en-US"
message: "API key not valid. Please pass a valid API key."
]

Traceback (most recent call last):
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/gradio/queueing.py", line 745, in process_events
    response = await route_utils.call_process_api(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/gradio/route_utils.py", line 354, in call_process_api
    output = await app.get_blocks().process_api(
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/gradio/blocks.py", line 2127, in process_api
    data = await self.postprocess_data(block_fn, result["prediction"], state)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/gradio/blocks.py", line 1849, in postprocess_data
    self.validate_outputs(block_fn, predictions)  # type: ignore
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/gradio/blocks.py", line 1804, in validate_outputs
    raise ValueError(
ValueError: A  function (handle_initial_load) didn't return enough output values (needed: 54, returned: 47).
    Output components:
        [dataframe, state, markdown, state, chatbot, state, multimodaltextbox, image, textbox, textbox, textbox, textbox, dropdown, dropdown, dropdown, dropdown, dropdown, textbox, dropdown, textbox, checkbox, slider, slider, slider, dropdown, dropdown, dropdown, dropdown, checkbox, checkbox, checkbox, checkbox, checkbox, checkbox, checkbox, markdown, image, checkbox, accordion, state, dropdown, code, dropdown, state, markdown, checkboxgroup, dataframe, dropdown, radio, dropdown, dropdown, column, markdown, dropdown]
    Output values returned:
        [Empty DataFrame
Columns: [状態, 時刻, 予定, ルーム, 内容]
Index: [], Empty DataFrame
Columns: [ID, 状態, 時刻, 予定, ルーム, 内容]
Index: [], "アラームを選択してください", "Default", [], [], {'value': {'text': '', 'files': []}, '__type__': 'update'}, None, "## 聖域 (Sanctuary)
# このエリアの内容は、コアメモリにそのままコピーされます。

### 自己同一性 (Self Identity)


## 日記 (Diary)
# このエリアの内容は、AIによって要約され、コアメモリに追記されます。

### 2025-10-11


## アーカイブ要約 (Archive Summary)
# このセクションには、アーカイブされた古い日記の要約が蓄積されます。

", "", "", "", {'choices': [('Default', 'Default')], 'value': 'Default', '__type__': 'update'}, {'choices': [('Default', 'Default')], 'value': 'Default', '__type__': 'update'}, {'choices': [('Default', 'Default')], 'value': 'Default', '__type__': 'update'}, {'choices': [('Default', 'Default')], 'value': 'Default', '__type__': 'update'}, {'choices': [('[共有リビング]', '__AREA_HEADER_共有リビング'), ('\xa0\xa0→ リビング', 'リビング')], 'value': 'リビング', '__type__': 'update'}, "（情景描写の生成中にエラーが発生しました）", "Iapetus (クリア)", "", True, 0.01, 0.8, 0.95, "高リスクのみブロック", "高リスクのみブロック", "高リスクのみブロック", "高リスクのみブロック", False, True, True, False, True, True, False, "ℹ️ *現在選択中のルーム「Default」にのみ適用される設定です。*", None, True, {'__type__': 'update', 'visible': True}, Empty DataFrame
Columns: [元の文字列 (Find), 置換後の文字列 (Replace), 背景色]
Index: [], "トークン数: (APIキーエラー)", {'choices': ['your_key_name'], 'value': 'your_key_name', '__type__': 'update'}, {'共有リビング': {'リビング': '広々としたリビングルーム。大きな窓からは柔らかな光が差し込み、快適なソファが置かれている。'}}, {'value': 'リアル連動', '__type__': 'update'}, {'value': '秋', '__type__': 'update'}, {'value': '夜', '__type__': 'update'}, {'__type__': 'update', 'visible': False}]
警告 [アラーム]: 有効なAPIキーが設定されていないため、アラームチェックをスキップします。
