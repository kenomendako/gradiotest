# Changelog

All notable changes to Nexus Ark will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/).

## [Unreleased] - 次回リリース予定

### Added - 新機能

#### 🎭 アバター表情差分システム (2025-12-30)
- AIの応答（`【表情】…xxx…`）に応じてアバターの表情を自動で切り替える機能を追加
- 静止画/動画両対応。指定の表情ファイルがない場合は自動で `idle` → `profile.png` へフォールバック
- 表情管理UIを追加（表情の追加・削除、画像/動画アップロード）
- システムプロンプトでの指示により、任意の感情表現を登録・利用可能

#### 🤖 自律行動システム
- 自律行動モード（AIが自発的に行動・発言）
- 通知禁止時間帯（Quiet Hours）対応
- **通知のAI選択機能** (2026-01-01): `send_user_notification`ツール追加。自律行動時の自動通知を廃止し、AIが通知するか判断
- **通知禁止時間帯でも自律行動実行** (2026-01-01): 通知禁止時間帯でも自律行動を実行（通知は送らない）
- **自律行動プロンプト強化** (2026-01-01): 秘密の日記、創作活動、探求など具体的な行動オプションを提示
- **創作ノートツール** (2026-01-01): AIペルソナ専用の創作スペース。詩、物語、アイデアなどを自由に書き留められる（`read_creative_notes`, `plan_creative_notes_edit`）。UI上でも「ノート」タブから閲覧・編集可能
- **創作ノート改善** (2026-01-02): タイムスタンプ自動付与機能とバックアップ機能を追加
- **創作ノートタイムスタンプ改良** (2026-01-03): 各行にタイムスタンプを付与する方式から「セクションヘッダー方式」に変更。詩や物語の各行を汚さず、冒頭に仕切り線とタイムスタンプを1つ付与

#### 🌙 睡眠・記憶システム
- 睡眠・夢日記機能（Project Morpheus）
- 中期記憶（エピソード記憶）生成・注入機能
- 話題のクラスタリング機能
- 応答時記憶想起機能（RAG検索）
- **日記検索のRAG化** (2025-12-31): `search_memory`ツールをキーワード検索からRAGベクトル検索に変更。`memory_main.txt`とアーカイブ日記を自動インデックス化。
- **API送信ログ「本日分」オプション** (2026-01-01): ログ件数制限に「本日分」を追加。日付が変わってからのメッセージのみをAPIに送信し、それ以前はエピソード記憶でカバー。トークン消費の最適化とメモリ連携を強化。
- **エピソード記憶短期間オプション** (2026-01-01): 1日〜5日の短期間オプションを追加。「本日分」ログ設定と組み合わせて、直近数日のコンテキストを精密に制御可能。

#### 🎯 Goal Memory & Multi-Layer Self-Reflection (2026-01-02)
- **Goal Memory**: AIペルソナが睡眠時省察で自発的に短期・長期目標を設定。`goals.json`に保存され、UIから確認可能
- **Multi-Layer Reflection**: 日次/週次/月次の3層省察システム。時間経過に応じて自動的に深い内省を実行
- **目標のプロンプト注入**: 現在の目標をシステムプロンプトに自動注入し、応答時のコンテキストとして活用
- **夢日記注入の最適化**: 「指針のみ1日分」に変更し、トークン消費を大幅削減

#### 🧠 自律動機システム (Autonomous Motivation System) (2026-01-03)
- **4つの内発的動機**: 退屈（Boredom）、好奇心（Curiosity）、目標達成欲（Goal Achievement Drive）、奉仕欲（Devotion）を計算
- **内的状態モニタリングUI**: 「🧠 内的状態」アコーディオンで動機レベルと未解決の問いを確認可能
- **未解決の問い抽出**: 睡眠時の夢想プロセスで「気になること」を自動抽出し、好奇心の源泉として記録
- **発火時刻永続化**: 再起動後も最終発火時刻を維持し、頻度制限を正しく適用
- **頻度制限統一**: 「無操作判定時間（分）」を最低間隔として使用
- **内部状態リセット機能**: 記憶のメンテナンスから動機レベル・未解決の問い・最終発火時刻を一括リセット可能

#### 🔀 マルチモデル対応
- OpenAI互換プロバイダへの対応
- グループ会話での各ペルソナ個別モデル設定

#### 📎 マルチモーダル強化
- 複数ファイル同時添付対応
- MP3音声ファイル認識

#### 🛡️ その他
- 設定ファイルの自動バックアップ＆自動復元機能
- 思考ログの形式を[THOUGHT]タグ方式に移行（後方互換あり）
- ルーム削除機能を追加

#### 🌄 情景画像AI認識機能 (2025-12-25)
- AIが現在の景色を「見る」機能を追加
- 送信タイミング設定: 「変更時のみ」または「毎ターン」
- 画像は512×512にリサイズしてコスト削減

#### 📷 ユーザー添付画像リサイズ機能 (2025-12-31)
- ユーザーが添付した画像をAPI送信前に768pxにリサイズ
- 元の画像形式を維持（JPEG→JPEG、PNG→PNG）
- 共通ユーティリティ`utils.resize_image_for_api()`を拡張してPIL Image対応

#### 📝 書き置き機能 (2025-12-25)
- 自律行動時にAIにメッセージを渡す「書き置き」機能を追加
- 履歴更新ボタンで書き置きUIも更新
- 送信された書き置きはチャット履歴に記録される

#### 📝 会話ログRAWエディタ (2025-12-25)
- チャットタブ内にサブタブ構造（💬 会話 / 📝 RAWログエディタ）を追加
- `log.txt` を全文読み込み・保存可能（保存前に自動バックアップ）
- 高さ制限でスクロールバー表示（CSSで600px制限）
- タブ選択・再読込時に最新のチャット内容（最下部）へ自動スクロール (2025-12-27)

#### 🎬 動画アバター機能 (2025-12-26)
- 動画ファイル（mp4, webm, gif）をプロフィールアバターとして使用可能

#### 📥 モデルリスト管理機能 (2025-12-27)
- APIからモデルリスト取得機能（Groq/Ollama/OpenRouter対応）
- お気に入りモデル機能（⭐マークでトグル）
- 共通・個別設定の両方に対応

#### 🌐 外部接続設定UI (2025-12-27)
- 共通設定に「🌐 ネットワーク設定」アコーディオンを追加
- 同じネットワーク内の他デバイス（スマホなど）からのアクセスをオン/オフ可能
- 設定変更後はアプリ再起動で反映

#### 💼 ペルソナ「お出かけ」専用タブ (2025-12-29)
- 専用タブ「💼 お出かけ」を新設し、UIを左サイドバーから独立・集約化。
- **5つのセクション別管理**: システムプロンプト、永続記憶、日記要約、エピソード記憶、会話ログを個別にプレビュー・編集・エクスポート可能。
- **✨ AI圧縮（要約）機能**: 各セクションにAIによる最適化（要約）機能を搭載。前置きを含まないクリーンな要約プロンプトを採用。
- **💬 会話ログのカスタマイズ**: ログ表示時に「タイムスタンプ」と「モデル名」を個別に除外可能。
- **🔄 セクション別リセット**: 編集や圧縮後にいつでも元のデータを再読み込み可能。
- **📝 リアルタイム文字数計算**: セクションの有効/無効やスライダー変更を、合計文字数に即座に反映。
- **⚙️ UX改善**: 長いテキストエリアでも快適に閲覧・スクロールできるよう最大高さを制限。

#### 🖼️ 現在地連動背景表示の強化 (2025-12-28)
- 「現在地と連動 (Sync)」モードで、以下の操作後も即座に背景画像が更新されるように改善:
  - AIがツールで場所を変更した時
  - 情景画像を新規生成した時
  - カスタム情景画像を登録した時

#### 💰 送信コンテキスト最適化 (2025-12-28)
- **過去ログ検索を`retrieval_node`から除外**: キーワードマッチ方式はノイズが多いため、RAG検索に統合
- **話題クラスタ検索を一時無効化**: クラスタリング精度が低いため、改良後に再有効化予定
- **コアメモリ要約を簡潔化**: 5〜10行・最大1000文字の箇条書きに変更
- **ツール説明をSkills化**: 各ツールの説明を短縮形式に変更（トークン削減）
- **`search_past_conversations`ツールを除外**: RAG検索がカバーするため冗長

### Fixed - バグ修正

#### 🛠️ 起動時の不要な「個別設定を保存しました」通知を修正 (2026-01-03)
- 起動後5秒間は通知を抑制し、UI初期化時の誤通知を防止
- 「このルームの個別設定を保存」ボタンを廃止（即時自動保存に統合済み）
- 個別設定タブに「設定は自動保存されます」の説明を追加

#### 🛠️ Windows環境での索引保存時のPermissionErrorを解決 (2025-12-31)
- FAISSインデックス保存時に発生していた `PermissionError: [WinError 5]` を解決。
- 「リネーム退避方式」を導入し、ファイルロックが発生していても安全に新規索引を配置できるよう改善。
- 退避した旧インデックスはバックグラウンドで安全にクリーンアップ。

#### 🛠️ 「本日分」ログ送信・表示の日付変更直後の空白問題を修正 (2026-01-03)
- 日付が変わってからエピソード記憶が生成されるまでの間、UI表示とAPI送信が空になる問題を修正。
- 今日のエピソード記憶が存在しない場合は、昨日のログも含めて表示・送信するように改善。

#### 📱 スマホ等縦長画面でのスクロール不具合を修正 (2025-12-29)
- スマホ等の縦長画面において、右カラム（メインエリア）がスクロールできず下部のメニューが操作できない問題をCSSで修正。
- 画面幅768px以下のレスポンシブ表示時に、メインコンテナのスクロールを有効化。

#### 📱 縦長画面での左右サイドバーつまみ重なり問題を修正 (2025-12-30)
- 縦長画面で左右サイドバーのつまみ（開閉ハンドル）が同じ位置に重なり、片方しか操作できなくなる問題を修正。
- 左サイドバーのつまみを60px下にオフセットし、左右のつまみが上下に並ぶよう調整。
- 右サイドバー（プロフィール・情景）が優先表示されるようz-indexを調整。

#### 🔔 アバターモード通知の重複表示を抑制 (2025-12-29)
- 起動時やルーム切替時に、アバターモードが変更されていない場合でも通知が表示される問題を修正。
- 設定値が実際に変更された場合のみ通知を出すように改善。


#### 🌄 情景画像の「変更時のみ」送信が機能しない問題を修正 (2025-12-29)
- `last_sent_scenery_image` の保存・読み込み経路の不整合を修正
- 「変更時のみ」モードで正しく毎ターン送信がスキップされるようになった
- 参照: [レポート](file:///c:/Users/baken/OneDrive/デスクトップ/gradio_github/gradiotest/docs/reports/2025-12-29_scenery_image_sending_fix.md)

#### 🛠️ 文字置き換え機能の表示崩れを修正 (2025-12-29)
- 文字置き換え機能（スクリーンショットモード）で思考ログの表示が崩れる問題を修正
- `<span>` タグ以外のテキストをHTMLエスケープすることでMarkdown再解釈を防止
- ⚠️ 既知の制限: スクリーンショットモードON時のコピー機能でHTMLタグがコピーされる（Gradio内部動作に起因）
- 参照: [レポート](file:///c:/Users/baken/OneDrive/デスクトップ/gradio_github/gradiotest/docs/reports/2025-12-29_redaction_thought_log_display_fix.md)


#### 🛠️ ツール結果表示の修正 (2025-12-28)
- 現在地移動ツール等の実行結果で `[RAW_RESULT]` タグとUUIDが表示されてしまう問題を修正
- ヘッダー形式 `tool_result:name:id` に対応するよう判定方式を変更


#### 🌄 情景画像送信プロンプトの調整 (2025-12-27)
- 情景画像送信時のプロンプトを「現在の光景」に変更し、AIが「見える」ことを過度に強調しないよう調整。

#### 🔄 プロバイダ切り替え・ドロップダウン問題 (2025-12-27)
- 共通設定でOpenAI互換を選んでもUI が切り替わらない問題を修正
- 個別設定のOpenAI互換モデルドロップダウンが起動時に開かない問題を修正
- 「静止画」「動画」モード切り替えに対応（ルームごとに保存）
- AI応答生成中は「思考中」アバター（`thinking.mp4`）に自動切り替え
- 応答完了後は「待機」アバター（`idle.mp4`）に復帰

#### 🔧 モデルリスト管理機能強化 (2025-12-26)
- 全プロバイダのデフォルトモデルリストを2025年12月時点の推奨モデルに更新
- モデル選択画面に「削除」「デフォルトに戻す」ボタンを追加
- 共通設定・個別設定の両方でGemini/OpenAI互換に対応
- 低スペックPC向けOllamaモデル（VRAM 4GB対応）をデフォルト設定に追加


### Changed - 仕様変更

#### ⚙️ 初期設定の調整 (2025-12-24)
- 新規ルームのAPIコンテキスト設定のデフォルト値を変更
  - 送信履歴: 全ログ → 20件
  - エピソード記憶: 過去2週間 → 無効（0日）
  - 記憶の想起: 有効 → 無効
  - 思考過程をAPIに送信: オン → オフ
  - 温度: 0.8 → 1.0
  - 情景システム: 有効 → 無効

### Fixed - バグ修正

#### UI / 表示
- **動画アバターUIの表示不整合を修正** (2025-12-27): ルーム切り替え時にアバターモード設定（静止画/動画）が正しく反映されるよう修正。
- **左カラム「設定」サイドバー内のアコーディオンにおけるスクロール不具合を修正** (2025-12-27)
- 自律行動の重複発火バグ
- タイムスタンプ二重付記バグ（AIが日本語曜日形式でタイムスタンプ生成）
- AI模倣タイムスタンプ問題（AIが過去の応答のタイムスタンプを模倣→除去して正しいモデル名で再付記）
- AI応答の二重表示バグ
- LangGraphが生成する末尾の空AIMessageを除去
- `redaction_rules_state`の初期化時TypeError修正
- `handle_save_gemini_key`の戻り値数不足（オンボーディング時のValueError）
- 思考ログ内の文字置き換えでHTMLがエスケープされる問題
- 思考ログの折り返しが効かなくなる問題（CSS適用修正）
- **新規ルーム作成時の通知2回表示問題** (2025-12-25)
  - 自動ルーム切り替えを廃止し、イベント連鎖を根本解決
- **ルーム切り替え時の通知2回表示問題** (2025-12-25)
  - デバウンス処理を追加し、1秒以内の連続通知をスキップ
- **gemini_api.pyのdatetimeインポート欠落** (2025-12-25)
  - エピソード記憶取得時のNameErrorを修正
- **プロフィール画像保存時のNoneTypeエラー** (2025-12-25)
  - ImageEditorのcomposite→backgroundフォールバック追加

#### バックグラウンド処理
- **睡眠時記憶整理の更新日保存を修正** (2025-12-29): エピソード記憶・話題クラスタ・記憶圧縮の自動更新後にUIに表示される最終更新日が古いままになる問題を修正。ステータス読み込み時に`override_settings`を優先確認するよう改善。
- アラーム・タイマーでAPI制限時もシステム通知を送信
- APIリトライ時にツール使用（アラーム・タイマー・ファイル編集等）の重複実行を防止
- 重複関数削除とタイマー・バックアップパス修正

#### 🛡️ ルーム管理 (2025-12-25)
- **ルーム削除の引数配線バグ修正**: 意図しないルームが削除される致命的バグを修正
- **ルーム削除を安全化**: 完全削除からゴミ箱移動（send2trash）に変更、復元可能に
- **キャラクターデータ自動バックアップ**: Gitによる日次自動コミット機能追加

### Known Issues - 既知の問題
- MP4動画: API制限のため送信失敗することがある

---

## [1.0.0] - 2025-10-19

*前回リリース*
