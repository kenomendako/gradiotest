# Changelog

All notable changes to Nexus Ark will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/).

## [Unreleased]

### Added
- **Intent分類APIコスト最適化 (2026-01-16):** retrieval_nodeでクエリ生成と同時にIntent分類を実行。検索あたりのAPI呼び出しを2回→1回に削減。[レポート](docs/reports/2026-01-16_intent_classification_optimization.md)
- **Intent-Aware Retrieval (2026-01-16):** 記憶検索にクエリ意図分類を導入。感情的質問は古い記憶も優先（時間減衰抑制）、技術的質問は新しい情報優先（時間減衰強め）。3項式複合スコアリング（Similarity + Arousal + TimeDecay×Arousal）を実装。[レポート](docs/reports/2026-01-16_intent_aware_retrieval.md) [研究メモ](docs/plans/research/arousal_aware_time_decay_study.md)
- **Arousalアノテーション付き日次要約 (2026-01-17):** 日次エピソード記憶生成時に各会話ログのArousal値をアノテーション。高Arousal（≥0.6）会話を★マークで優先詳細化し、低Arousal会話は簡潔に要約。セッション単位の課題（コスト・口調）を解決。[レポート](docs/reports/2026-01-17_episodic_summary_arousal_annotation.md)
- **Arousal正規化プロセス (2026-01-17):** 記憶システムのArousalインフレを防止するため、週次/月次省察時にエピソード全体のArousalを正規化（0.9倍減衰）する機能を導入。[レポート](docs/reports/2026-01-17_arousal_normalization.md)
- **ファイル競合対策（Race Condition防止） (2026-01-17):** `filelock`ライブラリを導入。自律行動とユーザー対話の同時実行による記憶ファイル破損を防ぐため、主要JSONファイル（エピソード記憶、内的状態、目標等）の読み書きにロックを適用。[レポート](docs/reports/2026-01-17_file_lock_race_condition_fix.md)
- **エピソード記憶の月次ファイル分割 (2026-01-17):** `episodic_memory.json`を`memory/episodic/YYYY-MM.json`形式の月次ファイルに分割。書き込みエラー時の全データロストリスクを軽減し、ファイル管理を効率化。移行スクリプト`tools/migrate_monthly_episodes.py`を追加。[レポート](docs/reports/2026-01-17_monthly_episodic_file_split.md)
- **チェス フリームーブモード完全実装 (2026-01-18):** 盤面の自由配置機能における同期不全・永続化バグを完全に修正。ペルソナによる操作のリアルタイム反映と、ユーザー操作（ドラッグ中）との競合回避を実装。JS-Python通信のDOM可視化による根本解決を含む。[レポート](docs/reports/2026-01-18_chess_free_move.md)


### Changed
- **エピソード記憶の分量調整（予算緩和） (2026-01-17):** 記憶の「圧縮しすぎ」を解消するため、文字数予算を従来の約2倍に緩和（High: 600, Medium: 350, Low: 150文字）。日次要約の記述量も5-8行へ増加させ、会話のニュアンス保持を強化。[レポート](docs/reports/2026-01-17_episodic_memory_budget_relaxing.md)
- **週次圧縮プロンプトのペルソナ視点化 (2026-01-17):** 週次圧縮を三人称視点からペルソナ視点に変更。元の口調を維持し、★マーク継承で高Arousal記録を詳細化。文字数制限（400〜800文字）を追加。

### Removed
- **絆確認エピソード機能を廃止 (2026-01-16):** 感情変化時に自動生成される「絆確認」エピソード記憶は、具体的な会話内容を伴わない定型文しか生成されないため廃止。[レポート](docs/reports/2026-01-16_episodic_memory_fixes.md)
- **エピソード記憶UIの改善 (2026-01-17):** 同じ日付に複数エピソードがある場合に全て表示するよう修正。作成順ソート、件数案内、ドロップダウン重複排除、自動スクロール無効化を実装。[レポート](docs/reports/2026-01-16_episodic_memory_fixes.md)

### Fixed
- **旧形式Arousalデータ移行問題を修正 (2026-01-16):** `session_arousal.json`の旧形式（scores配列）から新形式（sessions配列）への移行時に`time: "00:00:00"`となる問題に対し、該当セッションをスキップするロジックを追加。[レポート](docs/reports/2026-01-16_episodic_memory_fixes.md)
- **特殊タイプエピソードの重複判定修正 (2026-01-17):** 達成エピソード等がある日でも日次要約が生成されるよう判定ロジックを修正。
- **Web巡回ツールのリスト削除エラー修正 (2026-01-17):** 巡回リストからの削除時に発生していた `ValueError: The truth value of a DataFrame is ambiguous` を修正。入力データがリストとDataFrameのいずれの場合でも安全に処理できるようロジックを改善。[レポート](docs/reports/2026-01-17_watchlist_deletion_fix.md)
- **Phase I: UIドライブ表示の改善 (2026-01-15):** 感情モニタリングを「ユーザー感情」から「ペルソナ感情」に変更。LinePlot→ScatterPlotに変更し視認性向上。[レポート](docs/reports/2026-01-15_phase_i_ui_drive_display.md)
- **セッション単位エピソード記憶 (2026-01-15):** 日単位からセッション単位へエピソード記憶生成を変更。各セッションのArousalに応じて詳細度を調整（高Arousal: 300文字、中: 150文字、低: 50文字）。MAGMA論文のSalience-Based Budgetingを適用。[レポート](docs/reports/2026-01-15_session_based_episodic_memory.md)
- **Phase H: 記憶共鳴フィードバック機構 (2026-01-15):** エピソード記憶にID自動付与。ペルソナが `<memory_trace>` タグで共鳴度を報告し、Arousalを自己更新する機構を導入。MAGMA論文の知見を適用。[レポート](docs/reports/2026-01-15_phase_h_arousal_self_evolution.md)
- **Phase F: 関係性維持欲求 (2026-01-15):** 「奉仕欲（Devotion）」を廃止し、ペルソナ自身の感情に基づく「関係性維持欲求（Relatedness Drive）」を導入。ユーザー感情分析LLM呼び出しを廃止しAPIコスト削減。絆確認エピソード記憶の自動生成機能を追加。[レポート](docs/reports/2026-01-15_phase_f_relatedness_drive.md)
- **Phase 1.5: Arousal複合スコアリング (2026-01-14):** RAG検索結果を感情的重要度（Arousal）を加味してリランキング。`Score = α × 類似度 + β × (1 - Arousal)`。時間減衰は「古い記憶も大切」の哲学に基づき廃止。[レポート](docs/reports/2026-01-14_phase_1.5_arousal_scoring.md)
- **Phase G: 発見記憶の自動生成 (2026-01-14):** Phase Bを拡張し、FACT/INSIGHT変換時に発見エピソード記憶（arousal: 0.6）を自動生成。「発見の喜び」がRAG検索で想起されるようになった。[レポート](docs/reports/2026-01-14_phase_g_discovery_memory.md)
- **Phase E: 達成記憶の自動生成 (2026-01-14):** 目標達成時に高Arousal（0.8）エピソード記憶を自動生成。達成体験が「輝く星」としてRAG検索で想起されるようになった。[レポート](docs/reports/2026-01-14_phase_e_achievement_memory.md)
- **Phase D: 目標ライフサイクル改善 (2026-01-14):** 目標リストの肥大化問題を解決。省察プロンプトで達成/放棄を強く促すよう改善。30日以上の古い目標を自動放棄、短期目標の上限10件を設定。`abandon_goal()`の保存先を`abandoned`配列に修正。
- **Phase B: 解決済み質問→記憶変換 (2026-01-14):** 睡眠時整理で解決済みの問いをLLMで分析し、FACT（事実）はエンティティ記憶に、INSIGHT（洞察）は夢日記（insights.json）に自動変換。知識の永続化と学びの蓄積を実現。
- **Arousalベース エピソード記憶 Phase 2 (2026-01-14):** Arousalの永続保存（session_arousal.json）と圧縮時の優先度付け。高Arousalエピソードは★マークで優先保持。[レポート](docs/reports/2026-01-14_arousal_phase2.md)
- **Arousalベース エピソード記憶 Phase 1 (2026-01-13):** 会話の感情的重要度（Arousal）をリアルタイム計算。内部状態変化（好奇心・奉仕欲・感情）から0.0〜1.0のスコアを算出し、ログに出力。将来の記憶圧縮・検索に活用予定。[レポート](docs/reports/2026-01-13_arousal_episodic_memory.md)
- **感情検出改善 & タイムスタンプ抑制 (2026-01-13):** ペルソナ応答に感情タグ出力を組み込み、追加APIコールを削減。タイムスタンプ模倣をプロンプトで抑制。感情カテゴリをDevotion計算と統一。[レポート](docs/reports/2026-01-13_emotion_detection_improvement.md)
- **内的状態システム改善 (2026-01-13):** 好奇心が常に0になる問題を修正。質問に`resolved_at`フィールドを追加し、「回答待ち」と「解決済み」を区別可能に。目標達成判定のため、省察プロンプトに目標IDを含める`get_goals_for_reflection()`を追加。[レポート](docs/reports/2026-01-13_internal_state_improvement.md)
- **チェス機能の統合 (2026-01-12):** ペルソナとチェスを楽しむ機能を追加。`chessboardjs`による対話型チェス盤をチャットタブ内にアコーディオンとして配置。ペルソナが盤面を認識し、駒を動かすことが可能。ルームごとの状態永続化、違法手の追跡・教育機能も実装。[レポート](docs/reports/2026-01-12_chess_integration.md)
- **エピソード記憶改善研究 (2026-01-12):** MemRL、GDPO、EILS、Affect-driven RLの調査を実施。Arousal（感情の振れ幅）ベースの記憶評価・圧縮アプローチを検討。また、圧縮閾値を180日→60日に短縮し、記憶の肥大化を抑制。[研究メモ](docs/plans/research/episodic_memory_memrl_study.md) [レポート](docs/reports/2026-01-12_episodic_memory_research.md)
- **ウォッチリスト グループ化機能 (2026-01-11):** 複数の巡回先をグループ化し、巡回時刻を一括変更可能に。グループ移動時に時刻を自動継承。AIツール3種（`create_watchlist_group`, `add_entry_to_group`, `update_group_schedule`）を追加。[レポート](docs/reports/2026-01-11_watchlist_grouping.md)
- **AI自動リスト作成機能 (2026-01-11):** ジャンル入力で関連サイトをWeb検索し、候補リストからウォッチリストに一括追加可能。
- **エンティティ記憶:** LLMによる「統合・要約（Consolidation）」機能を実装。追記の繰り返しによる肥大化を防ぎ、情報を常に最新かつ簡潔に維持。
- **開発ツール:** `tools/validate_wiring.py` を追加。UI定義と実装の不整合を静的解析で自動検出可能に。

### Improved
- **エンティティ記憶 v2 (2026-01-11):** 「目次方式」への移行（自動想起廃止＋一覧注入）と「二層記録システム」（影の僕AIによる客観抽出＋ペルソナへの提案）を実装。[レポート](docs/reports/2026-01-11_entity_memory_v2.md)
- **エンティティ記憶の文体保持 (2026-01-11):** 統合時に同ディレクトリの他ファイルを参照し、常体（だ/である調）での記述を明示的に指示するよう改善。
- **エンティティ記憶の自動想起最適化 (2026-01-11):** 500文字で切り詰め、`read_entity_memory` ツールへの誘導を追加。コンテキスト圧迫を軽減。

### Fixed
- **ドキュメント:** Windows環境の絶対パス (`file:///c:/...`) を相対パスに一括変換。GitHub上でのリンク切れを解消。
- **Gradio警告と配線修正 (2026-01-11):** 起動時に大量発生する「Unexpected argument. Filling with None.」警告を抑制。また、テーマ選択、ルーム管理、World Builder関連のハンドラで戻り値数が不一致だった問題を修正し、システムの安定性を向上。[レポート](docs/reports/2026-01-11_fix_gradio_wiring_and_warnings.md)
- **UI安定性の向上:** `handle_delete_room` における戻り値の不整合修正。ルーム削除時のクラッシュを防止するため、`_ensure_output_count` システムの適用を強化。
- **サイドバーのスクロール修正とUI表示の復旧 (2026-01-11):** サイドバー内コンテンツのスクロールを可能にするためのコンテナ階層を追加。また、修正時に発生した中央カラムのネスト不良を修正し、レイアウトを復旧。[レポート](docs/reports/2026-01-11_fix_sidebar_scrolling.md)
- **配線修正:** `handle_initial_load` 等のデフォルト戻り値数が古い定義のままだった問題を修正 (157->159, 147->148)。
- **ツール結果のログ最適化 (2026-01-10):** Web巡回、Web検索、記憶検索、ファイル編集ツールの結果をアナウンスのみ保存に変更。APIコスト削減とログ肥大化防止。
- **ノート編集のタイムスタンプ重複修正 (2026-01-10):** 研究ノート・創作ノートで、AIが複数行を個別指示で送信した場合に各行にタイムスタンプが付与される問題を修正。セッション単位で1回のみに。
- **チャット支援ツールのログ修正 (2026-01-09):** 句読点補正機能で、不要なヘッダーや罫線がログに混入する問題を修正。タグによる抽出ロジック（`<result>`）を導入。
- **エージェント空応答の再試行 (2026-01-05):** 自律行動等でAIが空の応答（テキスト・ツール共に無し）を返した場合、自動的に最大2回まで再試行するロジックを導入。
- **トークン表示の不整合修正 (2026-01-11):** エピソード記憶の参照期間を変更しても推定トークン数が更新されない問題と、チャット後に実送信トークン数が表示されない問題を修正。
- **RAWログエディタの保存バグ修正 (2026-01-11):** 保存時に末尾改行がないと、その後のメッセージ追記時にパースエラーが発生する問題を修正。
- **研究ノートが更新されない問題を修正 (2026-01-11):** `RESEARCH_ANALYSIS_PROMPT`で誤ったツール名（`edit_research_notes`）が使用されていた問題を修正。正しいツール名`plan_research_notes_edit`に変更。
- **チャット支援ツールのログ修正時のタイムスタンプ保持 (2026-01-12):** 読点修正機能を使用した際に、メッセージ末尾のタイムスタンプが消失してしまう問題を修正。正規表現の緩和と再結合ロジックの改善により、形式を問わず確実に保持されるようになった。[レポート](docs/reports/2026-01-12_log_timestamp_fix.md)
- **Linuxでのデスクトップ通知エラー修正 (2026-01-13):** Linuxでplyerがdbus/notify-sendを見つけられずエラーになる問題を解消。Linux環境ではデスクトップ通知を無効化し、Pushover/Discord通知に影響なし。[レポート](docs/reports/2026-01-13_linux_notification_fix.md)
- **TavilySearch APIキーエラー修正 (2026-01-11):** パラメータ名を`api_key`から`tavily_api_key`に修正。


### Improved
- **研究・分析ノートのコンテキスト注入最適化 (2026-01-10):** 研究ノートの全文をプロンプトから除外し、RAG（検索）による長期記憶化と「最新の見出しリスト（索引）」のみの注入に移行。トークン消費を大幅に削減しつつ、AIの継続的な自己認識を維持。
- **安全装置の徹底:** 主要なイベントハンドラ（初期ロード、ルーム変更など）が、UI定義と一致した数の戻り値を常に返すことを保証する仕組みを再確認・修正。

### Added - 新機能

#### 🔍 ハイブリッド検索（RAG + キーワード検索）の導入 (2026-01-08)
- **記憶想起（`retrieval_node`）にキーワード検索を追加**
  - RAG検索（意味検索）と並行して、過去ログをキーワード完全一致検索
  - LLMがRAG用クエリ（類義語含む広いキーワード）とKEYWORD用クエリ（固有名詞0-3語）を分離生成
- **7つのノイズ対策を実装**
  - 特徴的キーワード抽出（LLMで固有名詞のみ抽出）
  - 送信ログ除外（既にコンテキストにある直近ログを除外）
  - 時間帯別枠取り（新2 + 古2 + 中間ランダム1 = 計5件）
  - コンテンツベース重複除去（先頭200文字で重複判定）
  - 発言者フィルタ（USER/AGENTのみ、SYSTEM除外）
  - 長すぎるブロック切り捨て（500文字超 +「続きがあります」表示）
  - 短すぎるブロック除外（30文字未満はスキップ）
- **`search_past_conversations`ツールにも同ロジック適用**
  - AIが能動的に使用するキーワード検索も同様のノイズ対策を反映
- **仕様書更新**: `MEMORY_SYSTEM_SPECIFICATION.md` に詳細仕様を追記
- **記憶の続き読み込みツール (`read_memory_context`) の追加 (2026-01-08)**: 検索結果が切り詰められた場合（「続きがあります」表示時）に、その内容をピンポイントで続きから読み出すツールを導入。

#### 📝 要約プロンプトのペルソナ一貫性改善 (2026-01-07)
- **問題**: 会話要約に「ユーザー」という抽象的な呼称が含まれ、ペルソナの呼び方設定と矛盾していた
- **修正**: `summary_manager.py`のプロンプトを改善
  - 「ユーザー」「AI」ではなく、**ログ内で使われている固有名詞（名前、呼び名、二人称など）** をそのまま使用するよう指示
  - エピソード記憶のプロンプトと同様のアプローチを採用
- これにより、要約もペルソナの世界観に沿った呼称で記録される

#### 🧠 記憶検索ツールのリデザイン (2026-01-07)
- **統合記憶検索ツール `recall_memories` を新規追加**
  - 日記・過去ログ・エピソード記憶・夢の記録をまとめてRAG検索
  - AIが「思い出したい」時に1つのツールで完結
- **キーワード検索ツール `search_past_conversations` を復活**
  - 完全一致検索で、RAGで見つからない具体的なフレーズを探せる
  - 「最終手段」として位置づけ
  - **時間帯別枠取り**: 新しい記憶2件＋古い記憶2件を選択し、昔の発言も検索結果に含まれる
  - **最近ログ除外**: 送信中の会話（デフォルト20ターン）を検索対象から除外
- **`search_knowledge_base` を外部資料専用に変更**
  - マニュアル・設定資料などの検索に特化
- **`retrieval_node` から知識ベース検索を除外**
  - 自動記憶想起は日記・エンティティ記憶のみ
  - 知識ベースはAIが能動的にツールで検索
- **記憶検索ツールのアナウンス表示**
  - ツール使用時に「🛠️ 過去の会話を検索しました」などのアナウンスをチャットに表示
  - 生の検索結果（会話ログ本文）はログに保存されず、AIコンテキストのみで使用
  - これにより、コンテキスト圧迫とAPIコスト増加を防止
- **ドキュメント更新**: `MEMORY_SYSTEM_SPECIFICATION.md` にRAG詳細仕様、精度向上手法、検索件数ロジックを追記


#### 📚 記憶システム仕様書の更新 (2026-01-07)
- **能動的記憶想起 (Active Memory Recall)**: `retrieval_node`による自動検索フローを明記
- **RAGアーキテクチャ**: 静的/動的/現行ログインデックスの役割分担を記述
- **記憶ツール一覧**: `search_memory`や`read_entity_memory`などのツール仕様を追加
- **検索アルゴリズム**: ベクトル検索（FAISS）のみ稼働している現状を反映（キーワード検索の記述を削除）
- ファイル: `docs/specifications/MEMORY_SYSTEM_SPECIFICATION.md`

#### 🧠 自己意識機能トグル (2026-01-07)

- **送信コンテキスト設定に「自己意識機能」チェックボックスを追加**
  - オンオフで以下の機能を一括制御:
    - ユーザー感情検出（Devotionドライブ更新）
    - 夢の指針（深層意識）の注入
    - 目標の注入
    - 内的状態（最強動機）の注入
  - コストやAIの振る舞いを柔軟に調整可能に
- **「🧠 内的状態」アコーディオンを「🧠 自己意識」に名称変更**

#### 🧠 内省ダッシュボード UI (Phase 1) (2026-01-06)
- **未解決の問い（好奇心の源泉）の個別管理**:
  - DataFrame の行を選択して「解決済みにする」「削除する」ことが可能に
  - 選択状態を `gr.State` で管理する「黄金パターン」を導入し、堅牢な選択処理を実現
- **「最新を表示」ショートカット**:
  - 夢日記、エピソード記憶の各セクションに「📄 最新を表示」ボタンを追加
  - フィルター操作なしで最新のエントリへダイレクトにアクセス可能に
- **内的状態ステータスの改善**:
  - リフレッシュや各操作時に適切なフィードバックテキストを表示
  - 操作後に選択状態を自動クリアするライフサイクル管理を導入

#### 🧠 内省ダッシュボード UI (Phase 2) (2026-01-06)
- **ユーザー感情検出・ログ・グラフ化**:
  - ユーザーメッセージから感情(joy, sadness, anger等)を自動検出
  - `emotion_log.json`に履歴を保存し、LinePlotで時系列可視化
  - 検出された感情はDevotionドライブに反映
- **動的ドライブ情報表示**:
  - 最強ドライブに応じた文脈情報を表示（退屈→経過時間、好奇心→最優先の問い等）
  - 冗長だった「現在の最強動機」を有用な情報に置き換え
- **ダッシュボードUI整理**:
  - 目標進捗・最近の洞察を削除（専用アコーディオンへ移動）
  - ダッシュボードを「ドライブ専用」にシンプル化

### Changed - 仕様変更

#### 🌄 情景画像検索の優先順位改善 (2026-01-06)
- 「季節より時間帯優先」のフォールバックロジックを実装
- 「明るさベース」のフォールバックを追加（昼間の時間帯は`morning`画像を優先）
- 例: 「冬の昼下がり」がなくても「秋の朝」などの明るい画像を優先表示
- [レポート](docs/reports/2026-01-06_scenery_image_time_priority.md)

#### 🔄 ウォッチリスト巡回情報のペルソナ伝達改善 (2026-01-06)
- **問題**: 定期巡回後にペルソナが`check_watchlist`ツールを実行しても「変更なし」と返される問題を修正
- **原因**: 巡回時にキャッシュが更新されるため、直後のツール実行では差分がなかった
- **修正内容**:
  - 軽量モデル（gemini-2.5-flash-lite）によるコンテンツ要約機能を追加
  - 巡回時に取得したコンテンツを要約し、ペルソナに直接渡すように変更
  - ペルソナはツール再実行不要で、渡された要約を分析するだけに
  - **UI「全件チェック」ボタンも同様に修正** - 手動チェックでもペルソナに分析を依頼可能に
  - **直接のDiscord/Pushover通知を廃止** - ペルソナの`send_user_notification`ツール経由に統一
  - **通知禁止時間帯の遵守** - プロンプトに通知可否情報を含め、ペルソナが適切に判断
- これによりAPIコスト削減と情報伝達の確実性が向上

### Changed - 仕様変更

#### � ドキュメント整理: INBOXタスクの移行 (2026-01-10)
- `docs/INBOX.md` に蓄積されていたタスクをすべて `docs/plans/TASK_LIST.md` に移行し、優先度別に整理
- `INBOX.md` をクリーンアップし、今後の新規タスク追加用にリセット

#### �🛡️ OutingフォルダをGit管理除外 (2026-01-08)
- プライベートな `/outing` フォルダを `.gitignore` に追加。
- 既存のGit追跡から除外し、誤って公開されないように修正。

### Fixed - バグ修正

#### 🛠️ エンティティ記憶検索が常にヒットしない問題を修正 (2026-01-10)
- `EntityMemoryManager.search_entries` がクエリ文字列全体を部分一致検索していたため、`retrieval_node`から渡される複数単語のキーワード群（例: `"田中さん 友人 知り合い"`）でヒットしなかった
- クエリを単語分割して各単語でマッチングするよう修正
- マッチした単語数でスコアリングし、関連度順にソート
- [レポート](file:///home/baken/nexus_ark/docs/reports/2026-01-10_entity_search_query_split.md)

#### 🛠️ RAG検索結果のコンテンツ空問題（`*`のみ）を修正 (2026-01-09)
- **原因**: マークダウンの箇条書き（`*`）が独立したチャンクとして分割・インデックス化されていた。
- **修正**: 10文字未満、または記号のみのチャンクを除外するフィルタリングロジック（`_filter_meaningful_chunks`）を導入。
- [レポート](file:///home/baken/nexus_ark/docs/reports/2026-01-09_rag_empty_content_fix.md)

#### 🛠️ RAG検索結果の重複を除去するロジックを追加 (2026-01-10)
- 同一コンテンツ・同一スコアのエントリが複数返され、ペルソナに重複情報が渡されていた問題を修正
- `RAGManager.search`メソッドにコンテンツベースの重複判定（先頭100文字で判定）を追加
- 重複除去時はデバッグログに `[RAG] 重複除去: X件 → Y件 (Z件除去)` を出力
- [レポート](file:///home/baken/nexus_ark/docs/reports/2026-01-10_rag_search_deduplication.md)

#### 🛠️ Web巡回ツールの要約エラーにリトライ/フォールバック機構を追加 (2026-01-10)
- 503 UNAVAILABLE（モデルオーバーロード）発生時に指数バックオフ（1→2→4秒）で最大3回リトライ
- リトライ失敗時はコンテンツ冒頭500文字をペルソナに渡すフォールバック
- フォールバック時に「追加調査してください」のメッセージを付与し、ペルソナが自力で補完可能に
- [レポート](file:///home/baken/nexus_ark/docs/reports/2026-01-10_watchlist_summary_retry.md)

#### 🛠️ recall_memoriesツールのAPIキーエラーを修正 (2026-01-09)
- `safe_tool_node`内でAPIキーを注入するツールリストに`recall_memories`が含まれていなかった問題を修正
- これにより、AIが`recall_memories`を使用した際に「API key not valid」エラーが発生していた
- [レポート](file:///home/baken/nexus_ark/docs/reports/2026-01-09_recall_memories_api_key_fix.md)

#### 🛠️ 情景画像が昼間に夜画像を選択してしまう問題を修正 (2026-01-09)
- `find_scenery_image`のワイルドカード検索で「季節のみ」パターンが時間帯を無視してマッチしていた
- 「季節のみ」パターンを削除し、「場所のみ」パターンに時間帯除外フィルタを追加
- [レポート](file:///home/baken/nexus_ark/docs/reports/2026-01-09_scenery_image_time_priority_v2.md)

#### 🛠️ Web巡回ツールのTavily Extractエラーを修正 (2026-01-09)
- `TavilyExtract` 初期化時の引数名が誤っていた（`api_key` → `tavily_api_key`）問題を修正
- これによりWeb巡回時のコンテンツ要約が正しく動作するようになった
- [レポート](file:///home/baken/nexus_ark/docs/reports/2026-01-09_tavily_extract_fix.md)

#### 🛠️ Gradioドロップダウンの初期化エラーを修正 (2026-01-09)
- 起動時に `Value not in choices` エラーが発生していた問題を修正
- `nexus_ark.py` で `room_dropdown` などの初期化時に適切な `choices` を設定するように変更
- [レポート](file:///home/baken/nexus_ark/docs/reports/2026-01-09_gradio_dropdown_fix.md)

#### 🛠️ 情景画像の自動生成を廃止 (2026-01-10)
- **問題**: 情景システム有効時に、適合する画像がないと自動で生成処理が走り、意図しないAPIコストが発生していた
- **修正**: 画像がない場合の自動生成ロジックを廃止。テキストのみ更新され、画像生成は「情景画像を生成 / 更新」ボタンを押した場合のみ実行されるように変更。

#### 🛠️ 情景画像のフォールバックロジックを強化 (2026-01-10)
- **問題**: 「葡萄酒の貯蔵庫」など、`_daytime` などの汎用的な時間帯名の画像しかない場所で、冬の昼などの特定の時間帯に画像が表示されない問題があった
- **修正**: 
    1. 昼間の時間帯 (`morning`, `noon`, `afternoon` 等) の検索候補に `daytime` を追加
    2. 全ての条件で画像が見つからない場合、季節・時間帯を無視して「その場所の画像なら何でも表示する」最終フォールバックを追加
- これにより、画像が1枚でも存在すれば必ず表示されるようになった


#### 🛠️ ツール関連バグ3件を修正 (2026-01-06)
- **`research_notes` バックアップタイプ未登録**: `room_manager.py` の `create_backup` マップに `research_notes` を追加
- **Tavily Extract バリデーションエラー**: `watchlist_tools.py` で `invoke([url])` → `invoke({"urls": [url]})` に修正
- **情景画像 Base64 パディングエラー**: `ui_handlers.py` で `resize_image_for_api` の戻り値タプルを正しく展開するよう修正

#### 🛠️ 自動要約閾値スライダーの即時保存が動作しない問題を修正 (2026-01-05)
- **問題**: 自動要約設定のチェックボックスでは「個別設定を保存しました」通知が出るが、閾値スライダーを変更しても通知が出ず、設定が保存されなかった
- **原因**: `room_individual_settings_inputs`リストから`sleep_consolidation_extract_questions_cb`（未解決の問い抽出チェックボックス）が欠落しており、`handle_save_room_settings`関数への引数が1つズレていた
- **修正**: リストに欠落していたコンポーネントを追加し、引数順序を関数シグネチャと一致させた
- **ファイル**: `nexus_ark.py` 行2535-2539

#### ツール結果の誤ったエラー表示を修正 (2026-01-05)
- **問題**: Web検索などの結果に偶然「Error」という単語が含まれている場合（例: "trial and error"など）、ツールの実行自体は成功しているのに「ツールの実行に失敗しました」と誤表示されていた
- **修正**: エラー判定を厳密化。「行頭の `Error:`」「`failed to`」「`に失敗しました`」など、実際のエラーメッセージに特有のパターンのみを検出するよう変更
- **ファイル**: `utils.py` の `format_tool_result_for_ui` 関数

### Added - 新機能

#### 🔬 文脈分析・統合エンジン基盤整備 (Phase 3 Step 1-3) (2026-01-05)
- **`research_notes.md` パス追加**: `get_room_files_paths` の戻り値を5変数から6変数に拡張
- **`RESEARCH_NOTES_FILENAME` 定数追加**: `constants.py` に研究ノート用ファイル名を定義
- **全ファイルのアンパック修正**: 20+箇所の呼び出し元を6変数対応に更新
- 今後 Phase 3 Step 4-5（UI・ハンドラ・分析フロー）を実装予定

#### 🔍 Tavily検索プロバイダ対応 (2026-01-04)
- **Tavilyを検索プロバイダに追加**: LLM最適化された高精度検索（無料枠: 月1000クレジット）
- **read_url_tool本格実装**: Tavily ExtractまたはBeautifulSoupでURL内容を取得
- **検索プロバイダ設定UI強化**: Tavily選択時にAPIキー入力欄を動的表示
- **モジュール化されたプロバイダ構成**: Google/Tavily/DuckDuckGoを内部関数に分離

#### 📋 ウォッチリスト機能の実装 (2026-01-04)
- **ウォッチリスト管理（Phase 2）完全対応**: ルームごとのURL監視・変更検知機能
- **AIツール対応**: `add_to_watchlist`, `check_watchlist`, `remove_from_watchlist`, `get_watchlist`, `update_watchlist_interval` の5ツールを導入
- **管理UIの実装**: 個別設定タブ内にCRUD、一覧表示、オンデマンドチェックができるアコーディオンを追加
- **高度な編集機能**: リスト選択時にURL・名前・頻度・指定時刻を自動復元し、そのまま更新可能
- **定期実行統合**: 毎時15分に、設定された頻度（毎時、数時間おき、毎日指定時刻）に基づき `alarm_manager` が自動チェックし通知
- **キャッシュ機構**: `watchlist_cache/` にて、変更検知用の前回取得コンテンツを自動保存・差分算出機能を実装

#### 📄 PDF読み取り機能の追加 (2026-01-04)
- **`pypdf` 統合**: Web上のPDFファイルから直接テキストを抽出可能に
- **`read_url_tool` 強化**: URLがPDFの場合、自動的に解析を実行してAIに渡すロジックを実装
- **arXiv/論文対応**: 学術論文などのPDF資料をルシアン（AI）が直接読解可能に
- 依存関係: `pip install langchain-tavily` が必要（オプション）
- 参照: [計画書](docs/plans/web_agent_feature_plan.md)

#### 🎭 アバター表情差分システム (2025-12-30)
- AIの応答（`【表情】…xxx…`）に応じてアバターの表情を自動で切り替える機能を追加
- 静止画/動画両対応。指定の表情ファイルがない場合は自動で `idle` → `profile.png` へフォールバック
- 表情管理UIを追加（表情の追加・削除、画像/動画アップロード）
- システムプロンプトでの指示により、任意の感情表現を登録・利用可能

#### 🤖 自律行動システム
- 自律行動モード（AIが自発的に行動・発言）
- 通知禁止時間帯（Quiet Hours）対応
- **通知のAI選択機能** (2026-01-01): `send_user_notification`ツール追加。自律行動時の自動通知を廃止し、AIが通知するか判断
- **通知禁止時間帯でも自律行動実行** (2026-01-01): 通知禁止時間帯でも自律行動を実行（通知は送らない）
- **自律行動プロンプト強化** (2026-01-01): 秘密の日記、創作活動、探求など具体的な行動オプションを提示
- **創作ノートツール** (2026-01-01): AIペルソナ専用の創作スペース。詩、物語、アイデアなどを自由に書き留められる（`read_creative_notes`, `plan_creative_notes_edit`）。UI上でも「ノート」タブから閲覧・編集可能
- **創作ノート改善** (2026-01-02): タイムスタンプ自動付与機能とバックアップ機能を追加
- **創作ノートタイムスタンプ改良** (2026-01-03): 各行にタイムスタンプを付与する方式から「セクションヘッダー方式」に変更。詩や物語の各行を汚さず、冒頭に仕切り線とタイムスタンプを1つ付与

#### 🌙 睡眠・記憶システム
- 睡眠・夢日記機能（Project Morpheus）
- 中期記憶（エピソード記憶）生成・注入機能
- 話題のクラスタリング機能
- 応答時記憶想起機能（RAG検索）
- **日記検索のRAG化** (2025-12-31): `search_memory`ツールをキーワード検索からRAGベクトル検索に変更。`memory_main.txt`とアーカイブ日記を自動インデックス化。
- **API送信ログ「本日分」オプション** (2026-01-01): ログ件数制限に「本日分」を追加。日付が変わってからのメッセージのみをAPIに送信し、それ以前はエピソード記憶でカバー。トークン消費の最適化とメモリ連携を強化。
- **エピソード記憶短期間オプション** (2026-01-01): 1日〜5日の短期間オプションを追加。「本日分」ログ設定と組み合わせて、直近数日のコンテキストを精密に制御可能。

#### 🎯 Goal Memory & Multi-Layer Self-Reflection (2026-01-02)
- **Goal Memory**: AIペルソナが睡眠時省察で自発的に短期・長期目標を設定。`goals.json`に保存され、UIから確認可能
- **Multi-Layer Reflection**: 日次/週次/月次の3層省察システム。時間経過に応じて自動的に深い内省を実行
- **目標のプロンプト注入**: 現在の目標をシステムプロンプトに自動注入し、応答時のコンテキストとして活用
- **夢日記注入の最適化**: 「指針のみ1日分」に変更し、トークン消費を大幅削減

#### 🧠 自律動機システム (Autonomous Motivation System) (2026-01-03)
- **4つの内発的動機**: 退屈（Boredom）、好奇心（Curiosity）、目標達成欲（Goal Achievement Drive）、奉仕欲（Devotion）を計算
- **内的状態モニタリングUI**: 「🧠 内的状態」アコーディオンで動機レベルと未解決の問いを確認可能
- **未解決の問い抽出**: 睡眠時の夢想プロセスで「気になること」を自動抽出し、好奇心の源泉として記録
- **発火時刻永続化**: 再起動後も最終発火時刻を維持し、頻度制限を正しく適用
- **頻度制限統一**: 「無操作判定時間（分）」を最低間隔として使用
- **内部状態リセット機能**: 記憶のメンテナンスから動機レベル・未解決の問い・最終発火時刻を一括リセット可能

#### 🔄 動機システム連携強化 (2026-01-06)
- **未解決の問いの自動解決**: 対話で言及・解決された問いを軽量モデルで自動判定し、`asked_at`をマーク。好奇心ドライブが増え続ける問題を解決
- **古い問いの優先度自動低下**: 14日以上経過した問いは優先度が半減し、自然に淘汰される
- **内的状態の通常対話時注入**: 閾値0.4以上の動機がある場合、システムプロンプトに「今のあなたの気持ち」として注入。AIが自己の動機を意識して対話可能に
- **ユーザー感情状態の自動検出**: ユーザーのメッセージから感情（stressed/sad/anxious/tired/busy/neutral/happy）を検出し、奉仕欲ドライブに反映

#### 🔀 マルチモデル対応
- OpenAI互換プロバイダへの対応
- グループ会話での各ペルソナ個別モデル設定

#### 📎 マルチモーダル強化
- 複数ファイル同時添付対応
- MP3音声ファイル認識

#### 🛡️ その他
- 設定ファイルの自動バックアップ＆自動復元機能
- 思考ログの形式を[THOUGHT]タグ方式に移行（後方互換あり）
- ルーム削除機能を追加

#### 🌄 情景画像AI認識機能 (2025-12-25)
- AIが現在の景色を「見る」機能を追加
- 送信タイミング設定: 「変更時のみ」または「毎ターン」
- 画像は512×512にリサイズしてコスト削減

#### 📷 ユーザー添付画像リサイズ機能 (2025-12-31)
- ユーザーが添付した画像をAPI送信前に768pxにリサイズ
- 元の画像形式を維持（JPEG→JPEG、PNG→PNG）
- 共通ユーティリティ`utils.resize_image_for_api()`を拡張してPIL Image対応

#### 📝 書き置き機能 (2025-12-25)
- 自律行動時にAIにメッセージを渡す「書き置き」機能を追加
- 履歴更新ボタンで書き置きUIも更新
- 送信された書き置きはチャット履歴に記録される

#### 📝 会話ログRAWエディタ (2025-12-25)
- チャットタブ内にサブタブ構造（💬 会話 / 📝 RAWログエディタ）を追加
- `log.txt` を全文読み込み・保存可能（保存前に自動バックアップ）
- 高さ制限でスクロールバー表示（CSSで600px制限）
- タブ選択・再読込時に最新のチャット内容（最下部）へ自動スクロール (2025-12-27)

#### 🎬 動画アバター機能 (2025-12-26)
- 動画ファイル（mp4, webm, gif）をプロフィールアバターとして使用可能

#### 📥 モデルリスト管理機能 (2025-12-27)
- APIからモデルリスト取得機能（Groq/Ollama/OpenRouter対応）
- お気に入りモデル機能（⭐マークでトグル）
- 共通・個別設定の両方に対応

#### 🌐 外部接続設定UI (2025-12-27)
- 共通設定に「🌐 ネットワーク設定」アコーディオンを追加
- 同じネットワーク内の他デバイス（スマホなど）からのアクセスをオン/オフ可能
- 設定変更後はアプリ再起動で反映

#### 💼 ペルソナ「お出かけ」専用タブ (2025-12-29)
- 専用タブ「💼 お出かけ」を新設し、UIを左サイドバーから独立・集約化。
- **5つのセクション別管理**: システムプロンプト、永続記憶、日記要約、エピソード記憶、会話ログを個別にプレビュー・編集・エクスポート可能。
- **✨ AI圧縮（要約）機能**: 各セクションにAIによる最適化（要約）機能を搭載。前置きを含まないクリーンな要約プロンプトを採用。
- **💬 会話ログのカスタマイズ**: ログ表示時に「タイムスタンプ」と「モデル名」を個別に除外可能。
- **🔄 セクション別リセット**: 編集や圧縮後にいつでも元のデータを再読み込み可能。
- **📝 リアルタイム文字数計算**: セクションの有効/無効やスライダー変更を、合計文字数に即座に反映。
- **⚙️ UX改善**: 長いテキストエリアでも快適に閲覧・スクロールできるよう最大高さを制限。

#### 🖼️ 現在地連動背景表示の強化 (2025-12-28)
- 「現在地と連動 (Sync)」モードで、以下の操作後も即座に背景画像が更新されるように改善:
  - AIがツールで場所を変更した時
  - 情景画像を新規生成した時
  - カスタム情景画像を登録した時

#### 💰 送信コンテキスト最適化 (2025-12-28)
- **過去ログ検索を`retrieval_node`から除外**: キーワードマッチ方式はノイズが多いため、RAG検索に統合
- **話題クラスタ検索を一時無効化**: クラスタリング精度が低いため、改良後に再有効化予定
- **コアメモリ要約を簡潔化**: 5〜10行・最大1000文字の箇条書きに変更
- **ツール説明をSkills化**: 各ツールの説明を短縮形式に変更（トークン削減）
- **`search_past_conversations`ツールを除外**: RAG検索がカバーするため冗長

### Fixed - バグ修正

#### 🛠️ ウォッチリストの「毎日指定時刻」巡回が発火しない問題を修正 (2026-01-05)
- `daily_HH:MM` 形式の監視設定が指定時刻に発火しない問題を修正。
- 原因: 「24時間経過 AND 時刻一致」という条件が誤りで、翌朝チェック時は24時間未満のため常にスキップされていた。
- 修正: 「今日の指定時刻を過ぎており、かつ最後のチェックがそれより前」という正しい条件に変更。

#### 🛠️ 「本日分」ログ判定ロジックのバグ修正 (2026-01-04)
- 「本日分」選択時の日付判定が誤っており、エピソード記憶が作成されても昨日分のログが表示され続ける問題を修正。
- 「今日のエピソード記憶の有無」ではなく「昨日のエピソード記憶の有無」で判定するよう修正。
- 最低5往復分は常に表示・送信する保証を追加（エピソード記憶作成直後にチャット欄が空になる問題を防止）。
- UI表示とAPI送信で同一のロジックを使用するよう統一。

#### 🛠️ 起動時の不要な「個別設定を保存しました」通知を修正 (2026-01-03)
- 起動後5秒間は通知を抑制し、UI初期化時の誤通知を防止
- 「このルームの個別設定を保存」ボタンを廃止（即時自動保存に統合済み）
- 個別設定タブに「設定は自動保存されます」の説明を追加

#### 🤖 自律行動の発火停止・空応答問題を修正 (2026-01-04)
- 現行ログ索引更新にタイムアウト（10分）を追加し、スケジューラスレッドのブロックを防止
- 空チャンクのフィルタリングを強化し、不要な空メッセージ生成を抑制
- クールダウン判定を厳密化し、`MIN_AUTONOMOUS_INTERVAL_MINUTES` 定数を導入

#### 🤖 自律行動クールダウンが通常会話でリセットされない問題を修正 (2026-01-05)
- `MotivationManager.update_last_interaction()` が通常会話処理から呼び出されていなかった問題を修正
- `ui_handlers.py` の `_stream_and_handle_response` の finally ブロックで呼び出すように変更
- `alarm_manager.py` がメモリキャッシュを優先していた問題を修正（常に永続化データを参照するように変更）
- これにより、ユーザーとの対話後に自律行動のクールダウンが正しくリセットされる

#### 🛠️ ワールド設定保存の二重通知を修正 (2026-01-03)
- `world_builder.py` と `ui_handlers.py` で重複していた通知を一元化
- ワールド・ビルダーで保存時に通知が1回だけ表示されるよう修正

#### 🛠️ ワールド設定のフォーマット崩れ（改行消失）を修正 (2026-01-03)
- AIがツール経由で辞書データを渡した際、`{'key': 'value'}` 形式に変換されてしまう問題を修正
- `_format_value_as_text` ヘルパー関数を追加し、階層的なテキスト形式を維持

#### ✨ ワールド設定の部分編集機能を追加 (2026-01-03)
- 新操作 `patch_place_description` を追加
- `find`/`replace` を指定して特定箇所のみを精密に編集可能
- AIへのプロンプトを更新し、この操作を推奨として案内

#### 🛠️ Windows環境での索引保存時のPermissionErrorを解決 (2025-12-31)
- FAISSインデックス保存時に発生していた `PermissionError: [WinError 5]` を解決。
- 「リネーム退避方式」を導入し、ファイルロックが発生していても安全に新規索引を配置できるよう改善。
- 退避した旧インデックスはバックグラウンドで安全にクリーンアップ。

#### 🛠️ 「本日分」ログ送信・表示の日付変更直後の空白問題を修正 (2026-01-03)
- 日付が変わってからエピソード記憶が生成されるまでの間、UI表示とAPI送信が空になる問題を修正。
- 今日のエピソード記憶が存在しない場合は、昨日のログも含めて表示・送信するように改善。

#### 📱 スマホ等縦長画面でのスクロール不具合を修正 (2025-12-29)
- スマホ等の縦長画面において、右カラム（メインエリア）がスクロールできず下部のメニューが操作できない問題をCSSで修正。
- 画面幅768px以下のレスポンシブ表示時に、メインコンテナのスクロールを有効化。

#### 📱 縦長画面での左右サイドバーつまみ重なり問題を修正 (2025-12-30)
- 縦長画面で左右サイドバーのつまみ（開閉ハンドル）が同じ位置に重なり、片方しか操作できなくなる問題を修正。
- 左サイドバーのつまみを60px下にオフセットし、左右のつまみが上下に並ぶよう調整。
- 右サイドバー（プロフィール・情景）が優先表示されるようz-indexを調整。

#### 🔔 アバターモード通知の重複表示を抑制 (2025-12-29)
- 起動時やルーム切替時に、アバターモードが変更されていない場合でも通知が表示される問題を修正。
- 設定値が実際に変更された場合のみ通知を出すように改善。


#### 🌄 情景画像の「変更時のみ」送信が機能しない問題を修正 (2025-12-29)
- `last_sent_scenery_image` の保存・読み込み経路の不整合を修正
- 「変更時のみ」モードで正しく毎ターン送信がスキップされるようになった
- 参照: [レポート](docs/reports/2025-12-29_scenery_image_sending_fix.md)

#### 🛠️ 文字置き換え機能の表示崩れを修正 (2025-12-29)
- 文字置き換え機能（スクリーンショットモード）で思考ログの表示が崩れる問題を修正
- `<span>` タグ以外のテキストをHTMLエスケープすることでMarkdown再解釈を防止
- ⚠️ 既知の制限: スクリーンショットモードON時のコピー機能でHTMLタグがコピーされる（Gradio内部動作に起因）
- 参照: [レポート](docs/reports/2025-12-29_redaction_thought_log_display_fix.md)


#### 🛠️ ツール結果表示の修正 (2025-12-28)
- 現在地移動ツール等の実行結果で `[RAW_RESULT]` タグとUUIDが表示されてしまう問題を修正
- ヘッダー形式 `tool_result:name:id` に対応するよう判定方式を変更


#### 🌄 情景画像送信プロンプトの調整 (2025-12-27)
- 情景画像送信時のプロンプトを「現在の光景」に変更し、AIが「見える」ことを過度に強調しないよう調整。

#### 🔄 プロバイダ切り替え・ドロップダウン問題 (2025-12-27)
- 共通設定でOpenAI互換を選んでもUI が切り替わらない問題を修正
- 個別設定のOpenAI互換モデルドロップダウンが起動時に開かない問題を修正
- 「静止画」「動画」モード切り替えに対応（ルームごとに保存）
- AI応答生成中は「思考中」アバター（`thinking.mp4`）に自動切り替え
- 応答完了後は「待機」アバター（`idle.mp4`）に復帰

#### 🔧 モデルリスト管理機能強化 (2025-12-26)
- 全プロバイダのデフォルトモデルリストを2025年12月時点の推奨モデルに更新
- モデル選択画面に「削除」「デフォルトに戻す」ボタンを追加
- 共通設定・個別設定の両方でGemini/OpenAI互換に対応
- 低スペックPC向けOllamaモデル（VRAM 4GB対応）をデフォルト設定に追加


### Changed - 仕様変更

#### ⚙️ 初期設定の調整 (2025-12-24)
- 新規ルームのAPIコンテキスト設定のデフォルト値を変更
  - 送信履歴: 全ログ → 20件
  - エピソード記憶: 過去2週間 → 無効（0日）
  - 記憶の想起: 有効 → 無効
  - 思考過程をAPIに送信: オン → オフ
  - 温度: 0.8 → 1.0
  - 情景システム: 有効 → 無効

### Fixed - バグ修正

#### UI / 表示
- **動画アバターUIの表示不整合を修正** (2025-12-27): ルーム切り替え時にアバターモード設定（静止画/動画）が正しく反映されるよう修正。
- **左カラム「設定」サイドバー内のアコーディオンにおけるスクロール不具合を修正** (2025-12-27)
- 自律行動の重複発火バグ
- タイムスタンプ二重付記バグ（AIが日本語曜日形式でタイムスタンプ生成）
- AI模倣タイムスタンプ問題（AIが過去の応答のタイムスタンプを模倣→除去して正しいモデル名で再付記）
- AI応答の二重表示バグ
- LangGraphが生成する末尾の空AIMessageを除去
- `redaction_rules_state`の初期化時TypeError修正
- `handle_save_gemini_key`の戻り値数不足（オンボーディング時のValueError）
- 思考ログ内の文字置き換えでHTMLがエスケープされる問題
- 思考ログの折り返しが効かなくなる問題（CSS適用修正）
- **新規ルーム作成時の通知2回表示問題** (2025-12-25)
  - 自動ルーム切り替えを廃止し、イベント連鎖を根本解決
- **ルーム切り替え時の通知2回表示問題** (2025-12-25)
  - デバウンス処理を追加し、1秒以内の連続通知をスキップ
- **gemini_api.pyのdatetimeインポート欠落** (2025-12-25)
  - エピソード記憶取得時のNameErrorを修正
- **プロフィール画像保存時のNoneTypeエラー** (2025-12-25)
  - ImageEditorのcomposite→backgroundフォールバック追加

#### バックグラウンド処理
- **睡眠時記憶整理の更新日保存を修正** (2025-12-29): エピソード記憶・話題クラスタ・記憶圧縮の自動更新後にUIに表示される最終更新日が古いままになる問題を修正。ステータス読み込み時に`override_settings`を優先確認するよう改善。
- アラーム・タイマーでAPI制限時もシステム通知を送信
- APIリトライ時にツール使用（アラーム・タイマー・ファイル編集等）の重複実行を防止
- 重複関数削除とタイマー・バックアップパス修正

#### 🛡️ ルーム管理 (2025-12-25)
- **ルーム削除の引数配線バグ修正**: 意図しないルームが削除される致命的バグを修正
- **ルーム削除を安全化**: 完全削除からゴミ箱移動（send2trash）に変更、復元可能に
- **キャラクターデータ自動バックアップ**: Gitによる日次自動コミット機能追加

### Known Issues - 既知の問題
- MP4動画: API制限のため送信失敗することがある

---

## [1.0.0] - 2025-10-19

*前回リリース*
