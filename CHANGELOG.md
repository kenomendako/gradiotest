# Changelog

All notable changes to Nexus Ark will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/).

## [Unreleased] - 次回リリース予定

### Added - 新機能

#### 🤖 自律行動システム
- 自律行動モード（AIが自発的に行動・発言）
- 通知禁止時間帯（Quiet Hours）対応

#### 🌙 睡眠・記憶システム
- 睡眠・夢日記機能（Project Morpheus）
- 中期記憶（エピソード記憶）生成・注入機能
- 話題のクラスタリング機能
- 応答時記憶想起機能（RAG検索）

#### 🔀 マルチモデル対応
- OpenAI互換プロバイダへの対応
- グループ会話での各ペルソナ個別モデル設定

#### 📎 マルチモーダル強化
- 複数ファイル同時添付対応
- MP3音声ファイル認識

#### 🛡️ その他
- 設定ファイルの自動バックアップ＆自動復元機能
- 思考ログの形式を[THOUGHT]タグ方式に移行（後方互換あり）
- ルーム削除機能を追加

#### 🌄 情景画像AI認識機能 (2025-12-25)
- AIが現在の景色を「見る」機能を追加
- 送信タイミング設定: 「変更時のみ」または「毎ターン」
- 画像は512×512にリサイズしてコスト削減

#### 📝 書き置き機能 (2025-12-25)
- 自律行動時にAIにメッセージを渡す「書き置き」機能を追加
- 履歴更新ボタンで書き置きUIも更新
- 送信された書き置きはチャット履歴に記録される

#### 📝 会話ログRAWエディタ (2025-12-25)
- チャットタブ内にサブタブ構造（💬 会話 / 📝 RAWログエディタ）を追加
- `log.txt` を全文読み込み・保存可能（保存前に自動バックアップ）
- 高さ制限でスクロールバー表示（CSSで600px制限）
- タブ選択・再読込時に最新のチャット内容（最下部）へ自動スクロール (2025-12-27)

#### 🎬 動画アバター機能 (2025-12-26)
- 動画ファイル（mp4, webm, gif）をプロフィールアバターとして使用可能

#### 📥 モデルリスト管理機能 (2025-12-27)
- APIからモデルリスト取得機能（Groq/Ollama/OpenRouter対応）
- お気に入りモデル機能（⭐マークでトグル）
- 共通・個別設定の両方に対応

#### 🌐 外部接続設定UI (2025-12-27)
- 共通設定に「🌐 ネットワーク設定」アコーディオンを追加
- 同じネットワーク内の他デバイス（スマホなど）からのアクセスをオン/オフ可能
- 設定変更後はアプリ再起動で反映

#### 🖼️ 現在地連動背景表示の強化 (2025-12-28)
- 「現在地と連動 (Sync)」モードで、以下の操作後も即座に背景画像が更新されるように改善:
  - AIがツールで場所を変更した時
  - 情景画像を新規生成した時
  - カスタム情景画像を登録した時

### Fixed - バグ修正

#### 🛠️ ツール結果表示の修正 (2025-12-28)
- 現在地移動ツール等の実行結果で `[RAW_RESULT]` タグとUUIDが表示されてしまう問題を修正
- ヘッダー形式 `tool_result:name:id` に対応するよう判定方式を変更


#### 🌄 情景画像送信プロンプトの調整 (2025-12-27)
- 情景画像送信時のプロンプトを「現在の光景」に変更し、AIが「見える」ことを過度に強調しないよう調整。

#### 🔄 プロバイダ切り替え・ドロップダウン問題 (2025-12-27)
- 共通設定でOpenAI互換を選んでもUI が切り替わらない問題を修正
- 個別設定のOpenAI互換モデルドロップダウンが起動時に開かない問題を修正
- 「静止画」「動画」モード切り替えに対応（ルームごとに保存）
- AI応答生成中は「思考中」アバター（`thinking.mp4`）に自動切り替え
- 応答完了後は「待機」アバター（`idle.mp4`）に復帰

#### 🔧 モデルリスト管理機能強化 (2025-12-26)
- 全プロバイダのデフォルトモデルリストを2025年12月時点の推奨モデルに更新
- モデル選択画面に「削除」「デフォルトに戻す」ボタンを追加
- 共通設定・個別設定の両方でGemini/OpenAI互換に対応
- 低スペックPC向けOllamaモデル（VRAM 4GB対応）をデフォルト設定に追加


### Changed - 仕様変更

#### ⚙️ 初期設定の調整 (2025-12-24)
- 新規ルームのAPIコンテキスト設定のデフォルト値を変更
  - 送信履歴: 全ログ → 20件
  - エピソード記憶: 過去2週間 → 無効（0日）
  - 記憶の想起: 有効 → 無効
  - 思考過程をAPIに送信: オン → オフ
  - 温度: 0.8 → 1.0
  - 情景システム: 有効 → 無効

### Fixed - バグ修正

#### UI / 表示
- **動画アバターUIの表示不整合を修正** (2025-12-27): ルーム切り替え時にアバターモード設定（静止画/動画）が正しく反映されるよう修正。
- **左カラム「設定」サイドバー内のアコーディオンにおけるスクロール不具合を修正** (2025-12-27)
- 自律行動の重複発火バグ
- タイムスタンプ二重付記バグ（AIが日本語曜日形式でタイムスタンプ生成）
- AI模倣タイムスタンプ問題（AIが過去の応答のタイムスタンプを模倣→除去して正しいモデル名で再付記）
- AI応答の二重表示バグ
- LangGraphが生成する末尾の空AIMessageを除去
- `redaction_rules_state`の初期化時TypeError修正
- `handle_save_gemini_key`の戻り値数不足（オンボーディング時のValueError）
- 思考ログ内の文字置き換えでHTMLがエスケープされる問題
- 思考ログの折り返しが効かなくなる問題（CSS適用修正）
- **新規ルーム作成時の通知2回表示問題** (2025-12-25)
  - 自動ルーム切り替えを廃止し、イベント連鎖を根本解決
- **ルーム切り替え時の通知2回表示問題** (2025-12-25)
  - デバウンス処理を追加し、1秒以内の連続通知をスキップ
- **gemini_api.pyのdatetimeインポート欠落** (2025-12-25)
  - エピソード記憶取得時のNameErrorを修正
- **プロフィール画像保存時のNoneTypeエラー** (2025-12-25)
  - ImageEditorのcomposite→backgroundフォールバック追加

#### バックグラウンド処理
- **睡眠時記憶整理の更新日保存を修正** (2025-12-27): エピソード記憶・話題クラスタの自動更新後にUIに表示される最終更新日が古いままになる問題を修正
- アラーム・タイマーでAPI制限時もシステム通知を送信
- APIリトライ時にツール使用（アラーム・タイマー・ファイル編集等）の重複実行を防止
- 重複関数削除とタイマー・バックアップパス修正

#### 🛡️ ルーム管理 (2025-12-25)
- **ルーム削除の引数配線バグ修正**: 意図しないルームが削除される致命的バグを修正
- **ルーム削除を安全化**: 完全削除からゴミ箱移動（send2trash）に変更、復元可能に
- **キャラクターデータ自動バックアップ**: Gitによる日次自動コミット機能追加

### Known Issues - 既知の問題
- MP4動画: API制限のため送信失敗することがある

---

## [1.0.0] - 2025-10-19

*前回リリース*
